\chapter{Running Galacticus}

\section{Configuration File}\label{sec:ConfigFile}\index{galacticusConfig.xml@{\normalfont \ttfamily galacticusConfig.xml}}\index{configuration}

The file {\normalfont \ttfamily galacticusConfig.xml}, is present, is used to configure \glc\ and provide useful information. It should have the following structure:
\begin{verbatim}
<config>
  <contact>
    <name>My Name</name>
    <email>me@ivory.towers.edu</email>
  </contact>
  <email>
    <host>
      <name>myComputerHostName</name>
      <method>smtp</method>
      <host>smtp-server.ivory.towers.edu</host>
      <user>myUserName</user>
      <passwordFrom>kdewallet</passwordFrom>
    </host>
    <host>
      <name>default</name>
      <method>sendmail</method>
    </host>
  </email>
</config>
\end{verbatim}
The name and e-mail address in the {\normalfont \ttfamily contact} section will be stored in any \glc\ models run---this helps track the provenance of the model. The {\normalfont \ttfamily email} section determines how e-mail will be sent. Within this section, you can place one or more {\normalfont \ttfamily host} elements, the {\normalfont \ttfamily name} element of which specifies the host name of the computer to which these rules apply (the {\normalfont \ttfamily default} host is used if no other match is found). For each host, the {\normalfont \ttfamily method} element specifies how e-mail should be sent, either by {\normalfont \ttfamily sendmail} or via {\normalfont \ttfamily smtp}. For SMTP transport (which currently supports SSL connections only), you must specify the {\normalfont \ttfamily host} SMTP server, {\normalfont \ttfamily user} name. The {\normalfont \ttfamily passwordFrom} element specifies how the password for the SMTP log in should be obtained. If set to {\normalfont \ttfamily input} then the user will be prompted for the password as needed. Alternatively, if you use the \href{http://www.kde.org/}{KDE} desktop and the \href{http://utils.kde.org/projects/kwalletmanager/}{KDEWallet} password manager, 
setting {\normalfont \ttfamily passwordFrom} to {\normalfont \ttfamily kdewallet} will cause the password to be stored in the KDE wallet and retrieved from there subsequently.

\section{Parameter Files}\label{sec:ParameterFiles}

\glc\ requires a file of parameters to be given as a command line argument. The parameter file is an XML file (which makes it easy to manipulate and construct these files from within many languages, e.g. Perl) with the following structure:
\begin{verbatim}
 <parameters>
   <version>0.9.4</version>
   <formatVersion>2</formatVersion>
   <parameter1Name value= "parameter1Value" />
   <parameter2Name>
     <value>parameter2Value</value>
   </parameter2Name>
   <parameter3Name value= "parameter3Value" >
      <subParameter1Name value= "subParameter1Value" />
      <subParameter2Name value= "subParameter2Value" />
      .
      .
      .
   </parameter3Name>
   .
   .
   .
 </parameters>
\end{verbatim}
Each named element must have a {\normalfont \ttfamily value} attribute (preferred), or else contains a value element, which contains desired value respectively. The value can be a number, word(s) or an array of space-separated numbers or words. Parameters are used to control the values of numerical parameters and also to select methods and other options. If a parameter is not specified in the file a default value (hard coded into \glc) will be used instead. The default values have been chosen to produce a realistic model of galaxy formation, but may change as \glc\ evolves. Parameters may have sub-parameters embedded within them, as in the example above.

Sub-parameters are used in object composition within \glc. For example, the following would specify that linear growth of cosmological large scale structure should be modeled using the {\normalfont \ttfamily simple} method:
\begin{verbatim}
  <linearGrowthMethod value="simple">
    <cosmologyParametersMethod value="simple">
      <HubbleConstant   value="70.0" />
      <OmegaMatter      value="0.31"  />
      <OmegaDarkEnergy  value="0.69"  />
      <OmegaBaryon      value="0.045"/>
      <temperatureCMB   value="2.725"/>
    </cosmologyParametersMethod>
    <cosmologyFunctionsMethod value="matterLambda"/>
  </linearGrowthMethod>
\end{verbatim}
The linear growth function object requires knowledge about the cosmological parameters and model. In the above, we specify this explicitly by including a definition of the cosmological parameter object and cosmological functions object that our linear growth function object should use. Note that the cosmological functions object also requires knowledge of the cosmological parameters. When the {\normalfont \ttfamily cosmologyFunctionsMethod} object is built from the above definition it will first check for a cosmological parameters object defined in its own subparameters. Since it does not find one in this instance it will check for a cosmological parameters definition in its parent object (the {\normalfont \ttfamily linearGrowthMethod} element) and, in this case, will use that definition. If no definition were to be found in any parent element, a default set of cosmological parameters would be used instead\footnote{This approach allows a direct connection to be made between the structure of the input parameter XML file and the internal object hierarchy used by \glc, allowing very fine-grained control over the composition of \glc\ functionality. In particular it permits easy construction of objects which work by modifying results from other objects, such as the {\normalfont \ttfamily schneider2015} model for dark matter halo concentrations (\S\ref{phys:darkMatterProfileConcentration:darkMatterProfileConcentrationSchneider2015}).}.

The optional {\normalfont \ttfamily version} element specifies which version of \glc\ this parameter file is intended for. The optional {\normalfont \ttfamily formatVersion} element specifies the parameter file version number (the current standard for parameter files is version 2). While optional, these elements can be useful when migrating parameter files between versions of \glc\ (see \S\ref{sec:MigrateParameters}).

All parameter values (both those specified in this file and those set to default) used during a \glc\ run are output to the {\normalfont \ttfamily Parameters} group within the \glc\ output file. The script {\normalfont \ttfamily scripts/aux/Extract\_Parameter\_File.pl} will, if given a \glc\ output file, extract the parameters from it and output them into an XML file suitable for re-input into \glc. If parameters are present in the parameter file which do not match any known parameter in \glc\ then a warning message, listing all unknown parameters, will be given when \glc\ is run. Note that this will \emph{not} prevent \glc\ from running---sometimes it is convenient to include parameters which are not used by \glc, but which might be used by some other code.

\subsection{Validating Parameter Files}\index{parameters!validating}

A script, {\normalfont \ttfamily scripts/aux/validateParameters.pl}, is provided to validate parameter files and thereby ensure that they are consistent with \glc's expectations and requirements. To use simply execute:
\begin{verbatim}
 scripts/aux/validateParameters.pl myParameters.xml
\end{verbatim}
No output (and an exit value of 0) indicates a valid parameter file. Invalid parameter files will result in an exit value other than 0 and will produce error messages that should help to track down the problem with the file.

\subsection{Generating Parameter Files}\index{parameters!generating}

Some scripts are provided which assist in the generation of parameter files. These are located in the {\normalfont \ttfamily scripts/parameters/} folder and are detailed below:
\begin{description}
\item [{\normalfont \ttfamily cosmologicalParametersMonteCarlo.pl}] This script will generate a set of cosmological parameters drawn at random from the WMAP-9 constraints \cite{hinshaw_nine-year_2012}. It uses the covariance matrix (currently defined in {\normalfont \ttfamily data/Cosmological\_Parameters\_WMAP-9.xml}) to produce correlated random variables\footnote{Note that this does not capture the full details of the correlations between parameters, since it uses just the covariance matrix. For a more accurate calculation the full Monte Carlo Markov Chains used in the WMAP-9 parameter fitting should be used instead.}. The generated parameters are printed to standard output as \glc-compatible XML.
\end{description}

\section{Running Galacticus}

\glc\ is running using
\begin{verbatim}
 Galacticus.exe [<parameterFile>]
\end{verbatim}
where {\normalfont \ttfamily parameterFile} is the name of the file containing a list of parameter values for \glc. \glc\ will display messages indicating its progress as it runs (the verbosity can be controlled with the {\normalfont \ttfamily verbosityLevel} parameter). Usually, the \glc\ executable should be invoked from the directory in which it was built. However, you can choose to set the environment variable {\normalfont \ttfamily GALACTICUS\_ROOT\_V091} to the full path to the build directory\index{path!galacticus root@{\glc\ root}}, in which case the \glc\ executable can be invoked from anywhere and will access all required files and scripts relative to this path. This can allow multiple users to all make use of the same \glc\ install.

\subsection{Writing Data To a Temporary File}\index{output!temporary}

When running \glc\ on a compute cluster it is often advantageous to have output written to a local scratch disk during run time and only moved to networked storage after the run is complete. (Otherwise, \glc\ will perform many small writes to networked storage which can result in extremely slow run times.) To do this, simply set the parameter {\normalfont \ttfamily [galacticusOutputScratchFileName]} to the full path of a file to write to on local scratch space. During the run, data will be written to this file. After the run is finished, \glc\ will move this file to its permanent location as specified by the parameter {\normalfont \ttfamily [galacticusOutputFileName]}.

\subsection{Restarting A Crashed Run}\label{sec:Restarting}

If \glc\ crashes, it can be useful to restart the calculation from just prior to the crash to speed the debugging process. \glc\ has functionality to store and retrieve the internal state of any modules and to recover this to permit such restarting. Currently, this is implemented with the {\normalfont \ttfamily build} and {\normalfont \ttfamily read} methods of merger tree construction, such that the internal state is stored prior to commencing the building or reading of each tree, thereby allowing a calculation to be restarted with the tree that crashed. More general store/retrieve behavior is planned for future releases.

To cause \glc\ to periodically store its internal state include the following input parameter:
\begin{verbatim}
  <stateFileRoot value="galacticusState" />
\end{verbatim}
This will cause the internal state to be stored to files {\normalfont \ttfamily galacticusState.state} and {\normalfont \ttfamily galacticusState.fgsl.state} prior to commencing building each merger tree. Should a tree crash then replace this input parameter with:
\begin{verbatim}
  <stateRetrieveFileRoot           value="galacticusState" />
  <mergerTreeBuildTreesBeginAtTree value="N"               />
\end{verbatim}
where {\normalfont \ttfamily N} is the number of the tree that crashed. This will cause calculations to begin with tree {\normalfont \ttfamily N} and for the internal state to be recovered from the above mentioned files. The resulting tree and all galaxy formation calculations should therefore proceed just as in the original run (and so create the same crash condition).

\subsubsection{OpenMP}\index{debugging!OpenMP}\index{OpenMP!debugging}

When running a model in parallel using OpenMP, a separate state file will be written for each thread, with the thread number appended to the end of each state file name. For debugging purposes, it is suggested that a crashed OpenMP run be restarted using just a single thread. To do this, change the appended thread number on the state files corresponding to the thread which crashed to 0 such that they will be used by the single thread when the run is restarted.

\subsection{Running Grids of Models}\label{sec:RunningGrids}

You can easily write your own scripts to generate parameter files and run \glc\ on these files. An example of such a script is {\normalfont \ttfamily scripts/aux/launch.pl}. This script will loop over a sequence of parameter values, generate appropriate parameter files, run \glc\ using those parameters and analyze the results. This script currently supports running of \glc\ on a local machine, via a PBS queue (as multiple jobs or a single job), or on a \href{http://www.cs.wisc.edu/condor/}{{\normalfont \scshape Condor}}\index{Condor} cluster. To run the script simply enter:
\begin{verbatim}
 ./scripts/aux/launch.pl <runFile>
\end{verbatim}
This will launch a single instance of the script. Multiple instances can be launched and will share the work load (i.e. they will not attempt to run a model which another instance is already running or has finished). If multiple instances are to be launched on multiple machines a command line option to {\normalfont \ttfamily launch.pl} can be used to ensure that they do not duplicate work. Adding {\normalfont \ttfamily --instance 2:4} for example will tell the script to run only the second model from each block of four models it finds. Launching for {\normalfont \ttfamily launch.pl} scripts on four different machines with {\normalfont \ttfamily --instance 1:4}, {\normalfont \ttfamily --instance 2:4}, {\normalfont \ttfamily --instance 3:4} and {\normalfont \ttfamily --instance 4:4} will then divide the models between those machines.

The {\normalfont \ttfamily runFile} is an XML file with the following structure:
\begin{verbatim}
<parameterGrid>
 <modelRootDirectory>models.new</modelRootDirectory>
 <baseParameters>newBestParametersQuick.xml</baseParameters>
 <compressModels>no</compressModels>
 <splitModels>4</splitModels>

 <launchMethod>pbs</launchMethod>

  <local>
   <threadCount>3</threadCount>
   <ompThreads>4</ompThreads>
  </local>

 <condor>
  <galacticusDirectory>/home/condor/Galacticus/v0.9.3</galacticusDirectory>
  <universe>vanilla</universe>
  <environment>LD_LIBRARY_PATH=/usr/lib:/usr/lib64:/usr/local/lib</environment>
  <requirement>Memory &gt;= 1000 &amp;&amp; Memory &lt; 2000</requirement>
  <transferFile>{PWD}/myFile.data</transferFile>
  <wholeMachine>true</wholeMachine>
  <postSubmitSleepDuration>5</postSubmitSleepDuration>
  <jobWaitSleepDuration>10</jobWaitSleepDuration>
 </condor>

 <pbs>
  <scratchPath>/scratch/me</scratchPath>
  <wallTime>48:00:00</wallTime>
  <memory>3gb</memory>
  <ompThreads>8</ompThreads>
  <queue>standard</queue>
  <maxJobsInQueue>10</maxJobsInQueue>
  <mpiLaunch>yes</mpiLaunch>
  <mpiRun>/opt/openmpi/bin/mpirun</mpiRun>
  <environment>LD_LIBRARY_PATH=/home/me/software/Galacticus/Tools/lib64:$LD_LIBRARY_PATH</environment>
  <postSubmitSleepDuration>10</postSubmitSleepDuration>
  <jobWaitSleepDuration>60</jobWaitSleepDuration>
 </pbs>

 <monolithicPBS>
  <mpiLaunch>yes</mpiLaunch>
  <nodes>1</nodes>
  <threadsPerNode>12</threadsPerNode>
  <ompThreads>6</ompThreads>
  <jobWaitSleepDuration>60</jobWaitSleepDuration>
  <analyze>no</analyze>
  <environment>LD_LIBRARY_PATH=/home/me/software/Galacticus/Tools/lib64:$LD_LIBRARY_PATH</environment>
  <includePath>/my/include/path</includePath>
  <libraryPath>/opt/sgi/mpt/mpt-2.04/lib</libraryPath>
  <shell>csh</shell>
  <pbsCommand>source /usr/share/modules/init/csh</pbsCommand>
  <pbsCommand>module load mpi-sgi/2.04_64</pbsCommand>
 </monolithicPBS>
                  
 <parameters>
  <label>modelLabel</label>
  <stabilityThresholdStellar</stabilityThresholdStellar>
   <value>1.1</value>
   <value>0.9</value>
  </stabilityThresholdStellar>
 </parameters>
 <parameters>
  <stabilityThresholdGaseous>
   <value>1.1</value>
   <value>0.9</value>
  </stabilityThresholdGaseous>
  <imfSalpeterYieldInstantaneous>
   <value>0.02</value>
   <value>0.04</value>
  </imfSalpeterYieldInstantaneous>
  <imfSelectionFixed>
   <value>Salpeter</value>
   <value>Chabrier</value>
  </imfSelectionFixed>
  <starFormationTimescaleDisksMethod>
   <value>Kennicutt-Schmidt
    <starFormationKennicuttSchmidtTruncate>
     <value>true</value>
     <value>false
     <imfSelectionFixed>
      <modify>
        <find>^(.*)</find>
        <replace>\1Truncated</replace>
      </modify>
     </imfSelectionFixed>
    </starFormationKennicuttSchmidtTruncate>
   </value>
   <value>dynamicalTime</value>
  </starFormationTimescaleDisksMethod>
 </parameters>
</parameterGrid>
\end{verbatim}
Each {\normalfont \ttfamily parameters} block contains a list of parameters following the format used in standard \glc\ parameter files, with the difference that each parameter can have multiple {\normalfont \ttfamily values}. A model will be run for all possible combinations of these values. Additionally, any {\normalfont \ttfamily value} element may contain further parameter elements. All possible values of these parameters will be looped over when, and only when, the appropriate value of the containing parameter is being used. For example, in the above example, models will be run with {\normalfont \ttfamily [starFormationKennicuttSchmidtTruncate]}$=${\normalfont \ttfamily true} and {\normalfont \ttfamily false} only when {\normalfont \ttfamily [starFormationTimescaleDisksMethod]}$=${\normalfont \ttfamily Kennicutt-Schmidt} and not when {\normalfont \ttfamily [starFormationTimescaleDisksMethod]}$=${\normalfont \ttfamily dynamicalTime}.

It is also possible to set the value of a parameter by modifying the current value using a Perl regular expression. This is done by given a {\normalfont \ttfamily modify} element instead of a {\normalfont \ttfamily value} element in the parameter definition. The {\normalfont \ttfamily modify} element must contain {\normalfont \ttfamily find} and {\normalfont \ttfamily replace} elements, the first of which must be a valid Perl regular expression, and the second of which must specify the replacement text. In the above example, the {\normalfont \ttfamily parameters} block specifies that models are two be run for {\normalfont \ttfamily [imfSelectionFixed]}$=${\normalfont \ttfamily Salpeter} and {\normalfont \ttfamily Chabrier}. However, for the case of {\normalfont \ttfamily [starFormationKennicuttSchmidtTruncate]}$=${\normalfont \ttfamily false} these parameters will be modified by suffixing them with ``{\normalfont \ttfamily Truncated}''.

Some variables, which are expanded at run time, are available. These include:
\begin{description}
\item [{\normalfont \ttfamily \%\%galacticusOutputPath\%\%}] This will be expanded to the output path of a model. Useful for specifying paths for any additional output.
\end{description}

By default, each model is output into a sequentially numbered directory within the {\normalfont \ttfamily ./models} directory. By default, these directories have the prefix {\normalfont \ttfamily galacticus}. This can be changed by including a {\normalfont \ttfamily label} element inside a {\normalfont \ttfamily parameters} block, in which case the content of the {\normalfont \ttfamily label} element will be used as the prefix. This root directory can be modfified by the optional {\normalfont \ttfamily modelRootDirectory} element. Additionally, a set of base parameters can be read from a file specified by the {\normalfont \ttfamily baseParameters} file---these will be read before each model is run and before any variations in parameters for the specific model are applied. As such, it defines the default model around which parameter variations occur. Additional options that may be present in the file (as elements within the {\normalfont \ttfamily parameterGrid} element) are:
\begin{description}
\item[{\normalfont \ttfamily doAnalysis}]If set to ``no'' then no analysis scripts will be run on completed models, otherwise, they will be. Optionally, the analysis script to run can be specified via the {\normalfont \ttfamily analysisScript} element (see \S\ref{sec:AnalysisScripts});
\item[{\normalfont \ttfamily emailReport}] If set to ``yes'' a report will be e-mailed to the address specified in {\normalfont \ttfamily galacticusOptions.xml} when a model fails. Otherwise, the report will be written to standard output instead.
\item[{\normalfont \ttfamily compressModels}] If ``no'' then models are not compressed after being run. Otherwise, the contents of the model output directory will be compressed using {\normalfont \ttfamily bzip2}.
\item[{\normalfont \ttfamily splitModels}] If set to an integer larger than $1$, each \glc\ model will be split into that number of jobs, and those jobs will be launched (using the selected method) independently. Once finished, the outputs from these split models will be merged back into a single model. This allows, for example, effectively distributing a single \glc\ model over multiple nodes of a PBS cluster.
\end{description}

The method by which to launch jobs must be specified in the {\normalfont \ttfamily launchMethod} element. Currently available options are:
\begin{description}
\item[{\normalfont \ttfamily local}] The models will be run on the local machine. Two additional options can be specified within a {\normalfont \ttfamily local} XML block:
\begin{description}
\item[{\normalfont \ttfamily threadCount}] The number of individual model threads to be launched.
\item[{\normalfont \ttfamily ompThreads}] The number of OpenMP threads to be used by each model.
\end{description}

\item[{\normalfont \ttfamily pbs}] Jobs will be submitted to a {\normalfont \ttfamily PBS} batch queue system. The following options are available and can be specified within a {\normalfont \ttfamily pbs} XML block:
\begin{description}
\item[{\normalfont \ttfamily scratchPath}] An optional path to which the model output will be written at run time. At the completion of each run, the data will be transferred to the usual output location. This is useful to avoid network I/O during run time;
\item[{\normalfont \ttfamily wallTime}] A limit on the wall time allowed for each model (optional);
\item[{\normalfont \ttfamily memory}] A limit on the memory allowed for each model (optional);
\item[{\normalfont \ttfamily ompThreads}] The number of OpenMP threads to use for each model (optional). This is used to request an appropriate number of processors per node;
\item[{\normalfont \ttfamily queue}] The name of the queue to submit the jobs to (optional);
\item[{\normalfont \ttfamily maxJobsInQueue}] The maximum number of jobs to place in the queue. Additional jobs will be held and submitted once the number of jobs in the queue drops below this value (optional);
\item[{\normalfont \ttfamily mpiLaunch}] If set to ``{\normalfont \ttfamily yes}'' then the {\normalfont \ttfamily mpirun} command will be used to launch a single copy of \glc\ (which may then spawn multiple OpenMP threads). If instead set to ``{\normalfont \ttfamily no}'' then \glc\ is launch without the use of the {\normalfont \ttfamily mpirun} command. Some systems will limit a code launched with {\normalfont \ttfamily mpirun} to using just a single CPU (even if multiple OpenMP threads are spawned). In such cases, setting this option to ``{\normalfont \ttfamily no}'' should permit multiple CPUs to be utilized.
\item[{\normalfont \ttfamily mpiRun}] The path to the {\normalfont \ttfamily mpirun} executable (optional---if not present, {\normalfont \ttfamily mpirun} must be in {\normalfont \ttfamily PATH});
\item[{\normalfont \ttfamily environment}] Any settings here are set in each {\normalfont \scshape PBS} job in order to set appropriate environment variables on the machine where a job is executed;
\item[{\normalfont \ttfamily analyze}] If set to ``{\normalfont \ttfamily yes}'' then analysis (if any) will be performed as part of the PBS job. Otherwise, analysis is performed by the submitting machine.
\item[{\normalfont \ttfamily postSubmitSleepDuration}] The time (in seconds) to wait after submitting each job. This prevents flooding the PBS queue manager with a large number of jobs in rapid succession.
\item[{\normalfont \ttfamily jobWaitSleepDuration}] The time (in seconds) to sleep between successive checks of the PBS queue to see if any of the submitted jobs have finished.
\end{description}

\item[{\normalfont \ttfamily monolithicPBS}] A single job will be submitted to a {\normalfont \ttfamily PBS} batch queue system. This job will internally run multiple copies of \glc\ each with a different set of parameters. The following options are available and can be specified within a {\normalfont \ttfamily monolithicPBS} XML block:
\begin{description}
\item[{\normalfont \ttfamily nodes}] The total number of nodes to use for the PBS job.
\item[{\normalfont \ttfamily threadsPerNode}] The number of threads per node to use for the PBS job.
\item[{\normalfont \ttfamily ompThreads}] The number of OpenMP threads to use for each model (optional). This is used to request an appropriate number of processors per node, and must be an factor of {\normalfont \ttfamily threadsPerNode};
\item[{\normalfont \ttfamily scratchPath}] An optional path to which the model output will be written at run time. At the completion of each run, the data will be transferred to the usual output location. This is useful to avoid network I/O during run time;
\item[{\normalfont \ttfamily wallTime}] A limit on the wall time allowed for each model (optional);
\item[{\normalfont \ttfamily memory}] A limit on the memory allowed for each model (optional);
\item[{\normalfont \ttfamily queue}] The name of the queue to submit the jobs to (optional);
\item[{\normalfont \ttfamily mpiRun}] The path to the {\normalfont \ttfamily mpirun} executable (optional---if not present, {\normalfont \ttfamily mpirun} must be in {\normalfont \ttfamily PATH});
\item[{\normalfont \ttfamily environment}] Any settings here are set in each {\normalfont \scshape PBS} job in order to set appropriate environment variables on the machine where a job is executed;
\item[{\normalfont \ttfamily analyze}] If set to ``{\normalfont \ttfamily yes}'' then analysis (if any) will be performed as part of the PBS job. Otherwise, analysis is performed by the submitting machine.
\item[{\normalfont \ttfamily postSubmitSleepDuration}] The time (in seconds) to wait after submitting each job. This prevents flooding the PBS queue manager with a large number of jobs in rapid succession.
\item[{\normalfont \ttfamily jobWaitSleepDuration}] The time (in seconds) to sleep between successive checks of the PBS queue to see if any of the submitted jobs have finished.
\end{description}

\item[{\normalfont \ttfamily condor}] Jobs will be submitted to a {\normalfont \ttfamily Condor} cluster. The following options are available and can be specified within a {\normalfont \ttfamily condor} XML block:
\begin{description}
\item[{\normalfont \ttfamily galacticusDirectory}] When a \glc\ job is submitted to a {\normalfont \scshape Condor} cluster the \glc\ executable and the input parameter file are transferred to the machine where the job runs. Other files, such as data files, are not transferred. Therefore, they must be already present on any remote machine on which the job can run. This option specifies where a complete \glc\ installation can be found on the remote machine. If not present, it defaults to {\normalfont \ttfamily /home/condor/Galacticus/v0.9.0};
\item[{\normalfont \ttfamily universe}] Specifies to which {\normalfont \scshape Condor} universe jobs should be submitted. Allowed options are ``vanilla'' and ``standard''. If the standard universe is to be used then \glc\ must have been linked with {\normalfont \ttfamily condor\_compile}---the {\normalfont \ttfamily Makefile} allows this if the relevant lines are uncommented;
\item[{\normalfont \ttfamily environment}] Any settings here are passed to {\normalfont \scshape Condor}'s {\normalfont \ttfamily environment} option in order to set appropriate environment variables on the machine where a job is executed;
\item[{\normalfont \ttfamily requirement}] Any setting here is passed to {\normalfont \scshape Condor}'s {\normalfont \ttfamily requirements} option to specify requirements for each job. Multiple {\normalfont \ttfamily requirement} entries will be combined (using logical and).
\item[{\normalfont \ttfamily transferFile}] Any files listed here will be transferred the Condor worker (and so will be accessible from the path in which \glc\ is running). The macro {\normalfont \ttfamily \{PWD\}} will be automatically expanded to the present working directory. Multiple {\normalfont \ttfamily transferFile} entries can be given.
\item [{\normalfont \ttfamily wholeFile}] Setting this option to {\normalfont \ttfamily true} will add {\normalfont \ttfamily +RequiresWholeMachine = True} to the Condor submit file. If Condor has been configured to allow jobs to take over a whole machine\footnote{As described \protect\href{https://www-auth.cs.wisc.edu/lists/condor-users/2009-January/msg00086.shtml}{here} for example.}, this will cause jobs to do so. This is useful if you want to run OpenMP \glc\ on a Condor cluster.
\item[{\normalfont \ttfamily postSubmitSleepDuration}] The time (in seconds) to wait after submitting each job. This prevents flooding the Condor queue manager with a large number of jobs in rapid succession.
\item[{\normalfont \ttfamily jobWaitSleepDuration}] The time (in seconds) to sleep between successive checks of the Condor queue to see if any of the submitted jobs have finished.
\end{description}

\end{description}

In addition to the {\normalfont \ttfamily galacticus.hdf5} output file, each model directory will contain a file {\normalfont \ttfamily newParameters.xml} which contains the parameters used to run the model and {\normalfont \ttfamily galacticus.log} which contains any output from \glc\ during the run.

If present, the file {\normalfont \ttfamily galacticusConfig.xml}, described in \S\ref{sec:ConfigFile}, is parsed for configuration options. If the {\normalfont \ttfamily contact} element is present, the listed name and e-mail address will be used to determine who should receive error reports should a model crash. The error report will contain the host name of the computer running the model, the location of the model output and the log file (which may be incomplete if output is being buffered). Additionally, any core file produced will be stored in the model directory for later perusal, and the state files (see \S\ref{sec:Restarting}) for the run can also be found in the model directory.

\subsection{Analysis of Models}\label{sec:AnalysisScripts}

The {\normalfont \ttfamily Run\_Galacticus.pl} script will automatically run {\normalfont \ttfamily scripts/analysis/Galacticus\_Compute\_Fit.pl} on each model to generate plots and fitting data unless {\normalfont \ttfamily doAnalysis}$=${\normalfont \ttfamily no} is set in the {\normalfont \ttfamily runFile} (see \S\ref{sec:RunningGrids}). This script, which can also be running manually using
\begin{verbatim}
 ./scripts/analysis/Galacticus_Compute_Fit.pl <galacticusFile> <outputDirectory> [<analysisFile>]
\end{verbatim}
where {\normalfont \ttfamily galacticusFile} is the name of the \glc\ output file to analyze and {\normalfont \ttfamily outputDirectory} is the directory into which plots and fitting data should be placed, reads the file {\normalfont \ttfamily \textless analysisFile\textgreater} (or {\normalfont \ttfamily data/Galacticus\_Compute\_Fit\_Analyses.xml} if {\normalfont \ttfamily \textless analysisFile\textgreater} is not specified) which has the following structure:
\begin{verbatim}
 <analyses>
  <analysis>
    <script>scripts/plotting/Plot_HI_Mass_Function.pl</script>
    <weight>1.0</weight>
  </analysis>
  <analysis>
    <script>scripts/plotting/Plot_K_Luminosity_Function.pl</script>
    <weight>1.0</weight>
  </analysis>
  .
  .
  .
 </analyses>
\end{verbatim}
Each {\normalfont \ttfamily analysis} element contains the name of a script to run to perform some analysis and a weight to be given to the results of this analysis when combining results to get a net goodness of fit. Each script listed will be run and is expected to have accept arguments of the form:
\begin{verbatim}
 My_Analysis_Script.pl <galacticusFile> <outputDirectory> <showFit>
\end{verbatim}
where the {\normalfont \ttfamily showFit} argument can be 0 or 1 and, if set to 1, the script should output an XML chunk to standard output giving details of its fitting analysis. This chunk should have the form:
\begin{verbatim}
 <galacticusFit>
   <name>Description of this analysis</name>
   <chiSquared>24.5</chiSquared>
   <degreesOfFreedom>19</degreesOfFreedom>
   <fileName>Output_File_Name.pdf</fileName>
 </galacticusFit>
\end{verbatim}
where {\normalfont \ttfamily chiSquared} and {\normalfont \ttfamily degreesOfFreedom} are the fitting results. All such data returned from fitting scripts will be collated by {\normalfont \ttfamily Galacticus\_Compute\_Fit.pl}, augmented with the weight value and the net goodness of fit determined. All of this information is then output to {\normalfont \ttfamily galacticusFits.xml} in the selected output directory.

\subsubsection{Performing Other Analysis}

If {\normalfont \ttfamily \textless doAnalysis \textgreater}$=${\normalfont \ttfamily yes} and {\normalfont \ttfamily \textless analysisFile\textgreater} is set to something other than an XML file it is assumed that this is an analysis script that should be run directly. The script will be executed with the output directory for the \glc\ model as the first and only argument.

\subsection{Running Models in ``Embarrassingly Parallel'' Mode}

While \glc\ is parallelized via OpenMP it is also possible to split a given model across several ``worker'' CPUs on one or more computers. The trees to be processed will be shared between these workers and the results can be later recombined. To use this ``poor man's'' parallelization, add the following to a model parameter file:
\begin{verbatim}
  <treeEvolveWorkerCount  value="N" />
  <treeEvolveWorkerNumber value="i" />
\end{verbatim}
where {\normalfont \ttfamily N} is the total number of workers to be used and {\normalfont \ttfamily i} is the number of this worker (ranging from 1 to {\normalfont \ttfamily N}). You can generate these individual input parameter files from a single base parameter file using:
\begin{verbatim}
scripts/aux/Split_Models_For_Workers.pl <parameterFile> <workerCount>
\end{verbatim}
where {\normalfont \ttfamily <parameterFile>} is the name of the base parameter file and {\normalfont \ttfamily <workerCount>} is the number of workers required. The script will create an input file for each worker (input files will have the same name as the base parameter file but with a ``{\normalfont \ttfamily \_N}'', where {\normalfont \ttfamily N} is the worker number, inserted before the ``{\normalfont \ttfamily .xml}''). Output file name for each worker will be the same as specified in the base parameter file, but with a ``{\normalfont \ttfamily \_N}'', where {\normalfont \ttfamily N} is the worker number, inserted before the ``{\normalfont \ttfamily .hdf5}''.

Once all workers have finished, their outputs can (if required) be combined into a single output file using the {\normalfont \ttfamily Merge\_Models.pl} script as follows:
\begin{verbatim}
./scripts/aux/Merge_Models.pl <model1> <model2> .... <modelOutput>
\end{verbatim}
where {\normalfont \ttfamily model1} etc. are the names of the various output files and {\normalfont \ttfamily modelOutput} is the file into which the combined results should be placed. The {\normalfont \ttfamily Merge\_Models.pl} script will combine all merger trees into the output file and will additionally cumulate any data in the {\normalfont \ttfamily globalHistory} groups in these files. The UUIDs of the merged files (see \S\ref{sec:UUID}) will be concatenated (with a ``:'' separator) and placed into the {\normalfont \ttfamily UUIDs} attribute of the new file. Additionally, a new UUID will be generated and stored in the {\normalfont \ttfamily UUID} attribute of the new file.

\subsection{Limiting the Load Average}\index{load average}

If {\normalfont \ttfamily [treeEvolveLimitLoadAverage]}$=${\normalfont \ttfamily true} then \glc\ will attempt to keep the load average of the system under {\normalfont \ttfamily [treeEvolveLoadAverageMaximum]} by waiting to run trees if the current load average exceeds this value. {\normalfont \ttfamily [treeEvolveLoadAverageMaximum]} can be set to the numerical maximum load average desired or, alternatively, can be set to {\normalfont \ttfamily processorCount} in which case the number of processor cores present on the system will be used for {\normalfont \ttfamily [treeEvolveLoadAverageMaximum]}.

\subsubsection{Thread Locking via Semaphores}\label{sec:Semaphores}\index{semaphores}

An alternative is to use Linux's semaphoring system to share processors between multiple instances of \glc\ running on a single machine. To activiate this mode, set {\normalfont \ttfamily [treeEvolveThreadLock]} to the total number of threads that should be active at any one time across all instances of \glc\ running on a machine. You can also set this parameter to {\normalfont \ttfamily processorCount} to set a a value equal to the total number of processors on the machine. With this parameter set, each instance of \glc\ running on a machine will request a semaphore for each thread that it attempts to run, with the maximum number of semaphores set to the value of {\normalfont \ttfamily [treeEvolveThreadLock]}. This means that, if one instance of \glc\ has claimed 6 semaphores when {\normalfont \ttfamily [treeEvolveThreadLock]}$=${\normalfont \ttfamily 8}, then a second instance of \glc\ will only run 2 threads. Once the first instance releases its semaphores, the second instance will claim them and begin running more threads.

\section{Additional Codes}

The \glc\ code base can be used for other calculations. Some examples of such usage (and which are sufficiently useful in their own right) are included and are detailed in this section.

\subsection{{\normalfont \ttfamily Excursion\_Sets}}\index{excursion sets}

The {\normalfont \ttfamily Excursion\_Sets} code will generate an HDF5 output file which contains a variety of measures related to excursion sets in the Press-Schechter formalism. The code is built and run as follows:
\begin{verbatim}
make Excursion_Sets.exe
Excursion_Sets.exe <parameterFile> <outputFile>
\end{verbatim}
where {\normalfont \ttfamily parameterFile} is a file of parameters in \glc's usual XML format and {\normalfont \ttfamily outputFile} is the name of the file to which the excursion set data will be written. The output file has the following structure:
\begin{verbatim}
+-> barrier                  [dataset]
|
+-> firstCrossingProbability [dataset]
|
+-> firstCrossingRate        [dataset]
|
+-> haloMass                 [dataset]
|
+-> haloMassFunction         [dataset]
|
+-> powerSpectrum            [dataset]
|
+-> variance                 [dataset]
|
+-> wavenumber               [dataset]
\end{verbatim}
These datasets contain the following information:
\begin{description}
 \item [{\normalfont \ttfamily haloMass}] Halo mass [${\mathrm M}_\odot$];
 \item [{\normalfont \ttfamily wavenumber}] Wavenumber corresponding to this halo mass [Mpc$^{-1}$];
 \item [{\normalfont \ttfamily powerSpectrum}] Power spectrum at this wavenumber [Mpc$^3$];
 \item [{\normalfont \ttfamily variance}] The variance, $S(M)\equiv\sigma^2(M)$, at this halo mass;
 \item [{\normalfont \ttfamily barrier}] The excursion set barrier, $B(S)$;
 \item [{\normalfont \ttfamily firstCrossingProbability}] The probability of first crossing this barrier between $S$ and $S+{\mathrm d}S$;
 \item [{\normalfont \ttfamily firstCrossingRate}] The rate of first crossing of the barrier per unit time [Gyr$^{-1}$] for all pairs of halo mass;
 \item [{\normalfont \ttfamily haloMassFunction}] The halo mass function [${\mathrm M}^{-1}_\odot$~Mpc$^{-3}$].
\end{description}

\subsection{{\normalfont \ttfamily Halo\_Mass\_Functions}}

The {\normalfont \ttfamily Halo\_Mass\_Functions} code will generate an HDF5 output file which contains a variety of measures of the dark matter halo mass function tabulated as a function of mass and at a variety of redshifts. The code is built and run as follows:
\begin{verbatim}
make Halo_Mass_Functions.exe
Halo_Mass_Functions.exe <parameterFile> <outputFile>
\end{verbatim}
where {\normalfont \ttfamily parameterFile} is a file of parameters in \glc's usual XML format and {\normalfont \ttfamily outputFile} is the name of the file to which the halo mass function data will be written. The parameter file can specify any parameters needed for computing the mass function (they will be set to default values in cases where a paramter is not included). The redshifts at which to output halo mass functions are given by the {\normalfont \ttfamily [outputRedshifts]} parameter. In addition to the usual \glc\ parameters three additional parameters control behavior:
\begin{description}
\item [{\normalfont \ttfamily [haloMassFunctionsMassMinimum]}] The lowest mass halo (in units of $M_\odot$) at which to tabulate;
\item [{\normalfont \ttfamily [haloMassFunctionsMassMaximum]}] The highest mass halo (in units of $M_\odot$) at which to tabulate;
\item [{\normalfont \ttfamily [haloMassFunctionsPointsPerDecade]}] The number of points per decade of halo mass at which to tabulate.
\end{description}
The output file has the following structure:
\begin{verbatim}
+-> Outputs
|   |
|   +-> outputCharacteristicMass      [dataset]
|   |
|   +-> outputCriticalOverdensities   [dataset]
|   |
|   +-> outputExpansionFactor         [dataset]
|   |
|   +-> outputGrowthFactors           [dataset]
|   |
|   +-> outputRedshift                [dataset]
|   |
|   +-> outputTime                    [dataset]
|   |
|   +-> outputVirialDensityContrast   [dataset]
|    
+-> Parameters
|   |
|   +-> parameter1                    [attribute]
|   |
|   +-> parameterN                    [attribute]
|    
+-> haloMassFunctions
    |
    +-> haloBias                      [dataset]
    |
    +-> haloMass                      [dataset]
    |
    +-> haloMassFractionCumulative    [dataset]
    |
    +-> haloMassFunctionCumulative    [dataset]
    |
    +-> haloMassFunctionLnM           [dataset]
    |
    +-> haloMassFunctionM             [dataset]
    |
    +-> haloNu                        [dataset]
    |
    +-> haloSigma                     [dataset]
    |
    +-> haloVirialRadius              [dataset]
    |
    +-> haloVirialTemperature         [dataset]
    |
    +-> haloVirialVelocity            [dataset]
\end{verbatim}
The {\normalfont \ttfamily Parameters} group contains attributes giving the values of all used parameters (just as in a \glc\ output file). The {\normalfont \ttfamily Outputs} group contains datasets which give global properties at each requested output time as follows:
\begin{description}
\item [{\normalfont \ttfamily outputCharacteristicMass}] The characteristic mass scale (in units of $M_\odot$), $M_*$, at which $\sigma(M)=\delta_{\mathrm c}(z)$;
\item [{\normalfont \ttfamily outputCriticalOverdensities}] The critical overdensity for collapse of halos, $\delta_{\mathrm c}$;
\item [{\normalfont \ttfamily outputExpansionFactor}] The expansion factor;
\item [{\normalfont \ttfamily outputGrowthFactors}] The linear growth factor;
\item [{\normalfont \ttfamily outputRedshift}] The redshift;
\item [{\normalfont \ttfamily outputTime}] The cosmic time (in units of Gyr);
\item [{\normalfont \ttfamily outputVirialDensityContrast}] The virial density contrast of halos.
\end{description}
The {\normalfont \ttfamily haloMassFunctions} group contains datasets which list the properties of halos as a function of mass at each requested output time as follows:
\begin{description}
\item [{\normalfont \ttfamily haloBias}] The large scale linear theory bias of the halo;
\item [{\normalfont \ttfamily haloMass}] The mass of the halo (in $M_\odot$);
\item [{\normalfont \ttfamily haloMassFractionCumulative}] The mass fraction in halos above the current halo mass;
\item [{\normalfont \ttfamily haloMassFunctionCumulative}] The cumulative number of halos per unit volume above the current halo mass (in units of Mpc$^{-3}$);
\item [{\normalfont \ttfamily haloMassFunctionLnM}] The halo mass function per logarithmic halo mass (in units of Mpc$^{-3}$);
\item [{\normalfont \ttfamily haloMassFunctionM}] The halo mass function per logarithmic halo mass (in units of Mpc$^{-3} M_\odot^{-1}$);
\item [{\normalfont \ttfamily haloNu}] The peak height of the halo, $\nu = \delta_{\mathrm c}/\sigma(M)$;
\item [{\normalfont \ttfamily haloSigma}] The root-variance of the mass field smoothed in top-hat spheres;
\item [{\normalfont \ttfamily haloVirialRadius}] The virial radius (in units of Mpc) of the current halo mass;
\item [{\normalfont \ttfamily haloVirialTemperature}] The virial temperature (in units of Kelvin) of the current halo mass;
\item [{\normalfont \ttfamily haloVirialVelocity}] The virial velocity (in units of km/s) of the current halo mass;
\end{description}
Dimensionful datasets have an {\normalfont \ttfamily unitsInSI} attribute that gives their units in the SI system.

\subsection{{\normalfont \ttfamily Power\_Spectra}}\index{power spectrum!outputting}

The {\normalfont \ttfamily Power\_Spectra} code will generate an HDF5 output file which contains a variety of measures of the matter power spectrum tabulated as a function of wavenumber. The code is built and run as follows:
\begin{verbatim}
make Power_Spectra.exe
Power_Spectra.exe <parameterFile> <outputFile>
\end{verbatim}
where {\normalfont \ttfamily parameterFile} is a file of parameters in \glc's usual XML format and {\normalfont \ttfamily outputFile} is the name of the file to which the power spectrum data will be written. The parameter file can specify any parameters needed for computing the power spectrum (they will be set to default values in cases where a parameter is not included).
The output file has the following structure:
\begin{verbatim}
+-> powerSpectrum
|   |
|   +-> alpha         [dataset]
|   |
|   +-> mass          [dataset]
|   |
|   +-> powerSpectrum [dataset]
|   |
|   +-> sigma         [dataset]
|   |
|   +-> wavenumber    [dataset]
|    
+-> Parameters
    |
    +-> parameter1    [attribute]
    |
    +-> parameterN    [attribute]
\end{verbatim}
The {\normalfont \ttfamily Parameters} group contains attributes giving the values of all used parameters (just as in a \glc\ output file). The {\normalfont \ttfamily powerSpectrum} group contains datasets which give the power spectrum and related properties as follows:
\begin{description}
\item [{\normalfont \ttfamily alpha}] The logarithmic slope of $\sigma(M)$: $\alpha = {\mathrm d} \ln \sigma / {\mathrm d} \ln M$;
\item [{\normalfont \ttfamily mass}] The mass scale, $M$, corresponding to the given wavenumber, $k$, defined such that $M=4 \pi \Omega_{\mathrm M} \rho_{\mathrm crit} / 3 k^3$ (in units of $M_\odot$);
\item [{\normalfont \ttfamily powerSpectrum}] The linear theory power spectrum at $z=0$: $P(k)$ in units of Mpc$^3$;
\item [{\normalfont \ttfamily sigma}] The dimensionless linear theory mass fluctuation at $z=0$: $\sigma(M)$;
\item [{\normalfont \ttfamily wavenumber}] The wavenumber in units of Mpc$^{-1}$.
\end{description}
Dimensionful datasets have an {\normalfont \ttfamily unitsInSI} attribute that gives their units in the SI system.
