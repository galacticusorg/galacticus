\section{Merger Tree Builder}\index{merger trees!building}

\glc\ contains software which builds merger tree files in the format described in \S\ref{sec:MergerTreeFormatDescription} from merger tree descriptions in other formats, such as ASCII output from an SQL database. The merger tree building engine can be found in \hyperlink{objects.merger_tree_data.F90}{{\tt source/objects.merger\_tree\_data.F90}}. Examples of how this engine is used can be found in \hyperlink{Millennium_Merger_Tree_File_Maker.F90}{{\tt source/Millennium\_Merger\_Tree\_File\_Maker.F90}} and \hyperlink{merger_trees.file_maker.Millennium.F90}{{\tt source/merger\_trees.file\_maker.Millennium.F90}} which are designed to work with the {\tt scripts/aux/Millennium\_Trees\_Grab.pl} script to convert data extracted from the \href{http://www.g-vo.org/MyMillennium3/}{Millennium Simulation database} into a format that \glc\ can read, and in \hyperlink{Simple_Merger_Tree_File_Maker.F90}{{\tt source/Simple\_Merger\_Tree\_File\_Maker.F90}} and \hyperlink{merger_trees.file_maker.simple.F90}{{\tt source/merger\_trees.file\_maker.simple.F90}} which are designed to work with ASCII file representations of mergers trees that contain just the mass, redshift and descendent of each node.

The basic process for building a merger tree file is to inform the engine of the data file to read and where specific information is located within that file. The data can then be processed and, finally, output in the required format. Specific interfaces that can be used are described below. Many of these interfaces work on an object {\tt mergerTrees} of {\tt mergerTreeData} type. This object stores all information on the merger trees while they are being internally processed.

\noindent \emph{Setting property locations:} Before reading data from a file it is necessary to inform the tree builder engine of which column in the file corresponds to which property. This is done with repeated calls to {\tt setProperty}, one for each column to read, as follows:
\begin{verbatim}
call mergerTrees%setProperty(propertyType,columnIndex)
\end{verbatim}
where {\tt columnIndex} is the number of the column (counting from 1) which contains the property specified by {\tt propertyType}. {\tt propertyType} can take one of the following values:
\begin{description}
 \item [{\tt propertyTypeTreeIndex}] A unique ID number for the tree to which this node belongs;
 \item [{\tt propertyTypeNodeIndex}] An ID (unique within the tree) for this node;
 \item [{\tt propertyTypeDescendentIndex}] The ID of the node's descendent node;
 \item [{\tt propertyTypeHostIndex}] The ID of the larger halo in which this node is hosted (equal to the node's own ID if the node is self-hosting);
 \item [{\tt propertyTypeRedshift}] The redshift of the node;
 \item [{\tt propertyTypeNodeMass}] The mass of the node;
 \item [{\tt propertyTypeParticleCount}] The number of particles in the node;
 \item [{\tt propertyTypePositionX}] The $x$-position of the node (if present, both $y$ and $z$ components must also be present);
 \item [{\tt propertyTypePositionY}] The $y$-position of the node (if present, both $x$ and $z$ components must also be present);
 \item [{\tt propertyTypePositionZ}] The $z$-position of the node (if present, both $x$ and $y$ components must also be present);
 \item [{\tt propertyTypeVelocityX}] The $x$-velocity of the node (if present, both $y$ and $z$ components must also be present);
 \item [{\tt propertyTypeVelocityY}] The $y$-velocity of the node (if present, both $x$ and $z$ components must also be present);
 \item [{\tt propertyTypeVelocityZ}] The $z$-velocity of the node (if present, both $x$ and $y$ components must also be present);
 \item [{\tt propertyTypeSpinX}] The $x$ component of the node's spin parameter (if present, both $y$ and $z$ components must also be present; cannot be present if spin magnitude is given);
 \item [{\tt propertyTypeSpinY}] The $y$ component of the node's spin parameter (if present, both $x$ and $z$ components must also be present; cannot be present if spin magnitude is given);
 \item [{\tt propertyTypeSpinZ}] The $z$ component of the node's spin parameter (if present, both $x$ and $y$ components must also be present; cannot be present if spin magnitude is given);
 \item [{\tt propertyTypeSpin}] The magnitude of the node's spin parameter (cannot be present if spin vector components are given);          
 \item [{\tt propertyTypeAngularMomentumX}] The $x$-component of the node's angular momentum (if present, both $y$ and $z$ components must also be present; cannot be present if angular momentum magnitude is given);
 \item [{\tt propertyTypeAngularMomentumY}] The $y$-component of the node's angular momentum (if present, both $x$ and $z$ components must also be present; cannot be present if angular momentum magnitude is given);
 \item [{\tt propertyTypeAngularMomentumZ}] The $z$-component of the node's angular momentum (if present, both $x$ and $y$ components must also be present; cannot be present if angular momentum magnitude is given);
 \item [{\tt propertyTypeAngularMomentum}] The magnitude of the node's angular momentum (cannot be present if angular momentum vector components are given);
 \item [{\tt propertyTypeHalfMassRadius}] The half-mass radius of the node;
 \item [{\tt propertyTypeMostBoundParticleIndex}] The index of the most bound particle in this node.
\end{description}
Not all properties must be specified---any required properties that are not specified will result in an error. Likewise, some properties, if present, require that other properties also be present. For example, if any of the position properties is given then all three positions are required.\\

\noindent \emph{Reading ASCII data:} Once property columns have been specified, data from an ASCII file with one node per line can be read as follows:
\begin{verbatim}
call mergerTrees%readASCII(nodesFile,lineNumberStart,lineNumberStop,separator=",")
\end{verbatim}
where {\tt nodesFile} is the name of the file to read. The optional {\tt lineNumberStart} and {\tt lineNumberEnd} arguments give the first and last lines of the file to read, while the optional {\tt separator} argument specifies the character used to separate columns (white space is assumed by default).\\

\noindent \emph{Setting particle property locations:} If particle information is to be stored in the file, the locations of particle properties within the input file must be specified with repeated calls to {\tt setParticleProperty} as follows:
\begin{verbatim}
call mergerTrees%setParticleProperty(propertyType,columnIndex)
\end{verbatim}
where {\tt columnIndex} is the number of the column (counting from 1) which contains the property specified by {\tt propertyType}. {\tt propertyType} can take one of the following values:
\begin{description}
 \item [{\tt propertyTypeParticleIndex}] A unique ID for the particle;
 \item [{\tt propertyTypeRedshift}] The redshift of the particle;
 \item [{\tt propertyTypeNodeMass}] The mass of the particle;
 \item [{\tt propertyTypeParticleCount}] The number of particles in the particle;
 \item [{\tt propertyTypePositionX}] The $x$-position of the particle (if present, both $y$ and $z$ components must also be present);
 \item [{\tt propertyTypePositionY}] The $y$-position of the particle (if present, both $x$ and $z$ components must also be present);
 \item [{\tt propertyTypePositionZ}] The $z$-position of the particle (if present, both $x$ and $y$ components must also be present);
 \item [{\tt propertyTypeVelocityX}] The $x$-velocity of the particle (if present, both $y$ and $z$ components must also be present);
 \item [{\tt propertyTypeVelocityY}] The $y$-velocity of the particle (if present, both $x$ and $z$ components must also be present);
 \item [{\tt propertyTypeVelocityZ}] The $z$-velocity of the particle (if present, both $x$ and $y$ components must also be present).
\end{description}

\noindent \emph{Reading ASCII particle data:} Once property columns have been specified, particle data from an ASCII file with one particle per line can be read as follows:
\begin{verbatim}
call mergerTrees%readParticlesASCII(particlesFile,lineNumberStart,lineNumberStop,separator=",")
\end{verbatim}
where {\tt particlesFile} is the name of the file to read. The optional {\tt lineNumberStart} and {\tt lineNumberEnd} arguments give the first and last lines of the file to read, while the optional {\tt separator} argument specifies the character used to separate columns (white space is assumed by default).\\

\noindent \emph{Setting particle mass:} The particle mass, {\tt particleMass}, can be specified using:
\begin{verbatim}
call mergerTrees%setParticleMass(particleMass)
\end{verbatim}

\noindent \emph{Specifying tree self-containment:} Whether or not trees are self-contained can be specified using:
\begin{verbatim}
call mergerTrees%setSelfContained([.true.|.false.])
\end{verbatim}

\noindent \emph{Specifying Hubble flow inclusion:} Whether or not velocities include the Hubble flow can be speified using:
\begin{verbatim}
call mergerTrees%setIncludesHubbleFlow([.true.|.false.])
\end{verbatim}

\noindent \emph{Specifying subhalo mass inclusion:} Whether or not halo masses include the masses of any subhalos can be specified using:
\begin{verbatim}
call mergerTrees%setIncludesSubhaloMasses([.true.|.false.])
\end{verbatim}

\noindent \emph{Specifying reference creation:} Whether or not HDF5 reference to individual merger trees within the {\tt haloTrees} datasets should be made can be specified using:
\begin{verbatim}
call mergerTrees%makeReferences([.true.|.false.])
\end{verbatim}

\noindent \emph{Specifying units:} The units used in the files can be specified with repeated calls to {\tt setUnits} as follows:
\begin{verbatim}
call mergerTrees%setUnits(unitsType,unitsInSI,hubbleExponent,scaleFactorExponent)
\end{verbatim}
where {\tt unitsType} is one of:
\begin{description}
 \item [{\tt unitsMass}] Units of mass;
 \item [{\tt unitsLength}] Units of length;
 \item [{\tt unitsTime}] Units of time;
 \item [{\tt unitsVelocity}] Units of velocity;
\end{description}
{\tt unitsInSI} gives the units in the SI system, {\tt hubbleExponent} specifies the power to which $h$ appears in the units and {\tt scaleFactorExponent} specifies the number of powers of the expansion factor by which the quantity should be multiplied to place it into physical units.\\

\noindent \emph{Adding metadata:} Meta-data can be added to the file by making repeated calls to {\tt addMetadata} as follows:
\begin{verbatim}
call mergerTrees%addMetadata(metaDataType,label,value)
\end{verbatim}
where {\tt metaDataType} is one of:
\begin{description}
 \item [{\tt metaDataGeneric}] Add to the generic {\tt metaData} group;
 \item [{\tt metaDataCosmology}] Add to the {\tt cosmology} group;
 \item [{\tt metaDataSimulation}] Add to the {\tt simulation} group;
 \item [{\tt metaDataGroupFinder}] Add to the {\tt groupFinder} group;
 \item [{\tt metaDataTreeBuilder}] Add to the {\tt treeBuilder} group;
 \item [{\tt metaDataProvenance}] Add to the {\tt provenance} group,
\end{description}
{\tt label} is a label for this metadatum and {\tt value} is the value to store. Currently integer, double precision and character data types are supported for metadata.\\

\noindent \emph{Exporting the data:} Once the data has been read, units and properties specified and any metadata added, the trees can be exported to an HDF5 file using:
\begin{verbatim}
  call mergerTrees%export(outputFile,hdfChunkSize,hdfCompressionLevel)
\end{verbatim}
where {\tt outputFile} is the name of the file to which the trees should be exported, and {\tt hdfChunkSize} and {\tt hdfCompressionLevel} respectively give the chunk size and compression level to use when writing the file.
