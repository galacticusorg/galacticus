\chapter{Developing \glc}

The following is a quickstart guide to making changes to the \glc\ source code and contributing them back to the project. Note that the preferred method to do this is through \href{https://bitbucket.org}{\sc BitBucket}.

\section{Getting Started}

It's easy to begin working with and changing the \glc\ source code. Assuming you have Mercurial (``{\tt hg}'') installed, just do:
\begin{verbatim}
 hg clone https://abensonca@bitbucket.org/abensonca/galacticus galacticus
\end{verbatim}
and you have a cloned copy of the \glc\ repository in the {\tt galacticus} directory.

\subsection{Using {\sc BitBucket}}

If you plan to contribute changes back to the \glc] project (please do!), you should consider using \href{https://bitbucket.org}{\sc BitBucket}. After you've created an account for yourself at {\sc BitBucket}, you can ``fork'' the \glc\ repository to have your own working copy. This can be done as follows:
\begin{itemize}
 \item visit the \glc\ repository on {\tt BitBucket} at \href{https://bitbucket.org/abensonca/galacticus/overview}{\tt https://bitbucket.org/abensonca/galacticus/overview};
 \item click on the ``Fork'' button---you'll be presented with a form;
 \item fill out the form (setting a name for your fork, a short description, etc.), then click the ``Fork repository'' button;
 \item after the fork completes, you'll be taken to the overview page for your forked repository.
\end{itemize}. 

You'll now want to clone this forked repository to your local system. Click on the ``Clone'' button and copy the {\tt hg clone} command presented there (you want the {\tt SSH} version so that you can push changes back to this repository). Run this command on your local system to get a cloned copy of your new repository. You can now work with this repository, make any changes, and commit then. We'll discuss how to send these changes back to {\sc BitBucket}, and back to the \glc\ project below.

\section{Making Simple Changes}

If you want to make some relatively minor changes to the \glc\ code, such as fixing a typo, adding a new filter, etc. you can just make changes directly on the {\tt default} branch (i.e. at the point of active development). To do this, make sure you're at {\tt default}:
\begin{verbatim}
 hg pull
 hg update default
\end{verbatim}
Then make your changes, add new files, etc. Once you're done, first check if there have been any changes to {\tt default} since you {\tt pull}ed:
\begin{verbatim}
 hg incoming
\end{verbatim}
If any new changesets are shown, us {\tt hg pull -u} to merge these in to your working copy. Then commit your changes:
\begin{verbatim}
 hg commit
\end{verbatim}
Your changes are now commited to your cloned repository.

\subsection{Contributing Your Changes Back To \glc}

Once you've committed your changes, you can contribute them back to the \glc\ project.

\subsubsection{Via E-mail}

If you just cloned the \glc\ repository directly you can send a patch containing your changes by e-mail to \href{mailto:abenson@obs.carnegiescience.edu}{abenson\@obs.carnegiescience.edu}. First, create the patch file using:
\begin{verbatim}
 hg export -r begin:end > changes.diff
\end{verbatim}
where {\tt begin} and {\tt end} are the first and last revisions that you want to include (you can specify more complicated sets of revisions of course). Then simply attached the {\tt changes.diff} file to an e-mail. It will be merged into the \glc\ project using
\begin{verbatim}
 hg import changes.diff
\end{verbatim}

\subsubsection{Using {\sc BitBucket}}

If you forked the \glc\ repository on {\sc BitBucket}, you can now push your changes back to {\tt BitBucket} using
\begin{verbatim}
 hg push
\end{verbatim}
If you want to contribute these changes back to the \glc\ project the best way to do so is to create a ``pull request''. Simply visit your forked respository on {\sc BitBucket} and click the ``Pull request'' button. The form you're presented with allows you to choose which branch in your respository you want to send changes from, and which branch in the \glc\ project you want them contributed to. Add a title and description of your changes (and, optionally, check the ``Close branch'' box if you're done with this branch of development) then click ``Create pull request''. Assuming your code looks godo and works, it can then be pulled into the \glc\ project.

\section{Making Bigger Changes}

For bigger changes, particularly those where you're adding a new feature, we recommend using Mercurial's ``feature branches''. These provide a permanent record of for which feature each changeset was added. Using feature branches is straightforward. Begin with {\tt default} and create a new branch:
\begin{verbatim}
 hg update default
 hg branch myNewFeature
\end{verbatim}
where {\tt myNewFeature} is a name for your feature branch. Then begin working, make changes, add new files etc. You can make commits when necessary (and it's good to make several small commits rather than one big one). You should merge {\tt default} into your feature branch as often as possible to avoid them getting out of sync (which makes for difficulty later when you want to merge your feature branch back into {\tt default}):
\begin{verbatim}
 hg update myFeatureBranch
 hg merge default
 hg commit -m "merged default into myFeatureBranch"
\end{verbatim}
Once the feature branch is stable, you can merge it back into {\tt default}:
\begin{verbatim}
 hg update default
 hg merge myFeatureBranch
 hg commit -m "merged myFeatureBranch"
\end{verbatim}
Once you're done developing this feature, you should close the feature branch:
\begin{verbatim}
 hg commit --close-branch -m "finished my feature"
\end{verbatim}
Note that you can always go back and work on a feature branch later, after you have closed it. Just do:
\begin{verbatim}
 hg up myFeatureBranch
 hg merge default
 hg commit -m "merged default into myFeatureBranch"
\end{verbatim}
then continue to work with your feature branch as normal (don't forget to close it again when you're finished working with it).

\section{Releases}

Each release of \glc\ exists as a separate branch within the main \glc\ repository. To work with a particular release use
\begin{verbatim}
 hg update v0.9.2
\end{verbatim}
replacing the version number with whichever version you want. To get back to the development tip use
\begin{verbatim}
 hg update default
\end{verbatim}

\subsection{Bug Fixes In Releases}

To make a bugfix in a release, simply {\tt hg update} to that release, fix the bug, and commit your changes. In many cases you'll want to fix the same bug in later releases and also in {\tt default}. To do that, just {\tt hg update} to each branch in turn, use {\tt hg merge fixedBranch} (where ``{\tt fixedBranch}'' is the name of the branch in which you fixed the branch, and then commit the merge. Once the bgu has been fixed you can contribute the fix back to the \glc\ project using the methods described above.
