\chapter{Developing \glc}

The following is a quickstart guide to making changes to the \glc\ source code and contributing them back to the project. Note that the preferred method to do this is through \href{https://bitbucket.org}{\normalfont \scshape BitBucket}.

\section{Getting Started}

It's easy to begin working with and changing the \glc\ source code. Assuming you have Mercurial (``{\normalfont \ttfamily hg}'') installed, just do:
\begin{verbatim}
 hg clone https://abensonca@bitbucket.org/abensonca/galacticus galacticus
\end{verbatim}
and you have a cloned copy of the \glc\ repository in the {\normalfont \ttfamily galacticus} directory.

\subsection{Using {\normalfont \scshape BitBucket}}

If you plan to contribute changes back to the \glc] project (please do!), you should consider using \href{https://bitbucket.org}{\normalfont \scshape BitBucket}. After you've created an account for yourself at {\normalfont \scshape BitBucket}, you can ``fork'' the \glc\ repository to have your own working copy. This can be done as follows:
\begin{itemize}
 \item visit the \glc\ repository on {\normalfont \ttfamily BitBucket} at \href{https://bitbucket.org/abensonca/galacticus/overview}{\normalfont \ttfamily https://bitbucket.org/abensonca/galacticus/overview};
 \item click on the ``Fork'' button---you'll be presented with a form;
 \item fill out the form (setting a name for your fork, a short description, etc.), then click the ``Fork repository'' button;
 \item after the fork completes, you'll be taken to the overview page for your forked repository.
\end{itemize}. 

You'll now want to clone this forked repository to your local system. Click on the ``Clone'' button and copy the {\normalfont \ttfamily hg clone} command presented there (you want the {\normalfont \ttfamily SSH} version so that you can push changes back to this repository). Run this command on your local system to get a cloned copy of your new repository. You can now work with this repository, make any changes, and commit then. We'll discuss how to send these changes back to {\normalfont \scshape BitBucket}, and back to the \glc\ project below.

\section{Making Simple Changes}

If you want to make some relatively minor changes to the \glc\ code, such as fixing a typo, adding a new filter, etc. you can just make changes directly on the {\normalfont \ttfamily default} branch (i.e. at the point of active development). To do this, make sure you're at {\normalfont \ttfamily default}:
\begin{verbatim}
 hg pull
 hg update default
\end{verbatim}
Then make your changes, add new files, etc. Once you're done, first check if there have been any changes to {\normalfont \ttfamily default} since you {\normalfont \ttfamily pull}ed:
\begin{verbatim}
 hg incoming
\end{verbatim}
If any new changesets are shown, us {\normalfont \ttfamily hg pull -u} to merge these in to your working copy. Then commit your changes:
\begin{verbatim}
 hg commit
\end{verbatim}
Your changes are now commited to your cloned repository.

\subsection{Contributing Your Changes Back To \glc}

Once you've committed your changes, you can contribute them back to the \glc\ project.

\subsubsection{Via E-mail}

If you just cloned the \glc\ repository directly you can send a patch containing your changes by e-mail to \href{mailto:abenson@carnegiescience.edu}{abenson{@}carnegiescience.edu}. First, create the patch file using:
\begin{verbatim}
 hg export -r begin:end > changes.diff
\end{verbatim}
where {\normalfont \ttfamily begin} and {\normalfont \ttfamily end} are the first and last revisions that you want to include (you can specify more complicated sets of revisions of course). Then simply attached the {\normalfont \ttfamily changes.diff} file to an e-mail. It will be merged into the \glc\ project using
\begin{verbatim}
 hg import changes.diff
\end{verbatim}

\subsubsection{Using {\normalfont \scshape BitBucket}}

If you forked the \glc\ repository on {\normalfont \scshape BitBucket}, you can now push your changes back to {\normalfont \ttfamily BitBucket} using
\begin{verbatim}
 hg push
\end{verbatim}
If you want to contribute these changes back to the \glc\ project the best way to do so is to create a ``pull request''. Simply visit your forked respository on {\normalfont \scshape BitBucket} and click the ``Pull request'' button. The form you're presented with allows you to choose which branch in your respository you want to send changes from, and which branch in the \glc\ project you want them contributed to. Add a title and description of your changes (and, optionally, check the ``Close branch'' box if you're done with this branch of development) then click ``Create pull request''. Assuming your code looks godo and works, it can then be pulled into the \glc\ project.

\section{Making Bigger Changes}

For bigger changes, particularly those where you're adding a new feature, we recommend using Mercurial's ``feature branches''. These provide a permanent record of for which feature each changeset was added. Using feature branches is straightforward. Begin with {\normalfont \ttfamily default} and create a new branch:
\begin{verbatim}
 hg update default
 hg branch myNewFeature
\end{verbatim}
where {\normalfont \ttfamily myNewFeature} is a name for your feature branch. Then begin working, make changes, add new files etc. You can make commits when necessary (and it's good to make several small commits rather than one big one). You should merge {\normalfont \ttfamily default} into your feature branch as often as possible to avoid them getting out of sync (which makes for difficulty later when you want to merge your feature branch back into {\normalfont \ttfamily default}):
\begin{verbatim}
 hg update myFeatureBranch
 hg merge default
 hg commit -m "merged default into myFeatureBranch"
\end{verbatim}
Once the feature branch is stable, you can merge it back into {\normalfont \ttfamily default}:
\begin{verbatim}
 hg update default
 hg merge myFeatureBranch
 hg commit -m "merged myFeatureBranch"
\end{verbatim}
Once you're done developing this feature, you should close the feature branch:
\begin{verbatim}
 hg commit --close-branch -m "finished my feature"
\end{verbatim}
Note that you can always go back and work on a feature branch later, after you have closed it. Just do:
\begin{verbatim}
 hg up myFeatureBranch
 hg merge default
 hg commit -m "merged default into myFeatureBranch"
\end{verbatim}
then continue to work with your feature branch as normal (don't forget to close it again when you're finished working with it).

\section{Releases}

Each release of \glc\ exists as a separate branch within the main \glc\ repository. To work with a particular release use
\begin{verbatim}
 hg update v0.9.2
\end{verbatim}
replacing the version number with whichever version you want. To get back to the development tip use
\begin{verbatim}
 hg update default
\end{verbatim}

\subsection{Bug Fixes In Releases}

To make a bugfix in a release, simply {\normalfont \ttfamily hg update} to that release, fix the bug, and commit your changes. In many cases you'll want to fix the same bug in later releases and also in {\normalfont \ttfamily default}. To do that, just {\normalfont \ttfamily hg update} to each branch in turn, use {\normalfont \ttfamily hg merge fixedBranch} (where ``{\normalfont \ttfamily fixedBranch}'' is the name of the branch in which you fixed the branch, and then commit the merge. Once the bug has been fixed you can contribute the fix back to the \glc\ project using the methods described above.

\section{The \glc\ Build System}

\glc\ use a GNU Make-based build system. Dependencies are automatically discovered, and extensive meta-programming and preprocessing of source files is undertaken as part of the build. As a result, the build system is complicated. In this section the build system is described and detailed.

\subsection{The Makefile}

Files generated during the build (with the exception of final executables) are written to the directory specified by the {\normalfont \ttfamily BUILDPATH} environment variable. This is normally {\normalfont \ttfamily work/build/} (and is set by the {\normalfont \ttfamily Makefile}) unless a special build configuration is requested.

\subsection{Automatic Discovery}

\subsubsection{Executable Files}\index{files!executable}\index{executable files}\label{sec:buildExecutables}

Files which produce executables (including the {\normalfont \ttfamily Galacticus.exe} executable) are discovered by the {\normalfont \ttfamily scripts/build/findExecutables.pl}\index{findExecutables.pl@{\normalfont \ttfamily findExecutables.pl}} script, which generates rules describing how these files should be built, along with all of their dependencies, and writes them to {\normalfont \ttfamily \$(BUILDPATH)/Makefile\_All\_Execs}\index{Makefile_All_Execs@{\normalfont \ttfamily Makefile\_All\_Execs}}. All Fortran files in the {\normalfont \ttfamily source} directory are parsed, and executable files are identified as those containing a {\normalfont \ttfamily program} statement. All executables so identified are also added to the list of objects that will be built by {\normalfont \ttfamily make all}.

\subsubsection{Included Files}\index{files!include}\index{include files}\label{sec:buildIncludeDeps}

Dependencies on files due to the use of ``{\normalfont \ttfamily include}'' statements (in both Fortran and C source files) are discovered by the {\normalfont \ttfamily scripts/build/includeDependencies.pl}\index{includeDependencies.pl@{\normalfont \ttfamily includeDependencies.pl}} script, which generates rules describing these dependencies and writes them to {\normalfont \ttfamily \$(BUILDPATH)/Makefile\_Include\_Deps}\index{Makefile_Include_Deps@{\normalfont \ttfamily Makefile\_Include\_Deps}}.

All Fortran and C/C++ source files in the {\normalfont \ttfamily source} directory are parsed. Files specified in any include statement in a source file are added as a dependency of that source file if unless the source file is C/C++ and the named include file can be found in either {\normalfont \ttfamily source/}, a standard system include path, or in any include path specified in the {\normalfont \ttfamily GALACTICUS\_CFLAGS}\index{environment variables!GALACTICUS_CFLAGS@{\normalfont \ttfamily GALACTICUS\_CFLAGS}}\index{GALACTICUS_CFLAGS@{\normalfont \ttfamily GALACTICUS\_CFLAGS}} or {\normalfont \ttfamily GALACTICUS\_CPPFLAGS}\index{environment variables!GALACTICUS_CPPFLAGS@{\normalfont \ttfamily GALACTICUS\_CPPFLAGS}}\index{GALACTICUS_CPPFLAGS@{\normalfont \ttfamily GALACTICUS\_CPPFLAGS}} environment variables.

\subsubsection{Parameter Dependencies}\index{parameters!dependencies}\label{sec:parameterDependencies}

All runtime parameters upon which a given executable may depend are discovered by the {\normalfont \ttfamily scripts/build/parameterDependencies.pl}\index{parameterDependencies.pl@{\normalfont \ttfamily parameterDependencies.pl}} script, which generates XML files listing these parameters and writes them to {\normalfont \ttfamily \$(BUILDPATH)/\textless executableName\textgreater.parameters.xml}\index{*.parameters.xml@{\normalfont \ttfamily *.parameters.xml}}. All Fortran and C++ files in the {\normalfont \ttfamily source} directory are parsed, and embedded parameter definitions (i.e. embedded XML blocks in lines beginning ``!\@'' for Fortran or ``//\@'' for C++ with root element {\normalfont \ttfamily inputParameter}) are identified. Any files included into a source file are also searched. In the case of Fortran source files, {\normalfont \ttfamily source/*.F90}, the corresponding preprocessed file, {\normalfont \ttfamily \$(BUILDPATH)/*.p.F90}, will be searched for parameter dependencies.

\subsection{Build Files}

\begin{description}
\item[{\normalfont \ttfamily scripts/build/includeDependencies.pl}\index{includeDependencies.pl@{\normalfont \ttfamily includeDependencies.pl}}:] Discovers (and generates rules for) dependencies between files arising from the use of ``{\normalfont \ttfamily include}'' statements (see \S\ref{sec:buildIncludeDeps});
  
  \item[{\normalfont \ttfamily \normalfont \ttfamily scripts/build/executableSize.pl\index{executableSize.pl@{\normalfont \ttfamily executableSize.pl}}}:] Generates a file containing details of the size of each generated executable which can be used at runtime for memory reporting (see \S\ref{sec:buildExecutables});

\item[{\normalfont \ttfamily \normalfont \ttfamily scripts/build/findExecutables.pl\index{findExecutables.pl@{\normalfont \ttfamily findExecutables.pl}}}:] Discovers (and generates rules for) files which generate executables (see \S\ref{sec:buildExecutables});

\item[{\normalfont \ttfamily \$(BUILDPATH)/Makefile\_Include\_Deps}\index{Makefile_Include_Deps@{\normalfont \ttfamily Makefile\_Include\_Deps}}:] Contains rules describing the dependencies of source file on files included via ``{\normalfont \ttfamily include}'' statements---generated by {\normalfont \ttfamily scripts/build/includeDependencies.pl}\index{includeDependencies.pl@{\normalfont \ttfamily includeDependencies.pl}} (see \S\ref{sec:buildIncludeDeps});

\item[{\normalfont \ttfamily \$(BUILDPATH)/Makefile\_All\_Execs}\index{Makefile_All_Execs@{\normalfont \ttfamily Makefile\_All\_Execs}}:] Contains rules describing how to build the executable file for each distinct program---generated by {\normalfont \ttfamily scripts/build/findExecutables.pl}\index{findExecutables.pl@{\normalfont \ttfamily findExecutables.pl}} (see \S\ref{sec:buildExecutables});

\item[{\normalfont \ttfamily \$(BUILDPATH)/*.size}\index{*.size files@{\normalfont \ttfamily *.size} files}:] Contain the size of each executable file built, and are used at runtime for memory reporting purposes---generated by {\normalfont \ttfamily scripts/build/executableSize.pl}\index{executableSize.pl@{\normalfont \ttfamily executableSize.pl}} (see \S\ref{sec:buildExecutables});
\end{description}
