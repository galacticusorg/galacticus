!! Copyright 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017
!!    Andrew Benson <abenson@carnegiescience.edu>
!!
!! This file is part of Galacticus.
!!
!!    Galacticus is free software: you can redistribute it and/or modify
!!    it under the terms of the GNU General Public License as published by
!!    the Free Software Foundation, either version 3 of the License, or
!!    (at your option) any later version.
!!
!!    Galacticus is distributed in the hope that it will be useful,
!!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!!    GNU General Public License for more details.
!!
!!    You should have received a copy of the GNU General Public License
!!    along with Galacticus.  If not, see <http://www.gnu.org/licenses/>.

!% Contains a module which performs analysis to compute a variety of mass functions.

module Galacticus_Output_Analyses_Mass_Functions
  !% Performs analysis to compute a variety of mass functions.
  use, intrinsic :: ISO_C_Binding
  use Galacticus_Nodes
  use Galactic_Structure_Options
  use Geometry_Surveys
  use Mass_Function_Incompletenesses
  use Gravitational_Lensing
  implicit none
  private
  public :: Galacticus_Output_Analysis_Mass_Functions, Galacticus_Output_Analysis_Mass_Functions_Output

  ! Record of module initialization.
  logical                                                   :: moduleInitialized=.false.

  ! Record of whether this analysis is active.
  logical                                                   :: analysisActive

  ! Number of supported mass functions.
  integer          , parameter                              :: massFunctionsSupportedCount=31

  ! Labels for supported mass functions.
  integer          , parameter                              :: gamaStellarMassFunction    =3
  character(len=37), dimension(massFunctionsSupportedCount) :: massFunctionLabels=      &
       & [                                                                              &
       &  'sdssStellarMassFunctionZ0.07        ',                                       &
       &  'bernardiSdssStellarMassFunctionZ0.07',                                       &
       &  'gamaStellarMassFunctionZ0.03        ',                                       &
       &  'alfalfaHiMassFunctionZ0.00          ',                                       &
       &  'primusStellarMassFunctionZ0.250     ',                                       &
       &  'primusStellarMassFunctionZ0.350     ',                                       &
       &  'primusStellarMassFunctionZ0.450     ',                                       &
       &  'primusStellarMassFunctionZ0.575     ',                                       &
       &  'primusStellarMassFunctionZ0.725     ',                                       &
       &  'primusStellarMassFunctionZ0.900     ',                                       &
       &  'vipersStellarMassFunctionZ0.55      ',                                       &
       &  'vipersStellarMassFunctionZ0.70      ',                                       &
       &  'vipersStellarMassFunctionZ0.90      ',                                       &
       &  'ukidssUdsStellarMassFunctionZ3.250  ',                                       &
       &  'ukidssUdsStellarMassFunctionZ3.875  ',                                       &
       &  'ukidssUdsStellarMassFunctionZ4.625  ',                                       &
       &  'zfourgeStellarMassFunctionZ0.350    ',                                       &
       &  'zfourgeStellarMassFunctionZ0.625    ',                                       &
       &  'zfourgeStellarMassFunctionZ0.875    ',                                       &
       &  'zfourgeStellarMassFunctionZ1.125    ',                                       &
       &  'zfourgeStellarMassFunctionZ1.375    ',                                       &
       &  'zfourgeStellarMassFunctionZ1.750    ',                                       &
       &  'zfourgeStellarMassFunctionZ2.250    ',                                       &
       &  'zfourgeStellarMassFunctionZ2.750    ',                                       &
       &  'ultravistaStellarMassFunctionZ0.35  ',                                       &
       &  'ultravistaStellarMassFunctionZ0.75  ',                                       &
       &  'ultravistaStellarMassFunctionZ1.25  ',                                       &
       &  'ultravistaStellarMassFunctionZ1.75  ',                                       &
       &  'ultravistaStellarMassFunctionZ2.25  ',                                       &
       &  'ultravistaStellarMassFunctionZ2.75  ',                                       &
       &  'ultravistaStellarMassFunctionZ3.50  '                                        &
       & ]

  ! Interface for mass mapping functions.
  abstract interface
     double precision function Map_Mass(mass,node)
       import treeNode
       double precision          , intent(in   )          :: mass
       type            (treeNode), intent(inout), pointer :: node
     end function Map_Mass
  end interface

  ! Interface for mass error functions.
  abstract interface
     subroutine Mass_Error(mass,node,error,weight)
       import treeNode
       double precision          , intent(in   )                            :: mass
       type            (treeNode), intent(inout), pointer                   :: node
       double precision          , intent(inout), allocatable, dimension(:) :: error   , weight
     end subroutine Mass_Error
  end interface

  ! Type for descriptors of mass functions.
  type :: massFunctionDescriptor
     double precision                                                       :: errorModelLogM0
     procedure       (Mass_Error                     ), pointer    , nopass :: randomErrorFunction
     double precision                                                       :: massLogarithmicMinimum
     double precision                                                       :: surfaceBrightnessLimit    , surfaceBrightnessZeroPoint
     integer                                                                :: systematicCoefficientCount, randomCoefficientCount
     integer                                                                :: massType
     character       (len= 35                        )                      :: label
     character       (len=128                        )                      :: comment
     procedure       (Map_Mass                       ), pointer    , nopass :: mapMass
     class           (surveyGeometryClass            ), allocatable         :: geometry
     class           (massFunctionIncompletenessClass), allocatable         :: incompleteness
  end type massFunctionDescriptor

  ! Mass function descriptors.
  type(massFunctionDescriptor), dimension(massFunctionsSupportedCount), target :: massFunctionDescriptors=       &
       & [                                                                                                       &
                                ! SDSS survey, Li & White measurement.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'sdssStellarMassFunctionZ0.07'               ,        &
       &                                                   'SDSS stellar mass function at z=0.07'       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
                                ! SDSS survey, Bernardi et al. measurement.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'bernardiSdssStellarMassFunctionZ0.07'       ,        &
       &                                                   'SDSS stellar mass function at z=0.07'       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
                                ! GAMA survey, Baldry measurement.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   4.500d0                                      ,        &
       &                                                  23.500d0                                      ,        &
       &                                                   1.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'gamaStellarMassFunctionZ0.03'               ,        &
       &                                                   'GAMA stellar mass function at z=0.03'       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
                                ! ALFALFA survey.
       &                           massFunctionDescriptor(                                                       &
       &                                                  10.000d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   4.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   0                                            ,        &
       &                                                   massTypeGaseous                              ,        &
       &                                                   'alfalfaHiMassFunctionZ0.00'                 ,        &
       &                                                   'ALFALFA HI mass function at z=0.00'         ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                    ,  &
                                ! PRIMUS survey.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.250'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.250'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.350'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.350'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.450'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.450'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.575'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.575'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.725'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.725'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.30d0                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   6.50d0                                       ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'primusStellarMassFunctionZ0.900'            ,        &
       &                                                   'PRMIUS stellar mass function at z=0.900'    ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
                                ! VIPERS survey measured by Davidzon et al. (2014).
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'vipersStellarMassFunctionZ0.55'             ,        &
       &                                                   'VIPERS stellar mass function at z=0.55'     ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'vipersStellarMassFunctionZ0.70'             ,        &
       &                                                   'VIPERS stellar mass function at z=0.70'     ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'vipersStellarMassFunctionZ0.90'             ,        &
       &                                                   'VIPERS stellar mass function at z=0.90'     ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
                                ! UKIDSS UDS survey.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ukidssUdsStellarMassFunctionZ3.250'         ,        &
       &                                                   'UKIDSS UDS stellar mass function at z=3.250',        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ukidssUdsStellarMassFunctionZ3.875'         ,        &
       &                                                   'UKIDSS UDS stellar mass function at z=3.875',        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ukidssUdsStellarMassFunctionZ4.625'         ,        &
       &                                                   'UKIDSS UDS stellar mass function at z=4.625',        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       ! ZFOURGE survey.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ0.350'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=0.350'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ0.625'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=0.625'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ0.875'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=0.875'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ1.125'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=1.125'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ1.375'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=1.375'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ1.750'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=1.750'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ2.250'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=2.250'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   8.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'zfourgeStellarMassFunctionZ2.750'           ,        &
       &                                                   'ZFOURGE stellar mass function at z=2.750'   ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       ! ULTRAVISTA survey.
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   6.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ0.35'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=0.35' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ0.75'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=0.75' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   7.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ1.25'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=1.25' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   8.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ1.75'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=1.75' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   8.500d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ2.25'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=2.25' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   9.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ2.75'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=2.75' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                     , &
       &                           massFunctionDescriptor(                                                       &
       &                                                  11.300d0                                      ,        &
       &                                                   null()                                       ,        &
       &                                                   9.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   0.000d0                                      ,        &
       &                                                   2                                            ,        &
       &                                                   2                                            ,        &
       &                                                   massTypeStellar                              ,        &
       &                                                   'ultravistaStellarMassFunctionZ3.50'         ,        &
       &                                                   'ULTRAVISTA stellar mass function at z=3.50' ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                       ,        &
       &                                                   null()                                                &
       &                                                 )                                                       &
       & ]
  
  ! Type to store mass functions.
  type :: massFunction
     ! Copy of the mass function descriptor for this mass function.
     type            (massFunctionDescriptor), pointer                       :: descriptor
     ! Parameters for the systematic error model.
     double precision                        , allocatable, dimension(:    ) :: systematicCoefficients
     ! Parameters for the random error model.
     double precision                        , allocatable, dimension(:    ) :: randomCoefficients
     double precision                                                        :: randomMinimum                   , randomMaximum
     ! The number of mass bins.
     integer                                                                 :: massesCount
     ! Arrays for the masses and mass function.
     double precision                        , allocatable, dimension(:    ) :: masses                          , massesLogarithmic              , &
          &                                                                     massesLogarithmicMinimum        , massesLogarithmicMaximum       , &
          &                                                                     massFunction
     double precision                        , allocatable, dimension(:,:  ) :: outputWeight
     ! Arrays for accumulation of of main branch galaxies
     double precision                        , allocatable, dimension(:,:  ) :: mainBranchGalaxyWeights         , mainBranchGalaxyWeightsSquared
     ! Array for the covariance matrix.
     double precision                        , allocatable, dimension(:,:  ) :: massFunctionCovariance
     ! Cosmology conversion factors.
     double precision                        , allocatable, dimension(:    ) :: cosmologyConversionMass         , cosmologyConversionMassFunction
     ! Gravitational lensing transfer matrix.
     double precision                        , allocatable, dimension(:,:,:) :: lensingTransfer
     ! Number of mass bins used as buffer when computing lensing transfer.
     integer                                                                 :: massesBufferCount
     ! Buffered masses.
     double precision                        , allocatable, dimension(:    ) :: massesLogarithmicMaximumBuffered, massesLogarithmicMinimumBuffered
  end type massFunction

  ! Mass functions.
  type(massFunction), allocatable, dimension(:) :: massFunctions

  ! Type for storing temporary mass functions during cumulation.
  type :: massFunctionWork
     double precision, allocatable, dimension(:  ) :: massFunction
     double precision, allocatable, dimension(:,:) :: covariance
  end type massFunctionWork

  ! Work array.
  type(massFunctionWork), allocatable, dimension(:) :: galaxyWork
  !$omp threadprivate(galaxyWork)

  ! Options controlling binning in halo mass.
  integer                     :: analysisMassFunctionCovarianceModel
  integer         , parameter :: analysisMassFunctionCovarianceModelPoisson =1
  integer         , parameter :: analysisMassFunctionCovarianceModelBinomial=2
  integer                     :: analysisMassFunctionsHaloMassBinsCount                 , analysisMassFunctionsHaloMassBinsPerDecade
  double precision            :: analysisMassFunctionsHaloMassMinimum                   , analysisMassFunctionsHaloMassMaximum           , &
       &                         analysisMassFunctionsHaloMassIntervalLogarithmicInverse, analysisMassFunctionsHaloMassMinimumLogarithmic

  ! Options controlling covariance matrix construction.
  double precision            :: analysisMassFunctionsCorrelationTruncateLevel

  ! Options controlling gravitational lensing.
  logical                     :: analysisMassFunctionsApplyGravitationalLensing
  double precision            :: analysisMassFunctionsGravitationalLensingSize

  ! Options controlling cosmology correction.
  logical                     :: analysisMassFunctionsApplyCosmologyConversion
  
  ! Options controlling individual surveys.
  logical                     :: analysisMassFunctionsPRIMUSInternalErrors
  
  ! Initializations for individual mass functions.
  logical                     :: alfalfaHiMassFunctionZ0_00Initialized=.false.

  ! Parameters for individual mass functions.
  double precision            :: alfalfaHiMassFunctionZ0_00MolecularFractionK           , alfalfaHiMassFunctionZ0_00ErrorA               , &
       &                         alfalfaHiMassFunctionZ0_00ErrorB                       , alfalfaHiMassFunctionZ0_00ErrorC               , &
       &                         alfalfaHiMassFunctionZ0_00MolecularFractionfSigma      , alfalfaHiMassFunctionZ0_00MolecularFractionA1  , &
       &                         alfalfaHiMassFunctionZ0_00MolecularFractionAlpha1      , alfalfaHiMassFunctionZ0_00MolecularFractionA2  , &
       &                         alfalfaHiMassFunctionZ0_00MolecularFractionAlpha2      , alfalfaHiMassFunctionZ0_00MolecularFractionBeta, &
       &                         alfalfaHiMassFunctionZ0_00MolecularFractionScatter

  ! Variables used in lensing calculations which must have module scope.
  integer         (c_size_t                 )          :: k
  integer                                              :: i                    , j
  double precision                                     :: redshift
  class           (gravitationalLensingClass), pointer :: gravitationalLensing_
  !$omp threadprivate(i,j,k,redshift,gravitationalLensing_)

contains

  !# <mergerTreeAnalysisTask>
  !#  <unitName>Galacticus_Output_Analysis_Mass_Functions</unitName>
  !# </mergerTreeAnalysisTask>
  subroutine Galacticus_Output_Analysis_Mass_Functions(tree,node,nodeStatus,iOutput,mergerTreeAnalyses)
    !% Construct a mass functions to compare to various observational determinations.
    use, intrinsic :: ISO_C_Binding
    use FGSL
    use Numerical_Integration
    use Galacticus_Nodes
    use Galacticus_Input_Paths
    use IO_HDF5
    use ISO_Varying_String
    use Memory_Management
    use Galactic_Structure_Enclosed_Masses
    use Input_Parameters
    use Galacticus_Output_Times
    use Galacticus_Error
    use Cosmology_Parameters
    use Cosmology_Functions
    use Numerical_Comparison
    use String_Handling
    use Galacticus_Output_Analyses_Cosmology_Scalings
    use Galacticus_Output_Merger_Tree_Data
    use Vectors
    implicit none
    type            (mergerTree                    ), intent(inout)                 :: tree
    type            (treeNode                      ), intent(inout), pointer        :: node
    integer                                         , intent(in   )                 :: nodeStatus
    integer         (c_size_t                      ), intent(in   )                 :: iOutput
    type            (varying_string                ), intent(in   ), dimension(:  ) :: mergerTreeAnalyses
    class           (nodeComponentBasic            )               , pointer        :: basic
    double precision                                , allocatable  , dimension(:  ) :: randomError, randomErrorWeight
    class           (cosmologyFunctionsClass       )               , pointer        :: cosmologyFunctionsModel
    class           (cosmologyParametersClass      )               , pointer        :: cosmologyParametersModel
    double precision                                , parameter                     :: massBufferFactor              =100.0d+0 ! Multiplicative buffer size in mass to add below/above observed masses.
    integer         (c_size_t                      )                                :: jOutput
    integer                                                                         :: currentAnalysis,activeAnalysisCount,haloMassBin,iError
    double precision                                                                :: mass,massLogarithmic,distanceMinimum,distanceMaximum,timeMinimum, &
         &                                                                             timeMaximum,surfaceBrightnessModelSlope,surfaceBrightnessModelOffset,surfaceBrightnessModelScatter
    type            (varying_string                )                                :: parameterName,analysisMassFunctionCovarianceModelText,cosmologyScalingMass,cosmologyScalingMassFunction,message
    type            (cosmologyFunctionsMatterLambda)                                :: cosmologyFunctionsObserved
    type            (cosmologyParametersSimple     )               , pointer        :: cosmologyParametersObserved
    type            (fgsl_function                 )                                :: integrandFunction
    type            (fgsl_integration_workspace    )                                :: integrationWorkspace
    logical                                                                         :: integrationReset

    ! Initialize the module if necessary.
    if (.not.moduleInitialized) then
       !$omp critical(Galacticus_Output_Analysis_Mass_Functions_Initialize)
       if (.not.moduleInitialized) then
          !@ <inputParameter>
          !@   <name>analysisMassFunctionCovarianceModel</name>
          !@   <defaultValue>binomial</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The model to use when constructing the mass function covariance matrix for main branch galaxies.
          !@   </description>
          !@   <type>string</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionCovarianceModel',analysisMassFunctionCovarianceModelText,defaultValue='Poisson')
          select case (char(analysisMassFunctionCovarianceModelText))
          case ( 'Poisson'  )
             analysisMassFunctionCovarianceModel=analysisMassFunctionCovarianceModelPoisson
          case ( 'binomial' )
             analysisMassFunctionCovarianceModel=analysisMassFunctionCovarianceModelBinomial
          case default
             call Galacticus_Error_Report('Galacticus_Output_Analysis_Mass_Functions','unrecognized value for "analysisMassFunctionCovarianceModel" - allowed values are "Poisson", and "binomial"')
          end select
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsHaloMassBinsPerDecade</name>
          !@   <defaultValue>10</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The number of bins per decade of halo mass to use when constructing the mass function covariance matrix for main branch galaxies.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsHaloMassBinsPerDecade',analysisMassFunctionsHaloMassBinsPerDecade,defaultValue=10)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsHaloMassMinimum</name>
          !@   <defaultValue>$10^8M_\odot$</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The minimum halo mass to consider when constructing the mass function covariance matrix for main branch galaxies.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsHaloMassMinimum',analysisMassFunctionsHaloMassMinimum,defaultValue=1.0d8)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsHaloMassMaximum</name>
          !@   <defaultValue>$10^{16}M_\odot$</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The maximum halo mass to consider when constructing the mass function covariance matrix for main branch galaxies.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsHaloMassMaximum',analysisMassFunctionsHaloMassMaximum,defaultValue=1.0d16)
          analysisMassFunctionsHaloMassMinimumLogarithmic=log10(analysisMassFunctionsHaloMassMinimum)
          analysisMassFunctionsHaloMassBinsCount=int(log10(analysisMassFunctionsHaloMassMaximum/analysisMassFunctionsHaloMassMinimum)*dble(analysisMassFunctionsHaloMassBinsPerDecade)+0.5d0)
          analysisMassFunctionsHaloMassIntervalLogarithmicInverse=dble(analysisMassFunctionsHaloMassBinsCount)/log10(analysisMassFunctionsHaloMassMaximum/analysisMassFunctionsHaloMassMinimum)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsCorrelationTruncateLevel</name>
          !@   <defaultValue>0.0</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The correlation below which off-diagonal elements of the covariance matrix are truncated to zero.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsCorrelationTruncateLevel',analysisMassFunctionsCorrelationTruncateLevel,defaultValue=0.0d0)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsApplyCosmologyConversion</name>
          !@   <defaultValue>true</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    If true, apply correction factors from the model to the data cosmological model.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsApplyCosmologyConversion',analysisMassFunctionsApplyCosmologyConversion,defaultValue=.true.)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsApplyGravitationalLensing</name>
          !@   <defaultValue>true</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    If true, apply the effects of gravitational lensing by large-scale structure to mass functions.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsApplyGravitationalLensing',analysisMassFunctionsApplyGravitationalLensing,defaultValue=.true.)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsGravitationalLensingSize</name>
          !@   <defaultValue>0.001~Mpc</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The source size to assume for gravitational lensing calculations.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsGravitationalLensingSize',analysisMassFunctionsGravitationalLensingSize,defaultValue=1.0d-3)
          !@ <inputParameter>
          !@   <name>analysisMassFunctionsPRIMUSInternalErrors</name>
          !@   <defaultValue>true</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The source size to assume for gravitational lensing calculations.
          !@   </description>
          !@   <type>boolean</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('analysisMassFunctionsPRIMUSInternalErrors',analysisMassFunctionsPRIMUSInternalErrors,defaultValue=.true.)
          ! Establish mass mapping functions for mass function descriptors.
          massFunctionDescriptors   ( 1)%mapMass             => Map_Mass_SDSS_Stellar_Mass_Function_Z0_07
          massFunctionDescriptors   ( 4)%mapMass             => Map_Mass_ALFALFA_HI_Mass_Function_Z0_00
          ! Establish mass error functions for mass function descriptors.
          massFunctionDescriptors   ( 4)%randomErrorFunction => Mass_Error_ALFALFA_HI_Mass_Function_Z0_00
          if (analysisMassFunctionsPRIMUSInternalErrors) then
             massFunctionDescriptors( 5)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
             massFunctionDescriptors( 6)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
             massFunctionDescriptors( 7)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
             massFunctionDescriptors( 8)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
             massFunctionDescriptors( 9)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
             massFunctionDescriptors(10)%randomErrorFunction => Mass_Error_PRIMUS_Stellar_Mass_Function
          end if
          ! Establish survey incompletenesses.
          do i=1,massFunctionsSupportedCount
             select case (i)
             case (gamaStellarMassFunction)
                parameterName=trim(massFunctionLabels(i))//'SurfaceBrightnessModelSlope'
                !@ <inputParameter>
                !@   <regEx>(gamaStellarMassFunction)Z[0-9\.]+SurfaceBrightnessModelSlope</regEx>
                !@   <attachedTo>module</attachedTo>
                !@   <defaultValue>-1</defaultValue>
                !@   <description>
                !@     Mass function surface brightness incompleteness model slope.
                !@   </description>
                !@   <type>real</type>
                !@   <cardinality>1</cardinality>
                !@ </inputParameter>
                call Get_Input_Parameter(char(parameterName),surfaceBrightnessModelSlope,defaultValue=-1.0d0)
                parameterName=trim(massFunctionLabels(i))//'SurfaceBrightnessModelOffset'
                !@ <inputParameter>
                !@   <regEx>(gamaStellarMassFunction)Z[0-9\.]+SurfaceBrightnessModelOffset</regEx>
                !@   <attachedTo>module</attachedTo>
                !@   <defaultValue>0</defaultValue>
                !@   <description>
                !@     Mass function surface brightness incompleteness model offset.
                !@   </description>
                !@   <type>real</type>
                !@   <cardinality>1</cardinality>
                !@ </inputParameter>
                call Get_Input_Parameter(char(parameterName),surfaceBrightnessModelOffset,defaultValue=0.0d0)
                parameterName=trim(massFunctionLabels(i))//'SurfaceBrightnessModelScatter'
                !@ <inputParameter>
                !@   <regEx>(gamaStellarMassFunction)Z[0-9\.]+SurfaceBrightnessModelScatter</regEx>
                !@   <attachedTo>module</attachedTo>
                !@   <defaultValue>0</defaultValue>
                !@   <description>
                !@     Mass function surface brightness incompleteness model scatter.
                !@   </description>
                !@   <type>real</type>
                !@   <cardinality>1</cardinality>
                !@ </inputParameter>
                call Get_Input_Parameter(char(parameterName),surfaceBrightnessModelScatter,defaultValue=0.0d0)
                allocate(massFunctionIncompletenessSurfaceBrightness :: massFunctionDescriptors(i)%incompleteness)
                select type (g => massFunctionDescriptors(i)%incompleteness)
                type is ( massFunctionIncompletenessSurfaceBrightness )
                   g=massFunctionIncompletenessSurfaceBrightness(                                                       &
                        &                                        massFunctionDescriptors(i)%surfaceBrightnessLimit    , &
                        &                                        massFunctionDescriptors(i)%surfaceBrightnessZeroPoint, &
                        &                                        surfaceBrightnessModelSlope                          , &
                        &                                        surfaceBrightnessModelOffset                         , &
                        &                                        surfaceBrightnessModelScatter                          &
                        &                                       )
                end select
             case default
                allocate(massFunctionIncompletenessComplete          :: massFunctionDescriptors(i)%incompleteness)
                select type (g => massFunctionDescriptors(i)%incompleteness)
                type is ( massFunctionIncompletenessComplete          )
                   g=massFunctionIncompletenessComplete         ()
                end select
             end select
          end do
          ! Warn on deprecated mass functions.
          if (any(trim(mergerTreeAnalyses) == "sdssStellarMassFunctionZ0.07")) call Galacticus_Warn('WARNING: SDSS z=0.07 stellar mass function support is deprecated in this module - use new on-the-fly-analysis instead')
          if (any(trim(mergerTreeAnalyses) == "alfalfaHiMassFunctionZ0.00"  )) call Galacticus_Warn('WARNING: ALFALFA z=0.0 HI mass function support is deprecated in this module - use new on-the-fly-analysis instead')
          ! Determine how many supported mass functions are requested.
          activeAnalysisCount=0
          do i=1,massFunctionsSupportedCount
             if (any(trim(mergerTreeAnalyses) == trim(massFunctionLabels(i)))) activeAnalysisCount=activeAnalysisCount+1
          end do
          ! Allocate mass function arrays and populate with required data.
          if (activeAnalysisCount <= 0) then
             analysisActive=.false.
          else
             analysisActive=.true.
             cosmologyFunctionsModel  => cosmologyFunctions ()
             cosmologyParametersModel => cosmologyParameters()
             ! Establish survey geometries.
             allocate(surveyGeometryLiWhite2009SDSS      :: massFunctionDescriptors( 1)%geometry)
             allocate(surveyGeometryBernardi2013SDSS     :: massFunctionDescriptors( 2)%geometry)
             allocate(surveyGeometryBaldry2012GAMA       :: massFunctionDescriptors( 3)%geometry)
             allocate(surveyGeometryMartin2010ALFALFA    :: massFunctionDescriptors( 4)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors( 5)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors( 6)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors( 7)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors( 8)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors( 9)%geometry)
             allocate(surveyGeometryMoustakas2013PRIMUS  :: massFunctionDescriptors(10)%geometry)
             allocate(surveyGeometryDavidzon2013VIPERS   :: massFunctionDescriptors(11)%geometry)
             allocate(surveyGeometryDavidzon2013VIPERS   :: massFunctionDescriptors(12)%geometry)
             allocate(surveyGeometryDavidzon2013VIPERS   :: massFunctionDescriptors(13)%geometry)
             allocate(surveyGeometryCaputi2011UKIDSSUDS  :: massFunctionDescriptors(14)%geometry)
             allocate(surveyGeometryCaputi2011UKIDSSUDS  :: massFunctionDescriptors(15)%geometry)
             allocate(surveyGeometryCaputi2011UKIDSSUDS  :: massFunctionDescriptors(16)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(17)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(18)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(19)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(20)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(21)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(22)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(23)%geometry)
             allocate(surveyGeometryTomczak2014ZFOURGE   :: massFunctionDescriptors(24)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(25)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(26)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(27)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(28)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(29)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(30)%geometry)
             allocate(surveyGeometryMuzzin2013ULTRAVISTA :: massFunctionDescriptors(31)%geometry)
             select type (g => massFunctionDescriptors( 1)%geometry)
             type is (surveyGeometryLiWhite2009SDSS    )
                g=surveyGeometryLiWhite2009SDSS     (0.0d0,huge(1.0d0),cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 2)%geometry)
             type is (surveyGeometryBernardi2013SDSS   )
                g=surveyGeometryBernardi2013SDSS    (                                          )
             end select
             select type (g => massFunctionDescriptors( 3)%geometry)
             type is (surveyGeometryBaldry2012GAMA     )
                g=surveyGeometryBaldry2012GAMA      (                  cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 4)%geometry)
             type is (surveyGeometryMartin2010ALFALFA  )
                g=surveyGeometryMartin2010ALFALFA   (                  cosmologyParametersModel)
             end select
             select type (g => massFunctionDescriptors( 5)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (0                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 6)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (1                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 7)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (2                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 8)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (3                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors( 9)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (4                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(10)%geometry)
             type is (surveyGeometryMoustakas2013PRIMUS)
                g=surveyGeometryMoustakas2013PRIMUS (5                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(11)%geometry)
             type is (surveyGeometryDavidzon2013VIPERS )
                g=surveyGeometryDavidzon2013VIPERS  (0                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(12)%geometry)
             type is (surveyGeometryDavidzon2013VIPERS )
                g=surveyGeometryDavidzon2013VIPERS  (1                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(13)%geometry)
             type is (surveyGeometryDavidzon2013VIPERS )
                g=surveyGeometryDavidzon2013VIPERS  (2                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(14)%geometry)
             type is (surveyGeometryCaputi2011UKIDSSUDS)
                g=surveyGeometryCaputi2011UKIDSSUDS (0                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(15)%geometry)
             type is (surveyGeometryCaputi2011UKIDSSUDS)
                g=surveyGeometryCaputi2011UKIDSSUDS (1                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(16)%geometry)
             type is (surveyGeometryCaputi2011UKIDSSUDS)
                g=surveyGeometryCaputi2011UKIDSSUDS (2                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(17)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (0                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(18)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (1                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(19)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (2                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(20)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (3                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(21)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (4                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(22)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (5                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(23)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (6                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(24)%geometry)
             type is (surveyGeometryTomczak2014ZFOURGE)
                g=surveyGeometryTomczak2014ZFOURGE  (7                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(25)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(0                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(26)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(1                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(27)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(2                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(28)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(3                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(29)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(4                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(30)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(5                ,cosmologyFunctionsModel )
             end select
             select type (g => massFunctionDescriptors(31)%geometry)
             type is (surveyGeometryMuzzin2013ULTRAVISTA)
                g=surveyGeometryMuzzin2013ULTRAVISTA(6                ,cosmologyFunctionsModel )
             end select
             ! Initialize analyses.
             currentAnalysis=0
             allocate(massFunctions(activeAnalysisCount))
             do i=1,size(mergerTreeAnalyses)
                do j=1,massFunctionsSupportedCount
                   if (mergerTreeAnalyses(i) == trim(massFunctionLabels(j))) then
                      currentAnalysis=currentAnalysis+1
                      ! Copy the descriptor for this mass function.
                      massFunctions(currentAnalysis)%descriptor => massFunctionDescriptors(j)
                      ! Read parameters of the systematic error model.
                      if (massFunctionDescriptors(j)%systematicCoefficientCount > 0) then
                         allocate(massFunctions(currentAnalysis)%systematicCoefficients(massFunctionDescriptors(j)%systematicCoefficientCount))
                         do k=1,massFunctionDescriptors(j)%systematicCoefficientCount
                            parameterName=trim(massFunctionLabels(j))//'MassSystematic'
                            parameterName=parameterName//(k-1)
                            !@ <inputParameter>
                            !@   <regEx>(sdssStellarMassFunction|bernardiSdssStellarMassFunction|gamaStellarMassFunction|alfalfaHiMassFunction|primusStellarMassFunction|vipersStellarMassFunction|ukidssUdsStellarMassFunction|zfourgeStellarMassFunction|ultravistaStellarMassFunction)Z[0-9\.]+MassSystematic[0-9]+</regEx>
                            !@   <defaultValue>0</defaultValue>
                            !@   <attachedTo>module</attachedTo>
                            !@   <description>
                            !@     Mass function systematic error model parameters.
                            !@   </description>
                            !@   <type>real</type>
                            !@   <cardinality>1</cardinality>
                            !@ </inputParameter>
                            call Get_Input_Parameter(char(parameterName),massFunctions(currentAnalysis)%systematicCoefficients(k),defaultValue=0.0d0)
                         end do
                      end if
                      ! Read parameters of the random error model.
                      if (massFunctionDescriptors(j)%randomCoefficientCount > 0) then
                         allocate(massFunctions(currentAnalysis)%randomCoefficients(massFunctionDescriptors(j)%randomCoefficientCount))
                         do k=1,massFunctionDescriptors(j)%randomCoefficientCount
                            parameterName=trim(massFunctionLabels(j))//'MassRandom'
                            parameterName=parameterName//(k-1)
                            !@ <inputParameter>
                            !@   <regEx>(sdssStellarMassFunction|bernardiSdssStellarMassFunction|gamaStellarMassFunction|alfalfaHiMassFunction|primusStellarMassFunction|vipersStellarMassFunction|ukidssUdsStellarMassFunction|zfourgeStellarMassFunction|ultravistaStellarMassFunction)Z[0-9\.]+MassRandom[0-9]+</regEx>
                            !@   <defaultValue>0.1</defaultValue>
                            !@   <attachedTo>module</attachedTo>
                            !@   <description>
                            !@     Mass function random error model parameters.
                            !@   </description>
                            !@   <type>real</type>
                            !@   <cardinality>1</cardinality>
                            !@ </inputParameter>
                            call Get_Input_Parameter(char(parameterName),massFunctions(currentAnalysis)%randomCoefficients(k),defaultValue=0.0d0)
                         end do
                      end if
                      parameterName=trim(massFunctionLabels(j))//'MassRandomMinimum'
                      !@ <inputParameter>
                      !@   <regEx>(sdssStellarMassFunction|bernardiSdssStellarMassFunction|gamaStellarMassFunction|alfalfaHiMassFunction|primusStellarMassFunction|vipersStellarMassFunction|ukidssUdsStellarMassFunction|zfourgeStellarMassFunction|ultravistaStellarMassFunction)Z[0-9\.]+MassRandomMinimum</regEx>
                      !@   <defaultValue>$10^{-3}$</defaultValue>
                      !@   <attachedTo>module</attachedTo>
                      !@   <description>
                      !@     Mass function random error model minimum error.
                      !@   </description>
                      !@   <type>real</type>
                      !@   <cardinality>1</cardinality>
                      !@ </inputParameter>
                      call Get_Input_Parameter(char(parameterName),massFunctions(currentAnalysis)%randomMinimum,defaultValue=1.0d-3)
                      parameterName=trim(massFunctionLabels(j))//'MassRandomMaximum'
                      !@ <inputParameter>
                      !@   <regEx>(sdssStellarMassFunction|bernardiSdssStellarMassFunction|gamaStellarMassFunction|alfalfaHiMassFunction|primusStellarMassFunction|vipersStellarMassFunction|ukidssUdsStellarMassFunction|zfourgeStellarMassFunction|ultravistaStellarMassFunction)Z[0-9\.]+MassRandomMaximum</regEx>
                      !@   <defaultValue>10</defaultValue>
                      !@   <attachedTo>module</attachedTo>
                      !@   <description>
                      !@     Mass function random error model maximum error.
                      !@   </description>
                      !@   <type>real</type>
                      !@   <cardinality>1</cardinality>
                      !@ </inputParameter>
                      call Get_Input_Parameter(char(parameterName),massFunctions(currentAnalysis)%randomMaximum,defaultValue=10.0d0)
                      ! Read the appropriate observational data definition.
                      allocate(cosmologyParametersObserved)
                      select case (trim(massFunctionLabels(j)))
                      case ('sdssStellarMassFunctionZ0.07')
                         ! SDSS z=0.07 stellar mass function.
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_Li_White_2009.hdf5'             ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('bernardiSdssStellarMassFunctionZ0.07')
                         ! Bernardi SDSS z=0.07 stellar mass function.
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_Bernardi_2013.hdf5'             ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('gamaStellarMassFunctionZ0.03')
                         ! GAMA z=0.03 stellar mass function.
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_GAMA_2012.hdf5'                 ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('alfalfaHiMassFunctionZ0.00')
                         ! ALFALFA z=0.00 HI mass function.
                         call Load_Standard_Mass_Function('data/observations/massFunctionsHI/HI_Mass_Function_ALFALFA_2010.hdf5'                        ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.100'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.00_0.20.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.250'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.20_0.30.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.350'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.30_0.40.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.450'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.40_0.50.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.575'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.50_0.65.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.725'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.65_0.80.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('primusStellarMassFunctionZ0.900'   )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_PRIMUS_z0.80_1.00.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ukidssUdsStellarMassFunctionZ3.250')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_UKIDSS_UDS_2011_z3.0_3.5.hdf5'  ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ukidssUdsStellarMassFunctionZ3.875')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_UKIDSS_UDS_2011_z3.5_4.25.hdf5' ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ukidssUdsStellarMassFunctionZ4.625')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_UKIDSS_UDS_2011_z4.25_5.0.hdf5' ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ0.350'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z0.20_0.50.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ0.625'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z0.50_0.75.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ0.875'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z0.75_1.00.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ1.125'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z1.00_1.25.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ1.375'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z1.25_1.50.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ1.750'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z1.50_2.00.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ2.250'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z2.00_2.50.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('zfourgeStellarMassFunctionZ2.750'  )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ZFOURGE_2014_z2.50_3.00.hdf5'   ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('vipersStellarMassFunctionZ0.55'    )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_VIPERS_2013_z0.55.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('vipersStellarMassFunctionZ0.70'    )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_VIPERS_2013_z0.70.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('vipersStellarMassFunctionZ0.90'    )
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_VIPERS_2013_z0.90.hdf5'         ,massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ0.35')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z0.20_0.50.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ0.75')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z0.50_1.00.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ1.25')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z1.00_1.50.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ1.75')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z1.50_2.00.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ2.25')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z2.00_2.50.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ2.75')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z2.50_3.00.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case ('ultravistaStellarMassFunctionZ3.50')
                         call Load_Standard_Mass_Function('data/observations/massFunctionsStellar/Stellar_Mass_Function_ULTRAVISTA_2013_z3.00_4.00.hdf5',massFunctions(currentAnalysis),cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
                      case default
                         call Galacticus_Error_Report('Galacticus_Output_Analysis_Mass_Functions','unknown mass function "'//trim(massFunctionLabels(j))//'"')
                      end select
                      ! Get cosmological conversion factors.
                      call allocateArray(massFunctions(currentAnalysis)%cosmologyConversionMass        ,[Galacticus_Output_Time_Count()])
                      call allocateArray(massFunctions(currentAnalysis)%cosmologyConversionMassFunction,[Galacticus_Output_Time_Count()])
                      do jOutput=1,Galacticus_Output_Time_Count()
                         redshift=                                                                                      &
                              &   cosmologyFunctionsModel %redshiftFromExpansionFactor(                                 &
                              &    cosmologyFunctionsModel%expansionFactor             (                                &
                              &                                                         Galacticus_Output_Time(jOutput) &
                              &                                                        )                                &
                              &                                                       )
                         if (analysisMassFunctionsApplyCosmologyConversion) then
                            ! Cosmology conversion is requested, compute the necessary factors.
                            call Cosmology_Conversion_Factors(                                                                                                          &
                                 &                            redshift                                                                                               , &
                                 &                            cosmologyFunctionsModel                                                                                , &
                                 &                            cosmologyFunctionsObserved                                                                             , &
                                 &                            cosmologyScalingMass           =cosmologyScalingMass                                                   , &
                                 &                            cosmologyScalingMassFunction   =cosmologyScalingMassFunction                                           , &
                                 &                            cosmologyConversionMass        =massFunctions(currentAnalysis)%cosmologyConversionMass        (jOutput), &
                                 &                            cosmologyConversionMassFunction=massFunctions(currentAnalysis)%cosmologyConversionMassFunction(jOutput)  &
                                 &                           )
                         else
                            ! Cosmology conversion is not requested, set conversion factors to unity.
                            massFunctions(currentAnalysis)%cosmologyConversionMass        (jOutput)=1.0d0
                            massFunctions(currentAnalysis)%cosmologyConversionMassFunction(jOutput)=1.0d0
                         end if
                      end do
                      nullify(cosmologyParametersObserved) 
                      exit
                   end if
                end do
                ! Compute output weights for mass function.
                call allocateArray(massFunctions(currentAnalysis)%outputWeight,[int(massFunctions(currentAnalysis)%massesCount,kind=c_size_t),Galacticus_Output_Time_Count()])
                massFunctions(currentAnalysis)%outputWeight=0.0d0
                do k=1,massFunctions(currentAnalysis)%massesCount
                   do jOutput=1,Galacticus_Output_Time_Count()
                      do j=1,massFunctions(currentAnalysis)%descriptor%geometry%fieldCount()
                         if (jOutput == Galacticus_Output_Time_Count()) then
                            timeMaximum=     Galacticus_Output_Time(jOutput)
                         else
                            timeMaximum=sqrt(Galacticus_Output_Time(jOutput)*Galacticus_Output_Time(jOutput+1))
                         end if
                         if (jOutput ==                              1) then
                            timeMinimum=     Galacticus_Output_Time(jOutput)
                         else
                            timeMinimum=sqrt(Galacticus_Output_Time(jOutput)*Galacticus_Output_Time(jOutput-1))
                         end if
                         distanceMinimum=max(                                                                                                                &
                              &              cosmologyFunctionsModel%distanceComoving(timeMaximum)                                                         , &
                              &              massFunctions(currentAnalysis)%descriptor%geometry%distanceMinimum(massFunctions(currentAnalysis)%masses(k),j)  &
                              &             )
                         distanceMaximum=min(                                                                                                                &
                              &              cosmologyFunctionsModel%distanceComoving(timeMinimum)                                                         , &
                              &              massFunctions(currentAnalysis)%descriptor%geometry%distanceMaximum(massFunctions(currentAnalysis)%masses(k),j)  &
                              &             )
                         massFunctions        (currentAnalysis)%outputWeight                    (k,jOutput)  &
                              & =massFunctions(currentAnalysis)%outputWeight                    (k,jOutput)  &
                              & +massFunctions(currentAnalysis)%descriptor  %geometry%solidAngle(  j      )  &
                              & /3.0d0                                                                       &
                              & *                                                                            &
                              & max(                                                                         &
                              &     +0.0d0                                                                 , &
                              &     +distanceMaximum**3                                                      &
                              &     -distanceMinimum**3                                                      &
                              &    )
                      end do
                   end do
                   where(massFunctions(currentAnalysis)%outputWeight(k,:) < 0.0d0)
                      massFunctions(currentAnalysis)%outputWeight(k,:)=0.0d0
                   end where
                   if (any(massFunctions(currentAnalysis)%outputWeight(k,:) > 0.0d0)) then
                      massFunctions                  (currentAnalysis)%outputWeight(k,:)  &
                           &       =    massFunctions(currentAnalysis)%outputWeight(k,:)  &
                           &       /sum(massFunctions(currentAnalysis)%outputWeight(k,:))
                   else
                      message="mass function '"//trim(massFunctions(currentAnalysis)%descriptor%label)//"' bin "
                      message=message//k//" has zero weights"
                      call Galacticus_Error_Report('Galacticus_Output_Analysis_Mass_Functions',message)
                   end if
                end do
             end do
             ! Construct gravitational lensing transfer matrices.
             do i=1,size(massFunctions)
                if (analysisMassFunctionsApplyGravitationalLensing) then
                   massFunctions(i)%massesBufferCount=                                                                                                                                &
                        & int(                                                                                                                                                        &
                        &     +log10(massBufferFactor)                                                                                                                                &
                        &     /min(                                                                                                                                                   &
                        &          (massFunctions(i)%massesLogarithmicMaximum(                           1)-massFunctions(i)%massesLogarithmicMinimum(                           1)), &
                        &          (massFunctions(i)%massesLogarithmicMaximum(massFunctions(i)%massesCount)-massFunctions(i)%massesLogarithmicMinimum(massFunctions(i)%massesCount))  &
                        &         )                                                                                                                                                   &
                        &    )                                                                                                                                                        &
                        & +1
                   call allocateArray(massFunctions(i)%lensingTransfer                 ,[                                                                                      &
                        &                                                              int(massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount,kind=c_size_t), &
                        &                                                              int(massFunctions(i)%massesCount                                     ,kind=c_size_t), &
                        &                                                              Galacticus_Output_Time_Count()                                                        &
                        &                                                             ]                                                                                      &
                        &          )
                else
                   massFunctions(i)%massesBufferCount=0
                end if
                ! Construct buffered arrays of masses.
                call allocateArray(massFunctions(i)%massesLogarithmicMinimumBuffered,[massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount])
                call allocateArray(massFunctions(i)%massesLogarithmicMaximumBuffered,[massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount])
                if (massFunctions(i)%massesBufferCount > 0) then
                   do j=1,massFunctions(i)%massesBufferCount
                      massFunctions           (i)%massesLogarithmicMinimumBuffered(j                                      )  &
                           & =+massFunctions  (i)%massesLogarithmicMinimum        (                                      1)  &
                           &  +dble                                               (j-(massFunctions(i)%massesBufferCount+1)) &
                           &  *(                                                                                             &
                           &    +massFunctions(i)%massesLogarithmicMinimum        (                                      2)  &
                           &    -massFunctions(i)%massesLogarithmicMinimum        (                                      1)  &
                           &   )
                      massFunctions           (i)%massesLogarithmicMaximumBuffered(j                                      )  &
                           & =+massFunctions  (i)%massesLogarithmicMaximum        (                                      1)  &
                           &  +dble                                               (j-(massFunctions(i)%massesBufferCount+1)) &
                           &  *(                                                                                             &
                           &    +massFunctions(i)%massesLogarithmicMaximum        (                                      2)  &
                           &    -massFunctions(i)%massesLogarithmicMaximum        (                                      1)  &
                           &   )
                   end do
                   do j=massFunctions(i)%massesCount+massFunctions(i)%massesBufferCount+1,massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount
                      massFunctions           (i)%massesLogarithmicMinimumBuffered(j                                                                  ) &
                           & =+massFunctions  (i)%massesLogarithmicMinimum        (   massFunctions(i)%massesCount                                    ) &
                           &  +dble                                               (j-(massFunctions(i)%massesCount+massFunctions(i)%massesBufferCount)) &
                           &  *(                                                                                                                        &
                           &    +massFunctions(i)%massesLogarithmicMinimum        (    massFunctions(i)%massesCount                                   ) &
                           &    -massFunctions(i)%massesLogarithmicMinimum        (    massFunctions(i)%massesCount-1                                 ) &
                           &   )
                      massFunctions           (i)%massesLogarithmicMaximumBuffered(j                                                                  ) &
                           & =+massFunctions  (i)%massesLogarithmicMaximum        (   massFunctions(i)%massesCount                                    ) &
                           &  +dble                                               (j-(massFunctions(i)%massesCount+massFunctions(i)%massesBufferCount)) &
                           &  *(                                                                                                                        &
                           &    +massFunctions(i)%massesLogarithmicMaximum        (   massFunctions(i)%massesCount                                    ) &                           
                           &    -massFunctions(i)%massesLogarithmicMaximum        (   massFunctions(i)%massesCount-1                                  ) &
                           &   )
                   end do
                end if
                do j=1+massFunctions(i)%massesBufferCount,massFunctions(i)%massesCount+massFunctions(i)%massesBufferCount
                   massFunctions         (i)%massesLogarithmicMinimumBuffered(j                                   ) &
                        & =+massFunctions(i)%massesLogarithmicMinimum        (j-massFunctions(i)%massesBufferCount)
                   massFunctions         (i)%massesLogarithmicMaximumBuffered(j                                   ) &
                        & =+massFunctions(i)%massesLogarithmicMaximum        (j-massFunctions(i)%massesBufferCount)
                end do
             end do
             if (analysisMassFunctionsApplyGravitationalLensing) then
                ! Initialize lensing transfer matrices to zero.
                do i=1,size(massFunctions)
                   massFunctions(i)%lensingTransfer=0.0d0
                end do                
                !$omp parallel do private(integrationReset,integrandFunction,integrationWorkspace) schedule (dynamic)
                do jOutput=1,Galacticus_Output_Time_Count()
                   gravitationalLensing_ => gravitationalLensing()
                   redshift=                                                                                      &
                        &   cosmologyFunctionsModel %redshiftFromExpansionFactor(                                 &
                        &    cosmologyFunctionsModel%expansionFactor             (                                &
                        &                                                         Galacticus_Output_Time(jOutput) &
                        &                                                        )                                &
                        &                                                       )
                   do i=1,size(massFunctions)
                      ! If this redshift makes no contribution to this mass function, there's no need to compute lensing transfer
                      ! matrices for it, so simply skip to the next mass function.
                      if (all(massFunctions(i)%outputWeight(:,jOutput) == 0.0d0)) cycle
                      do j=1,size(massFunctions(i)%massesLogarithmicMaximumBuffered)
                         do k=massFunctions(i)%massesBufferCount+1,massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount
                            if (j > 1 .and. k > massFunctions(i)%massesBufferCount+1) then
                               ! Transfer matrix elements are identical along diagonals of the matrix.
                               massFunctions       (i)%lensingTransfer(j  ,k-massFunctions(i)%massesBufferCount  ,jOutput)= &
                                    & massFunctions(i)%lensingTransfer(j-1,k-massFunctions(i)%massesBufferCount-1,jOutput)
                            else
                               integrationReset=.true.                               
                               massFunctions       (i)%lensingTransfer(j  ,k-massFunctions(i)%massesBufferCount  ,jOutput)  &
                                    & =Integrate(                                                                           &
                                    &            massFunctions(i)%massesLogarithmicMinimumBuffered(j)                     , &
                                    &            massFunctions(i)%massesLogarithmicMaximumBuffered(j)                     , &
                                    &            magnificationCDFIntegrand                                                , &
                                    &            integrandFunction                                                        , &
                                    &            integrationWorkspace                                                     , &
                                    &            toleranceRelative=1.0d-3                                                 , &
                                    &            reset=integrationReset                                                     &
                                    &           )                                                                           &
                                    & /(                                                                                    &
                                    &   +massFunctions(i)%massesLogarithmicMaximumBuffered(j)                               &
                                    &   -massFunctions(i)%massesLogarithmicMinimumBuffered(j)                               &
                                    &  )
                               call Integrate_Done(integrandFunction,integrationWorkspace)
                           end if
                         end do
                      end do
                   end do
                end do
                !$omp end parallel do
             end if
          end if
          ! Record that module is initialized.
          moduleInitialized=.true.
       end if
       !$omp end critical(Galacticus_Output_Analysis_Mass_Functions_Initialize)
    end if
    ! Return if this analysis is not active.
    if (.not.analysisActive) return
    ! Return if this is a tree finalization.
    if (nodeStatus == nodeStatusFinal) return
    ! Allocate work arrays.
    if (.not.allocated(galaxyWork)) allocate(galaxyWork(size(massFunctions)))
    ! Iterate over active analyses.
    do i=1,size(massFunctions)
       ! Cycle if this mass function receives no contribution from this output number.
       if (all(massFunctions(i)%outputWeight(:,iOutput) <= 0.0d0)) cycle
       ! Allocate workspace.
       if (.not.allocated(galaxyWork(i)%massFunction)) then
          call allocateArray(galaxyWork(i)%massFunction,[massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount])
          call allocateArray(galaxyWork(i)%covariance  ,[                                                                   &
               &                                       massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount, &
               &                                       massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount  &
               &                                      ]                                                                   &
               &          )
       end if
       ! Get the galactic mass.
       mass=                                                                                                                                            &
            &  Galactic_Structure_Enclosed_Mass(node,radiusLarge,componentType=componentTypeDisk    ,massType=massFunctions(i)%descriptor%massType) &
            & +Galactic_Structure_Enclosed_Mass(node,radiusLarge,componentType=componentTypeSpheroid,massType=massFunctions(i)%descriptor%massType)
       if (mass <= 0.0d0) cycle
       if (associated(massFunctions(i)%descriptor%mapMass)) mass=massFunctions(i)%descriptor%mapMass(mass,node)
       if (mass <= 0.0d0) cycle
       mass=mass*massFunctions(i)%cosmologyConversionMass(iOutput) ! Convert for cosmology.
       massLogarithmic=log10(mass)
       do j=1,massFunctions(i)%descriptor%systematicCoefficientCount
          massLogarithmic=massLogarithmic+massFunctions(i)%systematicCoefficients(j)*(log10(mass)-massFunctions(i)%descriptor%errorModelLogM0)**(j-1)
       end do
       if (massLogarithmic <  massFunctions(i)%descriptor%massLogarithmicMinimum) cycle
       ! Compute contributions to each bin.
       if (associated(massFunctions(i)%descriptor%randomErrorFunction)) then
          call massFunctions(i)%descriptor%randomErrorFunction(mass,node,randomError,randomErrorWeight)
       else
          allocate(randomError      (1))
          allocate(randomErrorWeight(1))
          randomError(1)=0.0d0
          do j=1,massFunctions(i)%descriptor%randomCoefficientCount
             randomError(1)=+randomError(1)                                &
                  &         +massFunctions(i)%randomCoefficients(j)        &
                  &         *(                                             &
                  &           +log10(mass)                                 &
                  &           -massFunctions(i)%descriptor%errorModelLogM0 &
                  &          )**(j-1)
          end do
          randomError      (1)=max(                                    &
               &                   min(                                &
               &                       randomError(1)                , &
               &                       massFunctions(i)%randomMaximum  &
               &                      )                              , &
               &                       massFunctions(i)%randomMinimum  &
               &                  )
          randomErrorWeight(1)=1.0d0
       end if
       galaxyWork(i)%massFunction=0.0d0
       do iError=1,size(randomError)
          galaxyWork        (i)%massFunction=                                                                                &
               & +galaxyWork(i)%massFunction                                                                                 &
               & +randomErrorWeight(iError)                                                                                  &
               & *(                                                                                                          &
               &   +erf((massFunctions(i)%massesLogarithmicMaximumBuffered-massLogarithmic)/randomError(iError)/sqrt(2.0d0)) &
               &   -erf((massFunctions(i)%massesLogarithmicMinimumBuffered-massLogarithmic)/randomError(iError)/sqrt(2.0d0)) &
               &  )
       end do
       deallocate(randomError      )
       deallocate(randomErrorWeight)
       ! Check for empty mass function.
       if (all(galaxyWork(i)%massFunction == 0.0d0)) cycle
       ! Perform cosmology conversion and incompleteness correction.
       galaxyWork        (i)%massFunction=                                          &
            & +galaxyWork(i)%massFunction                                           &
            & /2.0d0                                                                &
            & *tree%volumeWeight                                                &
            & *massFunctions(i)           %cosmologyConversionMassFunction(iOutput) &
            & *massFunctions(i)%descriptor%incompleteness%completeness    (mass   )
       ! Convolve the galaxy's contribution to the mass function with the gravitational lensing
       ! transfer matrix.
       if (analysisMassFunctionsApplyGravitationalLensing)                                                                                     &
            & galaxyWork(i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount) &
            &  =matmul(galaxyWork(i)%massFunction,massFunctions(i)%lensingTransfer(:,:,iOutput))
       ! Apply output weights.
       galaxyWork           (i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount        ) &
            & =galaxyWork   (i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount        ) &
            & *massFunctions(i)%outputWeight(                                    :                                                               ,iOutput)     
       ! Accumulate mass function.
       !$omp critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
       massFunctions(i)%massFunction                                                                                                                       &
            & =massFunctions(i)%massFunction                                                                                                               &
            & +galaxyWork   (i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount)
       !$omp end critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
       ! Treat main branch and other galaxies differently.
       if (node%isOnMainBranch().and.analysisMassFunctionCovarianceModel == analysisMassFunctionCovarianceModelBinomial) then
          ! Find the bin to which this halo mass belongs.
          basic => node%basic()
          haloMassBin=floor((log10(basic%mass())-analysisMassFunctionsHaloMassMinimumLogarithmic)*analysisMassFunctionsHaloMassIntervalLogarithmicInverse)+1
          ! Accumulate weights to halo mass arrays.
          if (haloMassBin >= 1 .and. haloMassBin <= analysisMassFunctionsHaloMassBinsCount) then
             !$omp critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
             massFunctions        (i)%mainBranchGalaxyWeights       (:,haloMassBin)= &
                  &  massFunctions(i)%mainBranchGalaxyWeights       (:,haloMassBin)  &
                  &  +galaxyWork  (i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount)
             massFunctions        (i)%mainBranchGalaxyWeightsSquared(:,haloMassBin)= &
                  &  massFunctions(i)%mainBranchGalaxyWeightsSquared(:,haloMassBin)  &
                  &  +galaxyWork  (i)%massFunction(massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount)**2
             !$omp end critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
          end if
       else
          forall(j=1:massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount)
             forall(k=j:massFunctions(i)%massesCount+2*massFunctions(i)%massesBufferCount)
                galaxyWork(i)%covariance(j,k)=galaxyWork(i)%massFunction(j)*galaxyWork(i)%massFunction(k)
                galaxyWork(i)%covariance(k,j)=galaxyWork(i)%covariance(j,k)
             end forall
          end forall
          ! Accumulate covariance.
          !$omp critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
          massFunctions        (i)%massFunctionCovariance                                                                                           &
               & =massFunctions(i)%massFunctionCovariance                                                                                           &
               & +galaxyWork   (i)%covariance(                                                                                                      &
               &                              massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount, &
               &                              massFunctions(i)%massesBufferCount+1:massFunctions(i)%massesBufferCount+massFunctions(i)%massesCount  &
               &                             )
          !$omp end critical (Galacticus_Output_Analysis_Mass_Functions_Accumulate)
       end if
    end do
    return

  contains

    double precision function magnificationCDFIntegrand(logMass)
      !% Integrand over the gravitational lensing magnification cumulative distribution.
      implicit none
      double precision, intent(in   ) :: logMass
      
      magnificationCDFIntegrand=                                                                                         &
           & max(                                                                                                        &
           &     +0.0d0                                                                                                , &
           &     +gravitationalLensing_%magnificationCDF(                                                                &
           &                                             10.0d0**(                                                       &
           &                                                      +massFunctions(i)%massesLogarithmicMaximumBuffered(k)  &
           &                                                      -logMass                                               &
           &                                                     )                                                     , &
           &                                             redshift                                                      , &
           &                                             analysisMassFunctionsGravitationalLensingSize                   &
           &                                            )                                                                &
           &     -gravitationalLensing_%magnificationCDF(                                                                &
           &                                             10.0d0**(                                                       &
           &                                                      +massFunctions(i)%massesLogarithmicMinimumBuffered(k)  &
           &                                                      -logMass                                               &
           &                                                     )                                                     , &
           &                                             redshift                                                      , &
           &                                             analysisMassFunctionsGravitationalLensingSize                   &
           &                                            )                                                                &
           &    )
      return
    end function magnificationCDFIntegrand
    
  end subroutine Galacticus_Output_Analysis_Mass_Functions
  
  !# <hdfPreCloseTask>
  !#  <unitName>Galacticus_Output_Analysis_Mass_Functions_Output</unitName>
  !# </hdfPreCloseTask>
  subroutine Galacticus_Output_Analysis_Mass_Functions_Output
    !% Outputs galaxy mass functions to file.
    use Galacticus_HDF5
    use Numerical_Constants_Astronomical
    implicit none
    integer                      :: i,j,k,m
    type            (hdf5Object) :: analysisGroup,massFunctionGroup,dataset
    double precision             :: haloWeightBinTotal

    ! Return immediately if this analysis is not active.
    if (.not.analysisActive) return
    ! Iterate over mass functions.
    do k=1,size(massFunctions)
       ! Add the contribution from main branch galaxies to the covariance matrix.
       if (analysisMassFunctionCovarianceModel == analysisMassFunctionCovarianceModelBinomial) then
          do m=1,analysisMassFunctionsHaloMassBinsCount
             haloWeightBinTotal=sum(massFunctions(k)%mainBranchGalaxyWeights(:,m))
             if ( haloWeightBinTotal > 0.0 ) then
                do i=1,massFunctions(k)%massesCount
                   massFunctions               (k)%massFunctionCovariance        (i,i)=                    &
                        &         massFunctions(k)%massFunctionCovariance        (i,i)                     &
                        & +(1.0d0-massFunctions(k)%mainBranchGalaxyWeights       (i,m)/haloWeightBinTotal) &
                        & *       massFunctions(k)%mainBranchGalaxyWeightsSquared(i,m)
                   do j=1,massFunctions(k)%massesCount
                      if (i == j) cycle
                      massFunctions               (k)%massFunctionCovariance        (i,j)= &
                           &  +      massFunctions(k)%massFunctionCovariance        (i,j)  &
                           &  -      massFunctions(k)%mainBranchGalaxyWeights       (i,m)  &
                           &  *      massFunctions(k)%mainBranchGalaxyWeights       (j,m)  &
                           &  *sqrt(                                                       &
                           &         massFunctions(k)%mainBranchGalaxyWeightsSquared(i,m)  &
                           &        *massFunctions(k)%mainBranchGalaxyWeightsSquared(j,m)  &
                           &       )                                                       &
                           &  /haloWeightBinTotal
                   end do
                end do
             end if
          end do
       end if
       ! Truncate the covariance where the correlation is below threshold. This avoids creating noisy covariances matrices
       ! which can lead to discontinuities in the likelihood surface.
       do i=1,massFunctions(k)%massesCount
          do j=1,massFunctions(k)%massesCount
             if (i == j) cycle
             if     (                                                           &
                  &     abs( massFunctions(k)%massFunctionCovariance(i,j))      &
                  &  <                                                          &
                  &    analysisMassFunctionsCorrelationTruncateLevel            &
                  &   *sqrt(                                                    &
                  &         max(                                                &
                  &              0.0d0                                       ,  &
                  &              massFunctions(k)%massFunctionCovariance(i,i)   &
                  &             *massFunctions(k)%massFunctionCovariance(j,j)   &
                  &            )                                                &
                  &        )                                                    &
                  & )        massFunctions(k)%massFunctionCovariance(i,j)=0.0d0
          end do
       end do
       ! Convert model mass function to differential per log(M).
       forall(i=1:massFunctions(k)%massesCount)
          massFunctions(k)%massFunction             (i  )=  massFunctions(k)%massFunction          (i  )                              &
               &                         /(massFunctions(k)%massesLogarithmicMaximum(i)-massFunctions(k)%massesLogarithmicMinimum(i)) &
               &                         / log(10.0d0)
          forall(j=1:massFunctions(k)%massesCount)
             massFunctions(k)%massFunctionCovariance(i,j)=  massFunctions(k)%massFunctionCovariance(i,j)                              &
                  &                      /(massFunctions(k)%massesLogarithmicMaximum(i)-massFunctions(k)%massesLogarithmicMinimum(i)) &
                  &                      /(massFunctions(k)%massesLogarithmicMaximum(j)-massFunctions(k)%massesLogarithmicMinimum(j)) &
                  &                      / log(10.0d0)**2
          end forall
       end forall
       ! Output the mass function.
       !$omp critical(HDF5_Access)
       analysisGroup    =galacticusOutputFile%openGroup('analysis','Model analysis')
       massFunctionGroup=analysisGroup       %openGroup(trim(massFunctions(k)%descriptor%label),trim(massFunctions(k)%descriptor%comment))
       call massFunctionGroup%writeDataset  (massFunctions(k)%masses                ,'mass'                  ,'Mass'                    ,datasetReturned=dataset)
       call dataset          %writeAttribute(massSolar             ,'unitsInSI'                                                                                 )
       call dataset          %close()
       call massFunctionGroup%writeDataset  (massFunctions(k)%massFunction          ,'massFunction'          ,'Mass function'           ,datasetReturned=dataset)
       call dataset          %writeAttribute(1.0d0/megaParsec**3   ,'unitsInSI'                                                                                 )
       call dataset          %close()
       call massFunctionGroup%writeDataset  (massFunctions(k)%massFunctionCovariance,'massFunctionCovariance','Mass function covariance',datasetReturned=dataset)
       call dataset          %writeAttribute(1.0d0/megaParsec**6   ,'unitsInSI'                                                                                 )
       call dataset          %close()
       call massFunctionGroup%close()
       call analysisGroup    %close()
       !$omp end critical(HDF5_Access)
    end do
    return
  end subroutine Galacticus_Output_Analysis_Mass_Functions_Output

  double precision function Map_Mass_SDSS_Stellar_Mass_Function_Z0_07(mass,node)
    !% Account for systematics in SDSS photometry for high-mass galaxies.
    use Input_Parameters
    implicit none                                                                                 
    double precision          , intent(in   )          :: mass
    type            (treeNode), intent(inout), pointer :: node
    logical                   , save                   :: sdssStellarMassFunctionHighMassInitialized      =.false.
    double precision          , save                   :: sdssStellarMassFunctionHighMassTransitionLogMass        , &
         &                                                sdssStellarMassFunctionHighMassTransitionWidth          , &
         &                                                sdssStellarMassFunctionHighMassSystematic0              , &
         &                                                sdssStellarMassFunctionHighMassSystematic1
    double precision          , parameter              :: exponentialArgumentMaximum                      =100.0d0
    double precision                                   :: massLogarithmic                                         , &
         &                                                exponentialArgument
    !GCC$ attributes unused :: node
    
    if (.not.sdssStellarMassFunctionHighMassInitialized) then
       !$omp critical(Map_Mass_SDSS_Stellar_Mass_Function_Z0_07_Initialize)
       if (.not.sdssStellarMassFunctionHighMassInitialized) then
          !@ <inputParameter>
          !@   <name>sdssStellarMassFunctionHighMassTransitionLogMass</name>
          !@   <defaultValue>10.8</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    Transition mass, $M_{\mathrm t}$, in the high-mass stellar mass systematic parameterization for the SDSS stellar mass function: $\log_{10}(M_\star/M_{\mathrm t}) \rightarrow \log_{10}(M_\star/M_{\mathrm t}) + [\mu+\kappa\ log_{10}(M_\star/M_{\mathrm t})]/[1+\exp(-\log_{10}(M_\star/M_{\mathrm t})/\Delta\log_{10}M_{\mathrm t})]$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('sdssStellarMassFunctionHighMassTransitionLogMass',sdssStellarMassFunctionHighMassTransitionLogMass,defaultValue=10.8d0)
          !@ <inputParameter>
          !@   <name>sdssStellarMassFunctionHighMassTransitionWidth</name>
          !@   <defaultValue>0.5</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    Transition mass width, $\Delta M_{\mathrm t}$, in the high-mass stellar mass systematic parameterization for the SDSS stellar mass function: $\log_{10}(M_\star/M_{\mathrm t}) \rightarrow \log_{10}(M_\star/M_{\mathrm t}) + [\mu+\kappa\ log_{10}(M_\star/M_{\mathrm t})]/[1+\exp(-\log_{10}(M_\star/M_{\mathrm t})/\Delta\log_{10}M_{\mathrm t})]$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('sdssStellarMassFunctionHighMassTransitionWidth',sdssStellarMassFunctionHighMassTransitionWidth,defaultValue=0.5d0)
          !@ <inputParameter>
          !@   <name>sdssStellarMassFunctionHighMassSystematic0</name>
          !@   <defaultValue>0</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    Parameter $\mu$ in the high-mass stellar mass systematic parameterization for the SDSS stellar mass function: $\log_{10}(M_\star/M_{\mathrm t}) \rightarrow \log_{10}(M_\star/M_{\mathrm t}) + [\mu+\kappa\ log_{10}(M_\star/M_{\mathrm t})]/[1+\exp(-\log_{10}(M_\star/M_{\mathrm t})/\Delta\log_{10}M_{\mathrm t})]$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('sdssStellarMassFunctionHighMassSystematic0',sdssStellarMassFunctionHighMassSystematic0,defaultValue=0.0d0)
          !@ <inputParameter>
          !@   <name>sdssStellarMassFunctionHighMassSystematic1</name>
          !@   <defaultValue>0</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    Parameter $\kappa$ in the high-mass stellar mass systematic parameterization for the SDSS stellar mass function: $\log_{10}(M_\star/M_{\mathrm t}) \rightarrow \log_{10}(M_\star/M_{\mathrm t}) + [\mu+\kappa\ log_{10}(M_\star/M_{\mathrm t})]/[1+\exp(-\log_{10}(M_\star/M_{\mathrm t})/\Delta\log_{10}M_{\mathrm t})]$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('sdssStellarMassFunctionHighMassSystematic1',sdssStellarMassFunctionHighMassSystematic1,defaultValue=0.0d0)
          ! Record that initialization is complete.
          sdssStellarMassFunctionHighMassInitialized=.true.
       end if
       !$omp end critical(Map_Mass_SDSS_Stellar_Mass_Function_Z0_07_Initialize)
    end if
    massLogarithmic    =+log10(mass)&
         &              -sdssStellarMassFunctionHighMassTransitionLogMass
    exponentialArgument=-massLogarithmic                                   &
         &              /sdssStellarMassFunctionHighMassTransitionWidth
    if (exponentialArgument < exponentialArgumentMaximum)                         &
         & massLogarithmic=+massLogarithmic                                       &
         &                 +(                                                     &
         &                   +sdssStellarMassFunctionHighMassSystematic0          &
         &                   +sdssStellarMassFunctionHighMassSystematic1          &
         &                   *massLogarithmic                                     &
         &                  )                                                     &
         &                 /(                                                     &
         &                   +1.0d0                                               &
         &                   +exp(                                                &
         &                        -massLogarithmic                                &
         &                        /sdssStellarMassFunctionHighMassTransitionWidth &
         &                       )                                                &
         &                  )
    Map_Mass_SDSS_Stellar_Mass_Function_Z0_07=10.0d0**(massLogarithmic+sdssStellarMassFunctionHighMassTransitionLogMass)
    return
  end function Map_Mass_SDSS_Stellar_Mass_Function_Z0_07

  subroutine ALFALFA_HI_Mass_Function_Z0_00_Initialize()
    !% Initializes the ALFALFA HI mass function calculation by reading in required parameters.
    use Input_Parameters
    implicit none

    ! Initialize the mass function if necessary.
    if (.not.alfalfaHiMassFunctionZ0_00Initialized) then
       !$omp critical(alfalfaHiMassFunctionZ0_00Initialized)
       if (.not.alfalfaHiMassFunctionZ0_00Initialized) then
          ! Read parameters controlling H2/HI mass ratio calculation.
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00ErrorA</name>
          !@   <defaultValue>0.1</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $a$, appearing in the model for the HI mass random errors used when constructing the ALFALFA HI mass function. Specifically, $\sigma_{\mathrm obs} = a + \exp\left(-{\log_{10}(M_{\mathrm HI}/M_\odot)-b\over c}\right)$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00ErrorA',alfalfaHiMassFunctionZ0_00ErrorA,defaultValue=0.1d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00ErrorB</name>
          !@   <defaultValue>5.885</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $b$, appearing in the model for the HI mass random errors used when constructing the ALFALFA HI mass function. Specifically, $\sigma_{\mathrm obs} = a + \exp\left(-{\log_{10}(M_{\mathrm HI}/M_\odot)-b\over c}\right)$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00ErrorB',alfalfaHiMassFunctionZ0_00ErrorB,defaultValue=5.885d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00ErrorC</name>
          !@   <defaultValue>0.505</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $c$, appearing in the model for the HI mass random errors used when constructing the ALFALFA HI mass function. Specifically, $\sigma_{\mathrm obs} = a + \exp\left(-{\log_{10}(M_{\mathrm HI}/M_\odot)-b\over c}\right)$.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00ErrorC',alfalfaHiMassFunctionZ0_00ErrorC,defaultValue=0.505d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionK</name>
          !@   <defaultValue>11.3 m$^4$ kg$^{-2}$ \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $K$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionK',alfalfaHiMassFunctionZ0_00MolecularFractionK,defaultValue=11.3d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionfSigma</name>
          !@   <defaultValue>0.4 \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $\langle f_\sigma \rangle$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionfSigma',alfalfaHiMassFunctionZ0_00MolecularFractionfSigma,defaultValue=0.4d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionA1</name>
          !@   <defaultValue>3.44 \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $A_1$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionA1',alfalfaHiMassFunctionZ0_00MolecularFractionA1,defaultValue=3.44d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionA2</name>
          !@   <defaultValue>4.82 \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $A_2$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionA2',alfalfaHiMassFunctionZ0_00MolecularFractionA2,defaultValue=4.82d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionAlpha1</name>
          !@   <defaultValue>$-0.506$ \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $\alpha_1$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionAlpha1',alfalfaHiMassFunctionZ0_00MolecularFractionAlpha1,defaultValue=-0.506d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionAlpha2</name>
          !@   <defaultValue>$-1.054$ \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $\alpha_2$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionAlpha2',alfalfaHiMassFunctionZ0_00MolecularFractionAlpha2,defaultValue=-1.054d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionBeta</name>
          !@   <defaultValue>$0.8$ \citep{obreschkow_simulation_2009}</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The parameter, $\beta$, appearing in the model for the H$_2$/HI ratio in galaxies from \cite{obreschkow_simulation_2009}.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionBeta',alfalfaHiMassFunctionZ0_00MolecularFractionBeta,defaultValue=0.8d0)
          !@ <inputParameter>
          !@   <name>alfalfaHiMassFunctionZ0.00MolecularFractionScatter</name>
          !@   <defaultValue>$0.4$~dex (Obsreschkow, private communication)</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@    The scatter in the molecular ratio $\log_{10}R_{\mathrm mol}$ of \cite{obreschkow_simulation_2009} compared to observational data.
          !@   </description>
          !@   <type>real</type>
          !@   <cardinality>0..1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('alfalfaHiMassFunctionZ0.00MolecularFractionScatter',alfalfaHiMassFunctionZ0_00MolecularFractionScatter,defaultValue=0.4d0)
          ! Record that the function is now initialized.
          alfalfaHiMassFunctionZ0_00Initialized=.true.
       end if
       !$omp end critical(alfalfaHiMassFunctionZ0_00Initialized)
    end if
    return
  end subroutine ALFALFA_HI_Mass_Function_Z0_00_Initialize

  subroutine Mass_Error_ALFALFA_HI_Mass_Function_Z0_00(mass,node,error,weight)
    !% Computes errors on $\log_{10}($HI masses$)$ for the ALFALFA survey analysis. Uses a simple fitting function. See {\tt
    !% constraints/dataAnalysis/hiMassFunction\_ALFALFA\_z0.00/alfalfaHIMassErrorModel.pl} for details.
    double precision          , intent(in   )                            :: mass
    type            (treeNode), intent(inout), pointer                   :: node
    double precision          , intent(inout), allocatable, dimension(:) :: error          , weight
    double precision                                                     :: logarithmicMass, molecularFraction  , &
         &                                                                  exponentialTerm, exponentialArgument

    ! Initialize the mass function.
    call ALFALFA_HI_Mass_Function_Z0_00_Initialize()
    ! Get the logarithmic mass.
    logarithmicMass=log10(mass)
    ! Allocate arrays.
    allocate(error (1))
    allocate(weight(1))
    ! Compute the random error on the mass.
    exponentialArgument=+(                                  &
         &                +max(logarithmicMass,6.0d0)       &
         &                -alfalfaHiMassFunctionZ0_00ErrorB &
         &               )                                  &
         &              /  alfalfaHiMassFunctionZ0_00ErrorC
    if (exponentialArgument > 0.0d0) then
       exponentialTerm=exp(-exponentialArgument)
    else
       exponentialTerm=0.0d0
    end if
    error  =[                                  &
         &   +alfalfaHiMassFunctionZ0_00ErrorA &
         &   +exponentialTerm                  &
         &  ]
    ! Add in quadrature a term accounting for the scatter in the molecular ratio model.
    molecularFraction=Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00(mass,node)
    error  =[                                                              &
         &   sqrt(                                                         &
         &        +error                                               **2 &
         &        +(                                                       &
         &          +alfalfaHiMassFunctionZ0_00MolecularFractionScatter    &
         &          *molecularFraction                                     &
         &          /(                                                     &
         &            +1.0                                                 &
         &            +molecularFraction                                   &
         &           )                                                     &
         &         )                                                   **2 &
         &       )                                                         &
         &  ]
    weight=[1.0d0]
    return
  end subroutine Mass_Error_ALFALFA_HI_Mass_Function_Z0_00

  double precision function Map_Mass_ALFALFA_HI_Mass_Function_Z0_00(mass,node)
    !% Maps gas masses into HI masses for the ALFALFA survey analysis.
    use Numerical_Constants_Astronomical
    implicit none                                                                                 
    double precision          , intent(in   )          :: mass
    type            (treeNode), intent(inout), pointer :: node
    double precision                                   :: molecularRatio

    ! Compute the HI mass.
    molecularRatio=Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00(mass,node)
    Map_Mass_ALFALFA_HI_Mass_Function_Z0_00=hydrogenByMassPrimordial*mass/(1.0d0+molecularRatio)
    return
  end function Map_Mass_ALFALFA_HI_Mass_Function_Z0_00

  double precision function Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00(mass,node)
    !% Compute the molecular ratio, $R_{\mathrm mol}=M_{\mathrm H_2}/M_{\mathrm HI}$ for the ALFALFA survey analysis. Assumes the model of
    !% \cite{obreschkow_simulation_2009}.
    use Numerical_Constants_Astronomical
    implicit none
    double precision                   , intent(in   )          :: mass
    type            (treeNode         ), intent(inout), pointer :: node
    class           (nodeComponentDisk)               , pointer :: disk
    double precision                                            :: massStellar, molecularRatioCentral, &
         &                                                         diskRadius

    ! Initialize the mass function.
    call ALFALFA_HI_Mass_Function_Z0_00_Initialize()
    ! Get disk properties.
    disk        => node%disk       ()
    massStellar =  disk%massStellar()
    diskRadius  =  disk%radius     ()
    ! Get the molecular to atomic mass ratio (H2/HI).
    if (diskRadius <= 0.0d0 .or. massStellar < 0.0d0) then
       Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00=1.0d0
    else
       molecularRatioCentral                                         &
            & =(                                                     &
            &   massSolar  **2                                       &
            &   /megaParsec**4                                       &
            &   *alfalfaHiMassFunctionZ0_00MolecularFractionK        &
            &   *mass                                                &
            &   *(                                                   &
            &     +mass                                              &
            &     +alfalfaHiMassFunctionZ0_00MolecularFractionfSigma &
            &     *massStellar                                       &
            &    )                                                   &
            &   /diskRadius**4                                       &
            &  )**alfalfaHiMassFunctionZ0_00MolecularFractionBeta       
       if (molecularRatioCentral > 0.0d0) then
          Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00                                      &
               & = 1.0d0                                                                      &
               &  /(                                                                          &
               &    +                       alfalfaHiMassFunctionZ0_00MolecularFractionA1     &
               &    *molecularRatioCentral**alfalfaHiMassFunctionZ0_00MolecularFractionAlpha1 &
               &    +                       alfalfaHiMassFunctionZ0_00MolecularFractionA2     &
               &    *molecularRatioCentral**alfalfaHiMassFunctionZ0_00MolecularFractionAlpha2 &
               &   )
       else
          Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00=0.0d0
       end if
    end if
    return
  end function Molecular_Ratio_ALFALFA_HI_Mass_Function_Z0_00

  subroutine Mass_Error_PRIMUS_Stellar_Mass_Function(mass,node,error,weight)
    !% Computes errors on $\log_{10}($HI masses$)$ for the PRIMUS survey analysis. Uses a simple fitting function. See {\tt
    !% constraints/dataAnalysis/stellarMassFunctions\_PRIMUS\_z0\_1/massErrors.pl} for details.
    use Cosmology_Functions
    use Geometry_Surveys
    use Memory_Management
    double precision                                   , intent(in   )                            :: mass
    type            (treeNode                         ), intent(inout), pointer                   :: node
    double precision                                   , intent(inout), allocatable, dimension(:) :: error                  , weight
    class           (cosmologyFunctionsClass          )               , pointer                   :: cosmologyFunctions_
    class           (nodeComponentBasic               )               , pointer                   :: basic
    double precision                                   , save         , allocatable, dimension(:) :: fieldWeight
    logical                                            , save                                     :: weightsComputed=.false.
    type            (surveyGeometryMoustakas2013PRIMUS)                                           :: primusGeometry
    double precision                                                                              :: logMass                , redshift
    integer                                                                                       :: i

    ! Get cosmology functions.
    cosmologyFunctions_ => cosmologyFunctions()
    ! Compute field weights if necessary.
    if (.not.weightsComputed) then
       !$omp critical(Mass_Error_PRIMUS_Stellar_Mass_Function_Weights)
       if (.not.weightsComputed) then
          primusGeometry=surveyGeometryMoustakas2013PRIMUS(1,cosmologyFunctions_) ! Choice of redshift bin is irrelevant.
          call allocateArray(fieldWeight,[primusGeometry%fieldCount()])
          do i=1,primusGeometry%fieldCount()
             fieldWeight(i)=primusGeometry%solidAngle(i)
          end do
          fieldWeight=fieldWeight/sum(fieldWeight)
          weightsComputed=.true.
       end if
       !$omp end critical(Mass_Error_PRIMUS_Stellar_Mass_Function_Weights)
    end if
    allocate(weight(size(fieldWeight)))
    weight=fieldWeight
    ! Get the logarithmic mass.
    logMass=log10(mass)
    ! Get the redshift.
    basic   => node%basic()
    redshift=                                                             &
         & cosmologyFunctions_ %redshiftFromExpansionFactor(              &
         &  cosmologyFunctions_%expansionFactor             (             &
         &                                                   basic%time() &
         &                                                  )             &
         &                                                 )
    ! Construct the error.
    allocate(error(size(fieldWeight)))
    ! Error fit for field: COSMOS
    error(1)=                                               &
         &         +1.5408331474d+00                        & 
         &         -3.0862470668d-01*logMass                & 
         &         +1.6386341188d-02*logMass**2             & 
         &         +6.6730907511d-01           *redshift    & 
         &         +1.2910914131d-02           *redshift**2 & 
         &         -6.5422174133d-02*logMass   *redshift   
    ! Error fit for field: XMM SWIRE
    error(2)=                                               &
         &         +6.5749450323d-01                        & 
         &         -1.2700597550d-01*logMass                & 
         &         +7.0170711038d-03*logMass**2             & 
         &         +1.1004961194d+00           *redshift    & 
         &         +6.4444325755d-02           *redshift**2 & 
         &         -1.0633185399d-01*logMass   *redshift   
    ! Error fit for field: CFHTLS XMM
    error(3)=                                               &
         &         +6.5617804489d-01                        & 
         &         -1.3687850750d-01*logMass                & 
         &         +7.9296191201d-03*logMass**2             & 
         &         +1.3265419613d+00           *redshift    & 
         &         +3.7037540565d-02           *redshift**2 & 
         &         -1.2542249190d-01*logMass   *redshift   
    ! Error fit for field: CDFS
    error(4)=                                               &
         &         +5.0589188523d-01                        & 
         &         -8.5750577282d-02*logMass                & 
         &         +4.5807730791d-03*logMass**2             & 
         &         +4.4141174030d-01           *redshift    & 
         &         -1.5175562395d-03           *redshift**2 & 
         &         -4.3083336387d-02*logMass   *redshift   
    ! Error fit for field: ES1
    error(5)=                                               &
         &         -8.7735711466d-02                        & 
         &         +2.9224161609d-02*logMass                & 
         &         -1.0127922335d-03*logMass**2             & 
         &         +4.9742949168d-01           *redshift    & 
         &         +2.5992450654d-02           *redshift**2 & 
         &         -4.9465314863d-02*logMass   *redshift   
    return
  end subroutine Mass_Error_PRIMUS_Stellar_Mass_Function

  subroutine Load_Standard_Mass_Function(massFunctionFileName,massFunction_,cosmologyParametersObserved,cosmologyFunctionsObserved,cosmologyScalingMass,cosmologyScalingMassFunction)
    !% Load the specified standard-format mass function from file.
    use ISO_Varying_String
    use Galacticus_Error
    use Cosmology_Functions
    use Cosmology_Parameters
    use Galacticus_Input_Paths
    use Memory_Management
    use IO_HDF5
    implicit none
    character       (len=*                         ), intent(in   )               :: massFunctionFileName
    type            (massFunction                  ), intent(inout)               :: massFunction_
    type            (cosmologyFunctionsMatterLambda), intent(inout)               :: cosmologyFunctionsObserved
    type            (cosmologyParametersSimple     ), intent(inout)               :: cosmologyParametersObserved
    type            (varying_string                ), intent(  out)               :: cosmologyScalingMass              , cosmologyScalingMassFunction
    double precision                                , allocatable  , dimension(:) :: massBinWidths
    double precision                                , save                        :: dataOmegaMatterPrevious    =-1.0d0, dataOmegaDarkEnergyPrevious=-1.0d0, &
         &                                                                           dataHubbleParameterPrevious=-1.0d0
    !$omp threadprivate(dataOmegaMatterPrevious,dataOmegaDarkEnergyPrevious,dataHubbleParameterPrevious)
    type            (hdf5Object                    )                              :: dataFile                          , massDataset                       , &
         &                                                                           parameters
    double precision                                                              :: dataHubbleParameter               , dataOmegaMatter                   , &
         &                                                                           dataOmegaDarkEnergy
    integer                                                                       :: k
    logical                                                                       :: massBinWidthsAvailable

    !$omp critical(HDF5_Access)
    call dataFile%openFile(char(Galacticus_Input_Path()//'/'//massFunctionFileName),readOnly=.true.)
    call dataFile   %readDataset  ('mass'          ,massFunction_%masses)
    massDataset=dataFile%openDataset('mass'        )
    call massDataset%readAttribute('cosmologyScaling',cosmologyScalingMass               ,allowPseudoScalar=.true.)
    call massDataset%close()
    massDataset=dataFile%openDataset('massFunction')
    call massDataset%readAttribute('cosmologyScaling',cosmologyScalingMassFunction       ,allowPseudoScalar=.true.)
    call massDataset%close()
    massBinWidthsAvailable=dataFile%hasDataset('massWidthObserved')
    if (massBinWidthsAvailable) call dataFile%readDataset('massWidthObserved',massBinWidths)
    parameters =dataFile%openGroup  ('Parameters'  )
    call parameters %readAttribute('H_0'             ,dataHubbleParameter                                         )
    call parameters %readAttribute('Omega_Matter'    ,dataOmegaMatter                                             )
    call parameters %readAttribute('Omega_DE'        ,dataOmegaDarkEnergy                                         )
    call parameters %close()
    call dataFile   %close()
    !$omp end critical(HDF5_Access)
    ! Create the observed cosmology.
    if     (                                                          &
         &  .not.(                                                    &
         &         dataHubbleParameter == dataHubbleParameterPrevious &
         &        .and.                                               &
         &         dataOmegaMatter     == dataOmegaMatterPrevious     &
         &        .and.                                               &
         &         dataOmegaDarkEnergy == dataOmegaDarkEnergyPrevious &
         &       )                                                    &
         & ) then
       cosmologyParametersObserved=cosmologyParametersSimple     (                                     &
            &                                                     OmegaMatter    =dataOmegaMatter    , &
            &                                                     OmegaDarkEnergy=dataOmegaDarkEnergy, &
            &                                                     HubbleConstant =dataHubbleParameter, &
            &                                                     temperatureCMB =0.0d0              , &
            &                                                     OmegaBaryon    =0.0d0                &
            &                                                    )
       cosmologyFunctionsObserved =cosmologyFunctionsMatterLambda(                                     &
            &                                                     cosmologyParametersObserved          &
            &                                                    )
       dataHubbleParameterPrevious=dataHubbleParameter
       dataOmegaMatterPrevious    =dataOmegaMatter
       dataOmegaDarkEnergyPrevious=dataOmegaDarkEnergy
    end if
    ! Construct mass function array.
    massFunction_%massesCount=size(massFunction_%masses)
    call allocateArray(massFunction_%massesLogarithmic             ,[massFunction_%massesCount                                       ])
    call allocateArray(massFunction_%massesLogarithmicMinimum      ,[massFunction_%massesCount                                       ])
    call allocateArray(massFunction_%massesLogarithmicMaximum      ,[massFunction_%massesCount                                       ])
    call allocateArray(massFunction_%massFunction                  ,[massFunction_%massesCount                                       ])
    call allocateArray(massFunction_%massFunctionCovariance        ,[massFunction_%massesCount,massFunction_%massesCount          ])
    call allocateArray(massFunction_%mainBranchGalaxyWeights       ,[massFunction_%massesCount,analysisMassFunctionsHaloMassBinsCount])
    call allocateArray(massFunction_%mainBranchGalaxyWeightsSquared,[massFunction_%massesCount,analysisMassFunctionsHaloMassBinsCount])
    massFunction_%massesLogarithmic             =log10(massFunction_%masses)
    massFunction_%massFunction                  =0.0d0
    massFunction_%massFunctionCovariance        =0.0d0
    massFunction_%mainBranchGalaxyWeights       =0.0d0
    massFunction_%mainBranchGalaxyWeightsSquared=0.0d0
    do k=1,massFunction_%massesCount
       if (massBinWidthsAvailable) then
          ! Bin widths were explicitly specified in the file - use them to construct bin minimum and maximum masses.
          massFunction_%massesLogarithmicMinimum(k)=massFunction_%massesLogarithmic(k)-0.5d0*log10(massBinWidths(k))
          massFunction_%massesLogarithmicMaximum(k)=massFunction_%massesLogarithmic(k)+0.5d0*log10(massBinWidths(k))
       else
          ! Bin widths were not explicitly specified in the file - assume bin boundaries at means of adjacent bin centers
          ! (logarithmically), and extrapolate boundaries of initial and final bins.
          if (k ==                            1) then
             massFunction_%massesLogarithmicMinimum(k)=massFunction_%massesLogarithmic(k)-0.5d0*(massFunction_%massesLogarithmic(k+1)-massFunction_%massesLogarithmic(k  ))
          else
             massFunction_%massesLogarithmicMinimum(k)=                                  +0.5d0*(massFunction_%massesLogarithmic(k-1)+massFunction_%massesLogarithmic(k  ))
          end if
          if (k == massFunction_%massesCount) then
             massFunction_%massesLogarithmicMaximum(k)=massFunction_%massesLogarithmic(k)+0.5d0*(massFunction_%massesLogarithmic(k  )-massFunction_%massesLogarithmic(k-1))
          else
             massFunction_%massesLogarithmicMaximum(k)=                                  +0.5d0*(massFunction_%massesLogarithmic(k+1)+massFunction_%massesLogarithmic(k  ))
          end if
       end if
    end do
    return
  end subroutine Load_Standard_Mass_Function

end module Galacticus_Output_Analyses_Mass_Functions
