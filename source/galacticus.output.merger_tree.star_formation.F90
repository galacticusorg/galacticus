!! Copyright 2009, 2010, 2011, 2012, 2013, 2014, 2015 Andrew Benson <abenson@obs.carnegiescience.edu>
!!
!! This file is part of Galacticus.
!!
!!    Galacticus is free software: you can redistribute it and/or modify
!!    it under the terms of the GNU General Public License as published by
!!    the Free Software Foundation, either version 3 of the License, or
!!    (at your option) any later version.
!!
!!    Galacticus is distributed in the hope that it will be useful,
!!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!!    GNU General Public License for more details.
!!
!!    You should have received a copy of the GNU General Public License
!!    along with Galacticus.  If not, see <http://www.gnu.org/licenses/>.

!% Contains a module which handles computation and output of star formation histories for galaxies.

module Galacticus_Output_Star_Formation_Histories
  !% Handles computation and output of star formation histories for galaxies.
  use, intrinsic :: ISO_C_Binding
  use ISO_Varying_String
  use Galacticus_Nodes
  use Abundances_Structure
  use Histories
  use Kind_Numbers
  implicit none
  private
  public :: Star_Formation_History_Create, Star_Formation_History_Scales, Star_Formation_History_Record,&
       & Star_Formation_History_Output

  ! Flag indicating whether this module has been initialized.
  logical                                                    :: starFormationHistoriesInitialized=.false.

  ! Name of the method to use.
  type     (varying_string                        )          :: starFormationHistoriesMethod

  ! Pointer to the subroutine that creates any history required for star formation histories.
  procedure(Star_Formation_History_Create_Template), pointer :: Star_Formation_History_Create_Do =>null()
  abstract interface
     subroutine Star_Formation_History_Create_Template(thisNode,thisHistory)
       import treeNode, history
       type(treeNode), intent(inout), pointer :: thisNode
       type(history ), intent(inout)          :: thisHistory
     end subroutine Star_Formation_History_Create_Template
  end interface

  ! Pointer to the subroutine that sets scale factors for error control of star formation histories
  procedure(Star_Formation_History_Scales_Template), pointer :: Star_Formation_History_Scales_Do=>null()
  abstract interface
     subroutine Star_Formation_History_Scales_Template(thisHistory,stellarMass,stellarAbundances)
       import abundances, history
       double precision            , intent(in   ) :: stellarMass
       type            (abundances), intent(in   ) :: stellarAbundances
       type            (history   ), intent(inout) :: thisHistory
     end subroutine Star_Formation_History_Scales_Template
  end interface

  ! Pointer to the subroutine that records the star formation history.
  procedure(Star_Formation_History_Record_Template), pointer :: Star_Formation_History_Record_Do=>null()
  abstract interface
     subroutine Star_Formation_History_Record_Template(thisNode,thisHistory,fuelAbundances,starFormationRate)
       import treeNode, history, abundances
       type            (treeNode  ), intent(inout), pointer :: thisNode
       type            (history   ), intent(inout)          :: thisHistory
       type            (abundances), intent(in   )          :: fuelAbundances
       double precision            , intent(in   )          :: starFormationRate
     end subroutine Star_Formation_History_Record_Template
  end interface

  ! Pointer to the subroutine that outputs the star formation history.
  procedure(Star_Formation_History_Output_Template), pointer :: Star_Formation_History_Output_Do=>null()
  abstract interface
     subroutine Star_Formation_History_Output_Template(thisNode,nodePassesFilter,thisHistory,iOutput,treeIndex,componentLabel)
       import treeNode, history, abundances, kind_int8, c_size_t
       type     (treeNode      ), intent(inout), pointer :: thisNode
       logical                  , intent(in   )          :: nodePassesFilter
       type     (history       ), intent(inout)          :: thisHistory
       integer  (c_size_t      ), intent(in   )          :: iOutput
       integer  (kind=kind_int8), intent(in   )          :: treeIndex
       character(len=*         ), intent(in   )          :: componentLabel
     end subroutine Star_Formation_History_Output_Template
  end interface

contains

  subroutine Galacticus_Output_Star_Formation_Histories_Initialize
    !% Initialize the star formation histories module.
    use Galacticus_Error
    use Input_Parameters
    !# <include directive="starFormationHistoriesMethod" type="moduleUse">
    include 'galacticus.output.merger_tree.star_formation.modules.inc'
    !# </include>
    implicit none

    ! Initialize if necessary.
    if (.not.starFormationHistoriesInitialized) then
       !$omp critical(Galacticus_Output_Star_Formation_Histories_Initialization)
       if (.not.starFormationHistoriesInitialized) then
          ! Get the star formation history method parameter.
          !@ <inputParameter>
          !@   <name>starFormationHistoriesMethod</name>
          !@   <defaultValue>null</defaultValue>
          !@   <attachedTo>module</attachedTo>
          !@   <description>
          !@     The method to use for computing and outputting star formation histories.
          !@   </description>
          !@   <type>string</type>
          !@   <cardinality>1</cardinality>
          !@   <group>output</group>
          !@ </inputParameter>
          call Get_Input_Parameter('starFormationHistoriesMethod',starFormationHistoriesMethod,defaultValue='null')
          ! Include file that makes calls to all available method initialization routines.
          !# <include directive="starFormationHistoriesMethod" type="functionCall" functionType="void">
          !#  <functionArgs>starFormationHistoriesMethod,Star_Formation_History_Create_Do,Star_Formation_History_Scales_Do,Star_Formation_History_Record_Do,Star_Formation_History_Output_Do</functionArgs>
          include 'galacticus.output.merger_tree.star_formation.inc'
          !# </include>
          if (.not.(associated(Star_Formation_History_Create_Do).and.associated(Star_Formation_History_Scales_Do).and.associated(Star_Formation_History_Record_Do).and.associated(Star_Formation_History_Output_Do))) &
               & call Galacticus_Error_Report('Galacticus_Output_Star_Formation_Histories_Initialize'&
               &,'method '//char(starFormationHistoriesMethod)//' is unrecognized')
          starFormationHistoriesInitialized=.true.
       end if
       !$omp end critical(Galacticus_Output_Star_Formation_Histories_Initialization)
    end if
    return
  end subroutine Galacticus_Output_Star_Formation_Histories_Initialize

  subroutine Star_Formation_History_Create(thisNode,thisHistory)
    !% Create any history required for storing the star formation history.
    implicit none
    type(treeNode), intent(inout), pointer :: thisNode
    type(history ), intent(inout)          :: thisHistory

    ! Ensure module is initialized.
    call Galacticus_Output_Star_Formation_Histories_Initialize

    ! Simply call the function which does the actual work.
    call Star_Formation_History_Create_Do(thisNode,thisHistory)

    return
  end subroutine Star_Formation_History_Create

  subroutine Star_Formation_History_Record(thisNode,thisHistory,fuelAbundances,starFormationRate)
    !% Record the star formation history for {\normalfont \ttfamily thisNode}.
    implicit none
    type            (treeNode  ), intent(inout), pointer :: thisNode
    type            (history   ), intent(inout)          :: thisHistory
    type            (abundances), intent(in   )          :: fuelAbundances
    double precision            , intent(in   )          :: starFormationRate

    ! Ensure module is initialized.
    call Galacticus_Output_Star_Formation_Histories_Initialize

    ! Simply call the function which does the actual work.
    call Star_Formation_History_Record_Do(thisNode,thisHistory,fuelAbundances,starFormationRate)

    return
  end subroutine Star_Formation_History_Record

  subroutine Star_Formation_History_Output(thisNode,nodePassesFilter,thisHistory,iOutput,treeIndex,componentLabel)
    !% Output the star formation history for {\normalfont \ttfamily thisNode}.
    implicit none
    type     (treeNode      ), intent(inout), pointer :: thisNode
    logical                  , intent(in   )          :: nodePassesFilter
    type     (history       ), intent(inout)          :: thisHistory
    integer  (c_size_t      ), intent(in   )          :: iOutput
    integer  (kind=kind_int8), intent(in   )          :: treeIndex
    character(len=*         ), intent(in   )          :: componentLabel

    ! Ensure module is initialized.
    call Galacticus_Output_Star_Formation_Histories_Initialize

    ! Simply call the function which does the actual work.
    call Star_Formation_History_Output_Do(thisNode,nodePassesFilter,thisHistory,iOutput,treeIndex,componentLabel)

    return
  end subroutine Star_Formation_History_Output

  subroutine Star_Formation_History_Scales(thisHistory,stellarMass,stellarAbundances)
    !% Set the scaling factors for error control on the absolute value of stellar population properties.
    implicit none
    double precision            , intent(in   ) :: stellarMass
    type            (abundances), intent(in   ) :: stellarAbundances
    type            (history   ), intent(inout) :: thisHistory

    ! Ensure module is initialized.
    call Galacticus_Output_Star_Formation_Histories_Initialize

    ! Simply call the subroutine which does the actual work.
    call Star_Formation_History_Scales_Do(thisHistory,stellarMass,stellarAbundances)
    return
  end subroutine Star_Formation_History_Scales

end module Galacticus_Output_Star_Formation_Histories
