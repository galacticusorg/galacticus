!! Copyright 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018
!!    Andrew Benson <abenson@carnegiescience.edu>
!!
!! This file is part of Galacticus.
!!
!!    Galacticus is free software: you can redistribute it and/or modify
!!    it under the terms of the GNU General Public License as published by
!!    the Free Software Foundation, either version 3 of the License, or
!!    (at your option) any later version.
!!
!!    Galacticus is distributed in the hope that it will be useful,
!!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!!    GNU General Public License for more details.
!!
!!    You should have received a copy of the GNU General Public License
!!    along with Galacticus.  If not, see <http://www.gnu.org/licenses/>.

!% Contains a module that implements simple and convenient interfaces to a variety of HDF5 functionality.

! Specify an explicit dependence on the hdf5_cTypes.o object file.
!: $(BUILDPATH)/hdf5_cTypes.o

module IO_HDF5
  !% Implements simple and convenient interfaces to a variety of HDF5 functionality.
  use            :: HDF5
  use            :: H5TB
  use            :: Locks
  use            :: ISO_Varying_String
  use, intrinsic :: ISO_C_Binding
  implicit none
  private
  public :: hdf5Object, IO_HDF5_Set_Defaults
#ifdef DEBUGHDF5
  public :: IO_HDF5_Start_Critical, IO_HDF5_End_Critical

  logical                                                :: inCritical=.false.
  !$omp threadprivate(inCritical)
#endif

  ! Lock object to coordinate access to HDF5.
  type   (ompLock)                              , public :: hdf5Access
 
  ! Record of initialization of this module.
  logical                                                :: hdf5IsInitalized       =.false.
  integer                                                :: initializationsCount   =0

  ! Type of HDF5 objects.
  integer                            , parameter         :: hdf5ObjectTypeNull     =0
  integer                            , parameter         :: hdf5ObjectTypeFile     =1
  integer                            , parameter         :: hdf5ObjectTypeGroup    =2
  integer                            , parameter         :: hdf5ObjectTypeDataset  =3
  integer                            , parameter         :: hdf5ObjectTypeAttribute=4

  ! Data types.
  integer                            , parameter, public :: hdf5DataTypeNull       =0
  integer                            , parameter, public :: hdf5DataTypeInteger    =1
  integer                            , parameter, public :: hdf5DataTypeInteger8   =2
  integer                            , parameter, public :: hdf5DataTypeDouble     =3
  integer                            , parameter, public :: hdf5DataTypeCharacter  =4

  ! Chunking and compression parameters.
  integer                                                :: hdf5CompressionLevel   =-1
  integer(kind=HSIZE_T)                                  :: hdf5ChunkSize          =-1

  ! Arrays of compatible datatypes.
  integer(kind=HID_T  ), dimension(5)           , public :: H5T_NATIVE_DOUBLES
  integer(kind=HID_T  ), dimension(5)           , public :: H5T_NATIVE_INTEGERS
  integer(kind=HID_T  ), dimension(3)           , public :: H5T_NATIVE_INTEGER_8S
  integer(kind=HID_T  ), dimension(8)           , public :: H5T_NATIVE_INTEGER_8AS

  type hdf5Object
     !% A structure that holds properties of HDF5 objects.
     private
     logical                          :: isOpenValue   =.false.
     logical                          :: isOverwritable
     integer(kind=HID_T    )          :: objectID
     type   (varying_string)          :: objectLocation
     type   (varying_string)          :: objectName
     integer                          :: hdf5ObjectType
     integer(kind=HSIZE_T  )          :: chunkSize
     integer                          :: compressionLevel
     logical                          :: chunkSizeSet          , compressionLevelSet
     type   (hdf5Object    ), pointer :: parentObject
   contains
     !@ <objectMethods>
     !@   <object>hdf5Object</object>
     !@   <objectMethod>
     !@     <method>writeAttribute</method>
     !@     <description>Write an attribute to an HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))(|[:])) \textgreater} attributeValue\argin, \textcolor{red}{\textless character(len=*)\textgreater} [attributeName]\argin)</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>writeDataset</method>
     !@     <description>Write a dataset to an HDF5 group.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))[:$^{0-1}$\footnote{For {\normalfont \ttfamily double} datasets, up to 5-dimensional datasets are supported.}]) \textgreater} datasetValue\argin, \textcolor{red}{\textless character(len=*)\textgreater} [datasetName]\argin), \textcolor{red}{\textless character(len=*)\textgreater} [commentText]\argin, \logicalzero [appendTo]\argin, \intzero [chunkSize]\argin, \intzero [compressionLevel]\argin, \textcolor{red}{\textless type(hdf5Object} [datasetReturned]\argout</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>readAttribute</method>
     !@     <description>Read an attribute from an HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [attributeName]\argin), \textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))[:$^{0-1}$*]) \textgreater} attributeValue\argout, \logicalzero [allowPseudoScalar]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>readAttributeStatic</method>
     !@     <description>Read an attribute from an HDF5 object into a static array.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [attributeName]\argin), \textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))[:$^{0-1}$]) \textgreater} attributeValue\argout, \logicalzero [allowPseudoScalar]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>readDataset</method>
     !@     <description>Read a dataset from an HDF5 group into an allocatable array.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [datasetName]\argin), \textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))[:$^{0-1}$*]) \textgreater} datasetValue\argout, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readBegin]\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readCount]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>readDatasetStatic</method>
     !@     <description>Read a dataset from an HDF5 group into a static array.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [datasetName]\argin, \textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*)|type(varying\_string))[:$^{0-1}$]) \textgreater} datasetValue\argout, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readBegin]\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readCount]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>readTable</method>
     !@     <description>Read a column from an HDF5 table into an allocatable array.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [tableName]\argin), \textcolor{red}{\textless character(len=*)\textgreater} [columnName]\argin), \textcolor{red}{\textless (integer|integer(kind=kind\_int8)|double|character(len=*))[:$^{0-1}$*]) \textgreater} datasetValue\argout, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readBegin]\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)[1]\textgreater} [readCount]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>size</method>
     !@     <description>Return the size of a dataset.</description>
     !@     <type>\textcolor{red}{\textless integer(kind=HSIZE\_T)\textgreater}</type>
     !@     <arguments>\intzero\ dim\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>hasAttribute</method>
     !@     <description>Check if an object has a named attribute.</description>
     !@     <type>\logicalzero</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [attributeName]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>hasGroup</method>
     !@     <description>Check if an object has a named group.</description>
     !@     <type>\logicalzero</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [groupName]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>hasDataset</method>
     !@     <description>Check if an object has a named dataset.</description>
     !@     <type>\logicalzero</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [datasetName]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>assertAttributeType</method>
     !@     <description>Check the type and rank of an attribute.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless integer(kind=HID\_T)(:)\textgreater} attributeAssertedType\argin, \intzero\ attributeAssertedRank\argin, [matches]\argout</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>assertDatasetType</method>
     !@     <description>Check the type and rank of a dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless integer(kind=HID\_T)(:)\textgreater} datasetAssertedType\argin, \intzero\ datasetAssertedRank\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>rank</method>
     !@     <description>Return the rank of a dataset.</description>
     !@     <type>\intzero</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>isReference</method>
     !@     <description>Return true if a dataset is a reference.</description>
     !@     <type>\logicalzero</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>isOpen</method>
     !@     <description>Return true if an object is open.</description>
     !@     <type>\logicalzero</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>createReference1D</method>
     !@     <description>Create a reference to a 1D dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless type(hdf5Object)\textgreater} toDataset\arginout, \textcolor{red}{\textless character(len=*)\textgreater} referenceName\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(1)\textgreater} referenceStart\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(1)\textgreater} referenceCount\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>createReference2D</method>
     !@     <description>Create a reference to a 2D dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless type(hdf5Object)\textgreater} toDataset\arginout, \textcolor{red}{\textless character(len=*)\textgreater} referenceName\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(2)\textgreater} referenceStart\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(2)\textgreater} referenceCount\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>createReference3D</method>
     !@     <description>Create a reference to a 2D dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless type(hdf5Object)\textgreater} toDataset\arginout, \textcolor{red}{\textless character(len=*)\textgreater} referenceName\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(3)\textgreater} referenceStart\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(3)\textgreater} referenceCount\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>createReference4D</method>
     !@     <description>Create a reference to a 2D dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless type(hdf5Object)\textgreater} toDataset\arginout, \textcolor{red}{\textless character(len=*)\textgreater} referenceName\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(4)\textgreater} referenceStart\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(4)\textgreater} referenceCount\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>createReference5D</method>
     !@     <description>Create a reference to a 2D dataset.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless type(hdf5Object)\textgreater} toDataset\arginout, \textcolor{red}{\textless character(len=*)\textgreater} referenceName\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(5)\textgreater} referenceStart\argin, \textcolor{red}{\textless integer(kind=HSIZE\_T)(5)\textgreater} referenceCount\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>destroy</method>
     !@     <description>Destroy an HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>close</method>
     !@     <description>Close an HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>flush</method>
     !@     <description>Flush an HDF5 file to disk.</description>
     !@     <type>\void</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>pathTo</method>
     !@     <description>Returns the path to a given object.</description>
     !@     <type>\textcolor{red}{\textless type(varying\_string)\textgreater}</type>
     !@     <arguments></arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>openFile</method>
     !@     <description>Open an HDF5 file and return an appropriate HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} [fileName], \logicalzero\ [overWrite]\argin, \logicalzero\ [readOnly]\argin, \logicalzero\ [objectsOverwritable]\argin, \intzero\ [chunkSize]\argin, \intzero\ [compressionLevel]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>openGroup</method>
     !@     <description>Open an HDF5 group and return an appropriate HDF5 object.</description>
     !@     <type>\textcolor{red}{\textless type(hdf5Object}</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} groupName\argin, \textcolor{red}{\textless character(len=*)\textgreater} [commentText]\argin, \logicalzero\ [overWrite]\argin, \logicalzero\ [objectsOverwritable]\argin, \intzero\ [chunkSize]\argin, \intzero\ [compressionLevel]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>openDataset</method>
     !@     <description>Open an HDF5 dataset.</description>
     !@     <type>\textcolor{red}{\textless type(hdf5Object}</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} datasetName\argin, \textcolor{red}{\textless character(len=*)\textgreater} [commentText]\argin, \intzero\ [datasetDataType]\argin,  \textcolor{red}{\textless integer(kind=HSIZE\_T)(:)\textgreater} [datasetDimensions]\argin, \logicalzero\ [isOverwritable]\argin, \logicalzero\ [appendTo]\argin, \textcolor{red}{\textless integer(kind=HID\_T)\textgreater} [useDataType]\argin, \intzero\ [chunkSize]\argin, \intzero\ [compressionLevel]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>openAttribute</method>
     !@     <description>Open an HDF5 attribute.</description>
     !@     <type>\textcolor{red}{\textless type(hdf5Object}</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} attributeName\argin, \intzero\ [attributeDataType]\argin,  \textcolor{red}{\textless integer(kind=HSIZE\_T)(:)\textgreater} [attributeDimensions]\argin, \logicalzero\ [isOverwritable]\argin, \textcolor{red}{\textless integer(kind=HID\_T)\textgreater} [useDataType]\argin</arguments>
     !@   </objectMethod>
     !@   <objectMethod>
     !@     <method>copy</method>
     !@     <description>Copy an HDF5 object.</description>
     !@     <type>\void</type>
     !@     <arguments>\textcolor{red}{\textless character(len=*)\textgreater} objectName\argin, \textcolor{red}{\textless type(hdf5Object)} target\arginout</arguments>
     !@   </objectMethod>
     !@ </objectMethods>
     procedure :: destroy                                 =>IO_HDF5_Destroy
     procedure :: pathTo                                  =>IO_HDF5_Path_To
     procedure :: openFile                                =>IO_HDF5_Open_File
     procedure :: openGroup                               =>IO_HDF5_Open_Group
     procedure :: openDataset                             =>IO_HDF5_Open_Dataset
     procedure :: openAttribute                           =>IO_HDF5_Open_Attribute
     procedure :: close                                   =>IO_HDF5_Close
     procedure :: flush                                   =>IO_HDF5_Flush
     procedure :: IO_HDF5_Write_Attribute_Integer_Scalar
     procedure :: IO_HDF5_Write_Attribute_Integer_1D
     procedure :: IO_HDF5_Write_Attribute_Integer8_Scalar
     procedure :: IO_HDF5_Write_Attribute_Integer8_1D
     procedure :: IO_HDF5_Write_Attribute_Double_Scalar
     procedure :: IO_HDF5_Write_Attribute_Double_1D
     procedure :: IO_HDF5_Write_Attribute_Double_2D
     procedure :: IO_HDF5_Write_Attribute_Character_Scalar
     procedure :: IO_HDF5_Write_Attribute_Character_1D
     procedure :: IO_HDF5_Write_Attribute_VarString_Scalar
     procedure :: IO_HDF5_Write_Attribute_VarString_1D
     generic   :: writeAttribute      => IO_HDF5_Write_Attribute_Integer_Scalar  , &
          &                              IO_HDF5_Write_Attribute_Integer_1D      , &
          &                              IO_HDF5_Write_Attribute_Integer8_Scalar , &
          &                              IO_HDF5_Write_Attribute_Integer8_1D     , &
          &                              IO_HDF5_Write_Attribute_Double_Scalar   , &
          &                              IO_HDF5_Write_Attribute_Double_1D       , &
          &                              IO_HDF5_Write_Attribute_Double_2D       , &
          &                              IO_HDF5_Write_Attribute_Character_Scalar, &
          &                              IO_HDF5_Write_Attribute_Character_1D    , &
          &                              IO_HDF5_Write_Attribute_VarString_Scalar, &
          &                              IO_HDF5_Write_Attribute_VarString_1D
     procedure :: IO_HDF5_Write_Dataset_Integer_1D
     procedure :: IO_HDF5_Write_Dataset_Integer_2D
     procedure :: IO_HDF5_Write_Dataset_Integer8_1D
     procedure :: IO_HDF5_Write_Dataset_Integer8_2D
     procedure :: IO_HDF5_Write_Dataset_Double_1D
     procedure :: IO_HDF5_Write_Dataset_Double_2D
     procedure :: IO_HDF5_Write_Dataset_Double_3D
     procedure :: IO_HDF5_Write_Dataset_Double_4D
     procedure :: IO_HDF5_Write_Dataset_Double_5D
     procedure :: IO_HDF5_Write_Dataset_Double_6D
     procedure :: IO_HDF5_Write_Dataset_Character_1D
     procedure :: IO_HDF5_Write_Dataset_VarString_1D
     generic   :: writeDataset        => IO_HDF5_Write_Dataset_Integer_1D        , &
          &                              IO_HDF5_Write_Dataset_Integer_2D        , &
          &                              IO_HDF5_Write_Dataset_Integer8_1D       , &
          &                              IO_HDF5_Write_Dataset_Integer8_2D       , &
          &                              IO_HDF5_Write_Dataset_Double_1D         , &
          &                              IO_HDF5_Write_Dataset_Double_2D         , &
          &                              IO_HDF5_Write_Dataset_Double_3D         , &
          &                              IO_HDF5_Write_Dataset_Double_4D         , &
          &                              IO_HDF5_Write_Dataset_Double_5D         , &
          &                              IO_HDF5_Write_Dataset_Double_6D         , &
          &                              IO_HDF5_Write_Dataset_Character_1D      , &
          &                              IO_HDF5_Write_Dataset_VarString_1D
     procedure :: IO_HDF5_Read_Attribute_Integer_Scalar
     procedure :: IO_HDF5_Read_Attribute_Integer_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Attribute_Integer_1D_Array_Static
     procedure :: IO_HDF5_Read_Attribute_Integer8_Scalar
     procedure :: IO_HDF5_Read_Attribute_Integer8_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Attribute_Integer8_1D_Array_Static
     procedure :: IO_HDF5_Read_Attribute_Double_Scalar
     procedure :: IO_HDF5_Read_Attribute_Double_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Attribute_Double_1D_Array_Static
     procedure :: IO_HDF5_Read_Attribute_Character_Scalar
     procedure :: IO_HDF5_Read_Attribute_Character_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Attribute_Character_1D_Array_Static
     procedure :: IO_HDF5_Read_Attribute_VarString_Scalar
     procedure :: IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Attribute_VarString_1D_Array_Static
     generic   :: readAttribute       => IO_HDF5_Read_Attribute_Integer_Scalar                , &
          &                              IO_HDF5_Read_Attribute_Integer_1D_Array_Allocatable  , &
          &                              IO_HDF5_Read_Attribute_Integer8_Scalar               , &
          &                              IO_HDF5_Read_Attribute_Integer8_1D_Array_Allocatable , &
          &                              IO_HDF5_Read_Attribute_Double_Scalar                 , &
          &                              IO_HDF5_Read_Attribute_Double_1D_Array_Allocatable   , &
          &                              IO_HDF5_Read_Attribute_Character_Scalar              , &
          &                              IO_HDF5_Read_Attribute_Character_1D_Array_Allocatable, &
          &                              IO_HDF5_Read_Attribute_VarString_Scalar              , &
          &                              IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable
     generic   :: readAttributeStatic => IO_HDF5_Read_Attribute_Integer_1D_Array_Static       , &
          &                              IO_HDF5_Read_Attribute_Integer8_1D_Array_Static      , &
          &                              IO_HDF5_Read_Attribute_Double_1D_Array_Static        , &
          &                              IO_HDF5_Read_Attribute_Character_1D_Array_Static     , &
          &                              IO_HDF5_Read_Attribute_VarString_1D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Integer_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Integer_1D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Integer_2D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Integer_2D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Integer8_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Integer8_1D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Integer8_2D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Integer8_2D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_1D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_2D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_2D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_3D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_3D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_4D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_4D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_5D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_5D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Double_6D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Double_6D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_Character_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_Character_1D_Array_Static
     procedure :: IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Dataset_VarString_1D_Array_Static
     generic   :: readDataset         => IO_HDF5_Read_Dataset_Integer_1D_Array_Allocatable    , &
          &                              IO_HDF5_Read_Dataset_Integer_2D_Array_Allocatable    , &
          &                              IO_HDF5_Read_Dataset_Integer8_1D_Array_Allocatable   , &
          &                              IO_HDF5_Read_Dataset_Integer8_2D_Array_Allocatable   , &
          &                              IO_HDF5_Read_Dataset_Double_1D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Double_2D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Double_3D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Double_4D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Double_5D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Double_6D_Array_Allocatable     , &
          &                              IO_HDF5_Read_Dataset_Character_1D_Array_Allocatable  , &
          &                              IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable
     generic   :: readDatasetStatic   => IO_HDF5_Read_Dataset_Integer_1D_Array_Static         , &
          &                              IO_HDF5_Read_Dataset_Integer_2D_Array_Static         , &
          &                              IO_HDF5_Read_Dataset_Integer8_1D_Array_Static        , &
          &                              IO_HDF5_Read_Dataset_Integer8_2D_Array_Static        , &
          &                              IO_HDF5_Read_Dataset_Double_1D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Double_2D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Double_3D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Double_4D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Double_5D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Double_6D_Array_Static          , &
          &                              IO_HDF5_Read_Dataset_Character_1D_Array_Static       , &
          &                              IO_HDF5_Read_Dataset_VarString_1D_Array_Static
     procedure :: IO_HDF5_Read_Table_Real_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Table_Integer_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Table_Integer8_1D_Array_Allocatable
     procedure :: IO_HDF5_Read_Table_Character_1D_Array_Allocatable
     generic   :: readTable          =>IO_HDF5_Read_Table_Real_1D_Array_Allocatable    , &
          &                            IO_HDF5_Read_Table_Integer_1D_Array_Allocatable , &
          &                            IO_HDF5_Read_Table_Integer8_1D_Array_Allocatable, &
          &                            IO_HDF5_Read_Table_Character_1D_Array_Allocatable
     procedure :: size               =>IO_HDF5_Dataset_Size
     procedure :: rank               =>IO_HDF5_Dataset_Rank
     procedure :: hasAttribute       =>IO_HDF5_Has_Attribute
     procedure :: hasGroup           =>IO_HDF5_Has_Group
     procedure :: hasDataset         =>IO_HDF5_Has_Dataset
     procedure :: assertAttributeType=>IO_HDF5_Assert_Attribute_Type
     procedure :: assertDatasetType  =>IO_HDF5_Assert_Dataset_Type
     procedure :: isReference        =>IO_HDF5_Is_Reference
     procedure :: isOpen             =>IO_HDF5_Is_Open
     procedure :: createReference1D  =>IO_HDF5_Create_Reference_Scalar_To_1D
     procedure :: createReference2D  =>IO_HDF5_Create_Reference_Scalar_To_2D
     procedure :: createReference3D  =>IO_HDF5_Create_Reference_Scalar_To_3D
     procedure :: createReference4D  =>IO_HDF5_Create_Reference_Scalar_To_4D
     procedure :: createReference5D  =>IO_HDF5_Create_Reference_Scalar_To_5D
     procedure :: copy               =>IO_HDF5_Copy 
  end type hdf5Object

  ! Interfaces to functions in the HDF5 C API that are required due to the limited datatypes supported by the Fortran API. For
  ! example, h5dread_f() can not read a scalar dataset region reference, so we are forced to go through the h5dread() C function
  ! for this purpose.
  interface
     function H5T_C_S1_Get() bind(c,name='H5T_C_S1_Get')
       !% Template for a C function that returns the H5T_C_S1 datatype ID.
       import
       integer(kind=hid_t) :: H5T_C_S1_Get
     end function H5T_C_S1_Get
     function H5Awrite(attr_id,mem_type_id,buf) bind(c, name='H5Awrite')
       !% Template for the HDF5 C API attribute write function.
       import
       integer(kind=herr_t)        :: H5Awrite
       integer(kind=hid_t ), value :: attr_id , mem_type_id
       type   (c_ptr      ), value :: buf
     end function H5Awrite
     function H5Aread(attr_id,mem_type_id,buf) bind(c, name='H5Aread')
       !% Template for the HDF5 C API attribute read function.
       import
       integer(kind=herr_t)        :: H5Aread
       integer(kind=hid_t ), value :: attr_id, mem_type_id
       type   (c_ptr      ), value :: buf
     end function H5Aread
     function H5Dwrite(dataset_id,mem_type_id,mem_space_id,file_space_id,xfer_plist_id,buf) bind(c, name='H5Dwrite')
       !% Template for the HDF5 C API dataset write function.
       import
       integer(kind=herr_t)        :: H5Dwrite
       integer(kind=hid_t ), value :: dataset_id   , file_space_id, mem_space_id, mem_type_id, &
            &                         xfer_plist_id
       type   (c_ptr      ), value :: buf
     end function H5Dwrite
     function H5Dread(dataset_id,mem_type_id,mem_space_id,file_space_id,xfer_plist_id,buf) bind(c, name='H5Dread')
       !% Template for the HDF5 C API dataset read function.
       import
       integer(kind=herr_t)        :: H5Dread
       integer(kind=hid_t ), value :: dataset_id   , file_space_id, mem_space_id, mem_type_id, &
            &                         xfer_plist_id
       type   (c_ptr      ), value :: buf
     end function H5Dread
     function H5TBread_fields_name(loc_id,table_name,field_names,start,nrecords,type_size,field_offset,dst_sizes,data) bind(c, name='H5TBread_fields_name')
       !% Template for the HDF5 C API table read fields by name function.
       import
       integer  (kind=herr_t )               :: H5TBread_fields_name
       integer  (kind=hid_t  ), value        :: loc_id
       character(kind=c_char )               :: table_name          , field_names(*)
       integer  (kind=hsize_t), value        :: start               , nrecords      , type_size
       integer  (kind=size_t ), dimension(*) :: field_offset        , dst_sizes
       type     (c_ptr       ), value        :: data
     end function H5TBread_fields_name
  end interface
  
contains

  !! Initialization routines.

  subroutine IO_HDF5_Initialize
    !% Initialize the HDF5 subsystem.
    use Galacticus_Error
    implicit none
    integer :: errorCode

#ifdef DEBUGHDF5
    call IO_HDF5_Assert_In_Critical()
#endif
    
    if (.not.hdf5IsInitalized) then
       call h5open_f(errorCode)
       if (errorCode < 0) call Galacticus_Error_Report('failed to initialize HDF5 subsystem'//{introspection:location})

       ! Ensure native datatype arrays are initialized.
       H5T_NATIVE_DOUBLES         =[H5T_NATIVE_DOUBLE   ,H5T_IEEE_F32BE,H5T_IEEE_F32LE,H5T_IEEE_F64BE,H5T_IEEE_F64LE]
       H5T_NATIVE_INTEGERS        =[H5T_NATIVE_INTEGER  ,H5T_STD_I32BE ,H5T_STD_I32LE ,H5T_STD_I64BE ,H5T_STD_I64LE ]
       H5T_NATIVE_INTEGER_8S      =[H5T_NATIVE_INTEGER_8,H5T_STD_I64BE ,H5T_STD_I64LE                               ]
       H5T_NATIVE_INTEGER_8AS(1:5)=H5T_NATIVE_INTEGERS
       H5T_NATIVE_INTEGER_8AS(6:8)=H5T_NATIVE_INTEGER_8S

       ! Flag that the hdf5 system is now initialized.
       hdf5IsInitalized=.true.
    end if
    initializationsCount=initializationsCount+1
    return
  end subroutine IO_HDF5_Initialize

  subroutine IO_HDF5_Uninitialize
    !% Uninitialize the HDF5 subsystem.
    use Galacticus_Error
    implicit none
    integer :: errorCode

#ifdef DEBUGHDF5
    call IO_HDF5_Assert_In_Critical()
#endif

    if (hdf5IsInitalized) then
       initializationsCount=initializationsCount-1
       if (initializationsCount == 0) then
          call h5close_f(errorCode)
          if (errorCode < 0) call Galacticus_Error_Report('failed to uninitialize HDF5 subsystem'//{introspection:location})
          hdf5IsInitalized=.false.
       end if
    end if
    return
  end subroutine IO_HDF5_Uninitialize

  subroutine IO_HDF_Assert_Is_Initialized()
    !% Check if this module has been initialized.
    use Galacticus_Error
    implicit none

#ifdef DEBUGHDF5
    call IO_HDF5_Assert_In_Critical()
#endif

    if (.not.hdf5IsInitalized) call Galacticus_Error_Report('HDF5 IO module has not been initialized'//{introspection:location})
    return
  end subroutine IO_HDF_Assert_Is_Initialized

#ifdef DEBUGHDF5
  subroutine IO_HDF5_Assert_In_Critical()
    !% Assert that we are in an {\normalfont \ttfamily HDF5\_Access} OpenMP critical block.
    use Galacticus_Error
    implicit none

    if (.not.inCritical) call Galacticus_Error_Report('HDF5 functions accessed outside of critical block'//{introspection:location})
    return
  end subroutine IO_HDF5_Assert_In_Critical
  
  subroutine IO_HDF5_Start_Critical()
    !% Record that we have entered an {\normalfont \ttfamily HDF5\_Access} OpenMP critical block.
    implicit none

    inCritical=.true.
    return
  end subroutine IO_HDF5_Start_Critical

  subroutine IO_HDF5_End_Critical()
    !% Record that we have left an {\normalfont \ttfamily HDF5\_Access} OpenMP critical block.
    implicit none

    inCritical=.false.
    return
  end subroutine IO_HDF5_End_Critical
#endif
  
  subroutine IO_HDF5_Set_Defaults(chunkSize,compressionLevel)
    !% Sets the compression level and chunk size for dataset output.
    use Galacticus_Error
    implicit none
    integer(kind=HSIZE_T), intent(in   ), optional :: chunkSize
    integer              , intent(in   ), optional :: compressionLevel

    !$ call hdf5Access%set()
    if (present(chunkSize)) then
       if (chunkSize        ==  0) call Galacticus_Error_Report('zero chunksize is invalid'//{introspection:location})
       if (chunkSize        <  -1) call Galacticus_Error_Report('chunksize less than -1 is invalid'//{introspection:location})
       hdf5ChunkSize=chunkSize
    end if
    if (present(compressionLevel)) then
       if (compressionLevel <  -1 .or. compressionLevel > 9) call Galacticus_Error_Report('compression level must be in range -1 to 9'//{introspection:location})
       hdf5CompressionLevel=compressionLevel
    end if
    !$ call hdf5Access%unset()
    return
  end subroutine IO_HDF5_Set_Defaults

  !! Utility routines.

  subroutine IO_HDF5_Destroy(thisObject)
    !% Destroy an HDF5 object by destroying its associated varying string objects.
    implicit none
    class(hdf5Object), intent(inout) :: thisObject

    call thisObject%objectLocation%destroy()
    call thisObject%objectName    %destroy()
    return
  end subroutine IO_HDF5_Destroy

  logical function IO_HDF5_Is_Open(thisObject)
    !% Returns true if {\normalfont \ttfamily thisObject} is open.
    implicit none
    class(hdf5Object), intent(in   ) :: thisObject

    IO_HDF5_Is_Open=thisObject%isOpenValue
    return
  end function IO_HDF5_Is_Open

  function IO_HDF5_Path_To(thisObject) result (pathToObject)
    !% Returns the path to {\normalfont \ttfamily thisObject}.
    implicit none
    class(hdf5Object    ), intent(in   ) :: thisObject
    type (varying_string)                :: pathToObject

    pathToObject=thisObject%objectLocation//"/"//thisObject%objectName
    return
  end function IO_HDF5_Path_To

  subroutine IO_HDF5_Close(thisObject)
    !% Close an HDF5 object.
    use Galacticus_Display
    use Galacticus_Error
    use String_Handling
    implicit none
    class    (hdf5Object               ), intent(inout)               :: thisObject
    integer  (kind=hid_t               ), allocatable  , dimension(:) :: openObjectIDs
    integer  (kind=size_t              ), parameter                   :: objectNameSizeMaximum=1024
    integer                                                           :: errorCode
    integer  (kind=size_t              )                              :: i                         , objectNameSize        , &
         &                                                               openObjectCount           , nonRootOpenObjectCount
    type     (varying_string           )                              :: message
    character(len=objectNameSizeMaximum)                              :: objectName

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the object is open.
    if (.not.thisObject%isOpenValue) then
       message="Attempt to close unopen HDF5 object '"//thisObject%objectName//"'"
       call Galacticus_Display_Message(message)
       return
    end if

    ! Close the object.
    select case (thisObject%hdf5ObjectType)
    case (hdf5ObjectTypeFile     )
       ! Check for still-open objects.
       call h5fget_obj_count_f(thisObject%objectID,H5F_OBJ_ALL_F,openObjectCount,errorCode)
       if (errorCode /= 0) then
          message="unable to count open objects in file object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       allocate(openObjectIDs(openObjectCount))
       call h5fget_obj_ids_f(thisObject%objectID,H5F_OBJ_ALL_F,openObjectCount,openObjectIDs,errorCode)
       if (errorCode /= 0) then
          message="unable to get IDs of open objects in file object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       nonRootOpenObjectCount=0
       if (openObjectCount > 1) then
          do i=1,openObjectCount
             call h5iget_name_f(openObjectIDs(i),objectName,objectNameSizeMaximum,objectNameSize,errorCode)
             if (errorCode /= 0) then
                message="unable to get name of open object in file object '"//thisObject%objectName//"'"
                call Galacticus_Error_Report(message//{introspection:location})
             end if
             if (trim(objectName) /= "/") nonRootOpenObjectCount=nonRootOpenObjectCount+1
          end do
       end if
       if (nonRootOpenObjectCount > 0) then          
          message=""
          message=message//nonRootOpenObjectCount//" open object(s) remain in file object '"//thisObject%objectName//"'"
          call Galacticus_Display_Indent('Problem closing HDF5 file')
          call Galacticus_Display_Message(message)
          do i=1,openObjectCount
             call h5iget_name_f(openObjectIDs(i),objectName,objectNameSizeMaximum,objectNameSize,errorCode)
             if (errorCode /= 0) then
                message="unable to get name of open object in file object '"//thisObject%objectName//"'"
                call Galacticus_Error_Report(message//{introspection:location})
             end if
             message="Object: "//trim(objectName)//" ["
             message=message//openObjectIDs(i)//"]"
             if (trim(objectName) /= "/") call Galacticus_Display_Message(message)
          end do
          call Galacticus_Display_Unindent('done')
       end if
       call h5fclose_f(thisObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="unable to close file object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Uninitialize the HDF5 library (will only uninitialize if this is the last file to be closed).
       call IO_HDF5_Uninitialize
    case (hdf5ObjectTypeGroup    )
       call h5gclose_f(thisObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="unable to close group object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    case (hdf5ObjectTypeDataset  )
       call h5dclose_f(thisObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="unable to close dataset object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    case (hdf5ObjectTypeAttribute)
       call h5aclose_f(thisObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="unable to close attribute object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end select

    ! Mark that the object is now closed.
    thisObject%isOpenValue=.false.

    ! Reset the object ID to zero.
    thisObject%objectID=0
    return
  end subroutine IO_HDF5_Close

  subroutine IO_HDF5_Flush(thisObject)
    !% Flush an HDF5 file to disk.
    use Galacticus_Display
    use Galacticus_Error
    implicit none
    class  (hdf5Object    ), intent(inout) :: thisObject
    type   (varying_string)                :: message
    integer                                :: errorCode
    
    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the object is open.
    if (.not.thisObject%isOpenValue) then
       message="Attempt to flush unopen HDF5 object '"//thisObject%objectName//"'"
       call Galacticus_Display_Message(message)
       return
    end if

    ! Flush to file.
    call h5fflush_f(thisObject%objectID,H5F_Scope_Local_F,errorCode)
    if (errorCode /= 0) then
       message="unable to flush object '"//thisObject%objectName//"' to file"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end subroutine IO_HDF5_Flush

  function IO_HDF5_Character_Types(stringLength)
    !% Return datatypes for character data of a given length. Types are for Fortran native and C native types.
    use Galacticus_Error
    implicit none
    integer(kind=HID_T    ), dimension(2)  :: IO_HDF5_Character_Types
    integer                , intent(in   ) :: stringLength
    integer                                :: errorCode
    type   (varying_string)                :: message

    call h5tcopy_f(H5T_NATIVE_CHARACTER,IO_HDF5_Character_Types(1),errorCode)
    if (errorCode < 0) then
       message="unable to make custom datatype"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tset_size_f(IO_HDF5_Character_Types(1),int(stringLength,size_t),errorCode)
    if (errorCode < 0) then
       message="unable to set datatype size"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tcopy_f(H5T_C_S1_Get(),IO_HDF5_Character_Types(2),errorCode)
    if (errorCode < 0) then
       message="unable to make custom datatype"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tset_size_f(IO_HDF5_Character_Types(2),int(stringLength,size_t),errorCode)
    if (errorCode < 0) then
       message="unable to set datatype size"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end function IO_HDF5_Character_Types

  !! File routines.

  subroutine IO_HDF5_Open_File(fileObject,fileName,overWrite,readOnly,objectsOverwritable,chunkSize,compressionLevel,sieveBufferSize,useLatestFormat,cacheElementsCount,cacheSizeBytes)
    !% Open a file and return an appropriate HDF5 object. The file name can be provided as an input parameter or, if not
    !% provided, will be taken from the stored object name in {\normalfont \ttfamily fileObject}.
    use Galacticus_Error
    use File_Utilities
    implicit none
    class    (hdf5Object    ), intent(inout)           :: fileObject
    character(len=*         ), intent(in   ), optional :: fileName
    logical                  , intent(in   ), optional :: objectsOverwritable, overWrite       , readOnly
    integer  (kind=size_t   ), intent(in   ), optional :: chunkSize          , sieveBufferSize , cacheElementsCount, &
         &                                                cacheSizeBytes
    integer                  , intent(in   ), optional :: compressionLevel
    logical                  , intent(in   ), optional :: useLatestFormat
    integer                                            :: errorCode          , fileAccess
    logical                                            :: overWriteActual
    type     (varying_string)                          :: message
    integer  (kind=hid_t    )                          :: accessList

    ! Initialize the HDF5 library.
    call IO_HDF5_Initialize

    ! Store the location and name of this object.
    fileObject%objectLocation=""
    if (present(fileName)) then
       fileObject%objectLocation="."
       fileObject%objectName    =trim(fileName)
    else
       if (len(fileObject%objectName) == 0) call Galacticus_Error_Report('object has no predefined file name'//{introspection:location})
    end if

    ! Check if overwriting is allowed.
    if (present(overWrite)) then
       overWriteActual=overWrite
    else
       overWriteActual=.false.
    end if

    ! Create an access list.
    call h5pcreate_f(H5P_FILE_ACCESS_F,accessList,errorCode)
    if (errorCode /= 0) then
       message="failed to create file access list HDF5 file '"//fileObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5pset_fclose_degree_f(accessList,H5F_CLOSE_SEMI_F,errorCode)
    if (errorCode /= 0) then
       message="failed to set close degree for HDF5 file '"//fileObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Specify file driver (buffered I/O).
    call h5pset_fapl_stdio_f(accessList,errorCode)
    if (errorCode /= 0) then
       message="failed to set I/O driver for HDF5 file '"//fileObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Set sieve buffer size.
    if (present(sieveBufferSize)) then
       call h5pset_sieve_buf_size_f(accessList,sieveBufferSize,errorCode)
       if (errorCode /= 0) then
          message="failed to set sieve buffer size for HDF5 file '"//fileObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Set file format.
    if (present(useLatestFormat)) then
       if (useLatestFormat) then
          call h5pset_libver_bounds_f(accessList,H5F_LIBVER_LATEST_F  ,H5F_LIBVER_LATEST_F,errorCode)
       else
          call h5pset_libver_bounds_f(accessList,H5F_LIBVER_EARLIEST_F,H5F_LIBVER_LATEST_F,errorCode)
       end if
       if (errorCode /= 0) then
          message="failed to set file format for HDF5 file '"//fileObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    if (present(cacheElementsCount).or.present(cacheSizeBytes)) then
       if (.not.(present(cacheElementsCount).and.present(cacheSizeBytes))) call Galacticus_Error_Report('both or neither of "cacheElementsCount" and "cacheSizeBytes" must be specified'//{introspection:location})
       call h5pset_cache_f(accessList,0,cacheElementsCount,cacheSizeBytes,0.75,errorCode)
    end if
    
    ! Check if the file exists.
    if (File_Exists(fileName).and..not.overWriteActual) then
       ! Determine access for file.
       if (present(readOnly)) then
          if (readOnly) then
             fileAccess=H5F_ACC_RDONLY_F
          else
             fileAccess=H5F_ACC_RDWR_F
          end if
       else
          fileAccess=H5F_ACC_RDWR_F
       end if
       ! Attempt to open the file.
       call h5fopen_f(fileName,fileAccess,fileObject%objectID,errorCode,access_prp=accessList)
       if (errorCode /= 0) then
          message="failed to open HDF5 file '"//fileObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! If read only was specified, creating the file is not allowed.
       if (present(readOnly)) then
          if (readOnly) then
             message="can not create/overwrite read only file '"//fileObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
       ! Attempt to create the file.
       call h5fcreate_f(fileName,H5F_ACC_TRUNC_F,fileObject%objectID,errorCode,access_prp=accessList)
       if (errorCode /= 0) then
          message="failed to create HDF5 file '"//fileObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Finished with our property list.
    call h5pclose_f(accessList,errorCode)
    if (errorCode /= 0) then
       message="failed to close access property list for HDF5 file '"//fileObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    
    ! Mark this object as open.
    fileObject%isOpenValue=.true.

    ! Object has no parent.
    fileObject%parentObject => null()

    ! Mark this object as a file object.
    fileObject%hdf5ObjectType=hdf5ObjectTypeFile

    ! Set the chunk size if provided.
    if (present(chunkSize)) then
       fileObject%chunkSizeSet=.true.
       fileObject%chunkSize   =chunkSize
    else
       fileObject%chunkSizeSet=.false.
    end if

    ! Set the compression level if provided.
    if (present(compressionLevel)) then
       fileObject%compressionLevelSet=.true.
       fileObject%compressionLevel   =compressionLevel
    else
       fileObject%compressionLevelSet=.false.
    end if

    ! Mark whether objects are overwritable.
    if (present(objectsOverwritable)) then
       fileObject%isOverwritable=objectsOverwritable
    else
       fileObject%isOverwritable=.false.
    end if
    return
  end subroutine IO_HDF5_Open_File

  !! Group routines.

  function IO_HDF5_Open_Group(inObject,groupName,commentText,objectsOverwritable,overwriteOverride,chunkSize,compressionLevel) result (groupObject)
    !% Open an HDF5 group and return an appropriate HDF5 object. The group name can be provided as an input parameter or, if
    !% not provided, will be taken from the stored object name in {\normalfont \ttfamily groupObject}. The location at which to open the group is
    !% taken from either {\normalfont \ttfamily inObject} or {\normalfont \ttfamily inPath}.
    use Galacticus_Error
    implicit none
    type     (hdf5Object    )                          :: groupObject
    character(len=*         ), intent(in   )           :: groupName
    character(len=*         ), intent(in   ), optional :: commentText
    logical                  , intent(in   ), optional :: objectsOverwritable, overwriteOverride
    integer                  , intent(in   ), optional :: chunkSize          , compressionLevel
    class    (hdf5Object    ), intent(in   ), target   :: inObject
    ! <HDF5> Why are "message" and "locationPath" saved? Because if they aren't then they get dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (varying_string), save                    :: locationPath       , message
    integer                                            :: errorCode
    integer  (kind=HID_T    )                          :: locationID

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Decide where to open the group.
    if (.not.inObject%isOpenValue) then
       message="attempt to open group '"//trim(groupName)//"' in unopen object '"//inObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    locationID  =inObject%objectID
    locationPath=inObject%pathTo()

    ! Set the parent for the group.
    select type (inObject)
    type is (hdf5Object)
       groupObject%parentObject => inObject
    end select

    ! Check if the group exists.
    if (inObject%hasGroup(groupName)) then
       ! Open the group.
       call h5gopen_f(locationID,trim(groupName),groupObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="failed to open group '"//trim(groupName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Create a group.
       call h5gcreate_f(locationID,trim(groupName),groupObject%objectID,errorCode)
       if (errorCode < 0) then
          message="failed to make group '"//trim(groupName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Set the comment for this group.
    if (present(commentText)) then
       call h5gset_comment_f(groupObject%objectID,'.',trim(commentText),errorCode)
       if (errorCode < 0) then
          message="failed to set comment for group '"//trim(groupName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Mark this object as open.
    groupObject%isOpenValue=.true.

    ! Mark this object as a file object.
    groupObject%hdf5ObjectType=hdf5ObjectTypeGroup

    ! Store the name and location of the object.
    groupObject%objectName=trim(groupName)
    groupObject%objectLocation=groupObject%parentObject%pathTo()

    ! Set the chunk size if provided.
    if (present(chunkSize)) then
       groupObject%chunkSizeSet   =.true.
       groupObject%chunkSize      =chunkSize
    else
       ! No chunk size provided. See if we can inherit one from the parent object.
       if (groupObject%parentObject%chunkSizeSet) then
          groupObject%chunkSizeSet=.true.
          groupObject%chunkSize   =groupObject%parentObject%chunkSize
       else
          groupObject%chunkSizeSet=.false.
       end if
    end if

    ! Set the compression level if provided.
    if (present(compressionLevel)) then
       groupObject%compressionLevelSet=.true.
       groupObject%compressionLevel   =compressionLevel
    else
       ! No compression level provided. See if we can inherit one from the parent object.
       if (groupObject%parentObject%compressionLevelSet) then
          groupObject%compressionLevelSet=.true.
          groupObject%compressionLevel   =groupObject%parentObject%compressionLevel
       else
          groupObject%compressionLevelSet=.false.
       end if
    end if

    ! Mark whether objects are overwritable.
    if (present(objectsOverwritable)) then
       if (.not.present(overwriteOverride).or..not.overwriteOverride) then
          if (objectsOverwritable.and..not.groupObject%parentObject%isOverwritable) then
             message="cannot make objects in '"//trim(groupName)//"' overwritable as objects in parent '"&
                  &//groupObject%parentObject%objectName//"' are not overwritable"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
       groupObject%isOverwritable=objectsOverwritable
    else
       groupObject%isOverwritable=groupObject%parentObject%isOverwritable
    end if
    return
  end function IO_HDF5_Open_Group

  logical function IO_HDF5_Has_Group(thisObject,groupName)
    !% Check if {\normalfont \ttfamily thisObject} has a group with the given {\normalfont \ttfamily groupName}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(in   ) :: thisObject
    character(len=*         ), intent(in   ) :: groupName
    integer                                  :: creationOrderMaximum, errorCode, linkCount, &
         &                                      storageType
    type     (varying_string)                :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="object '"//thisObject%objectName//"' in not open"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object exists.
    call h5eset_auto_f(0,errorCode)
    if (errorCode /= 0) then
       message="failed to switch HDF5 error report off"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5gget_info_by_name_f(thisObject%objectID,trim(groupName),storageType,linkCount,creationOrderMaximum,errorCode)
    IO_HDF5_Has_Group=(errorCode == 0)
    call h5eset_auto_f(1,errorCode)
    if (errorCode /= 0) then
       message="failed to switch HDF5 error report on"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end function IO_HDF5_Has_Group

  !! Attribute routines.

  function IO_HDF5_Open_Attribute(inObject,attributeName,attributeDataType,attributeDimensions,isOverwritable,useDataType)&
       & result(attributeObject)
    !% Open an attribute in {\normalfont \ttfamily inObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )              , intent(in   ), target   :: inObject
    type     (hdf5Object    )                                        :: attributeObject
    character(len=*         )              , intent(in   )           :: attributeName
    integer                                , intent(in   ), optional :: attributeDataType
    integer  (kind=HSIZE_T  ), dimension(:), intent(in   ), optional :: attributeDimensions
    logical                                , intent(in   ), optional :: isOverwritable
    integer  (kind=HID_T    )              , intent(in   ), optional :: useDataType
    integer                                                          :: attributeRank            , errorCode
    integer  (kind=HID_T    )                                        :: dataSpaceID              , dataTypeID, &
         &                                                              locationID
    integer  (kind=HSIZE_T  ), dimension(7)                          :: attributeDimensionsActual
    type     (varying_string)                                        :: locationPath             , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Ensure that the object is already open.
    if (inObject%isOpenValue) then
       locationID  =inObject%objectID
       locationPath=inObject%objectLocation//"/"//inObject%objectName
       select type (inObject)
       type is (hdf5Object)
       attributeObject%parentObject => inObject
    end select
    else
       message="attempt to open attribute '"//trim(attributeName)//"' in unopen object '"//inObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine the rank and dimensions.
    if (present(attributeDimensions)) then
       ! Open data space with the desired dimensions.
       attributeRank=size(attributeDimensions)
       if (attributeRank > 7) then
          message="attributes of rank greater than 7 are not supported - attribute in question is '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       attributeDimensionsActual(1:attributeRank)=attributeDimensions
    else
       ! No dimensions specified, assume a scalar.
       attributeRank=0
    end if

    ! Check if the attribute exists.
    if (IO_HDF5_Has_Attribute(inObject,attributeName)) then
       ! Open the attribute.
       call h5aopen_f(locationID,trim(attributeName),attributeObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="failed to open attribute '"//trim(attributeName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Ensure that a data type was specified.
       if (.not.present(attributeDataType)) then
          message="no datatype was specified for attribute '"//trim(attributeName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open a suitable dataspace.
       call h5screate_simple_f(attributeRank,attributeDimensionsActual,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="unable to open dataspace for attribute '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the data type.
       if (present(useDataType)) then
          dataTypeID=useDataType
       else
          select case (attributeDataType)
          case (hdf5DataTypeInteger  )
             dataTypeID=H5T_NATIVE_INTEGER
          case (hdf5DataTypeInteger8 )
             dataTypeID=H5T_NATIVE_INTEGER_8
          case (hdf5DataTypeDouble   )
             dataTypeID=H5T_NATIVE_DOUBLE
          case (hdf5DataTypeCharacter)
             dataTypeID=H5T_NATIVE_CHARACTER
          end select
       end if
       ! Create the attribute.
       call h5acreate_f(locationID,trim(attributeName),dataTypeID,dataSpaceID,attributeObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="failed to create attribute '"//trim(attributeName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Close the dataspace.
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close dataspace for attribute '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Mark this object as open.
    attributeObject%isOpenValue=.true.

    ! Mark this object as a file object.
    attributeObject%hdf5ObjectType=hdf5ObjectTypeAttribute

    ! Store the name and location of the object.
    attributeObject%objectName=trim(attributeName)
    attributeObject%objectLocation=attributeObject%parentObject%pathTo()

    ! Mark whether attribute is overwritable.
    if (present(isOverwritable)) then
       if (isOverwritable.and..not.attributeObject%parentObject%isOverwritable) then
          message="cannot make attribute '"//trim(attributeName)//"' overwritable as objects in parent '"&
               &//attributeObject%parentObject%objectName//"' are not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       attributeObject%isOverwritable=isOverwritable
    else
       attributeObject%isOverwritable=attributeObject%parentObject%isOverwritable
    end if
    return
  end function IO_HDF5_Open_Attribute

  subroutine IO_HDF5_Write_Attribute_Integer_Scalar(thisObject,attributeValue,attributeName)
    !% Open and write an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(inout)           :: thisObject
    character(len=*         ), intent(in   ), optional :: attributeName
    integer                  , intent(in   )           :: attributeValue
    integer  (kind=HSIZE_T  ), dimension(1)            :: attributeDimensions
    integer                                            :: errorCode
    logical                                            :: preExisted
    type     (hdf5Object    )                          :: attributeObject
    type     (varying_string)                          :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a scalar integer.
          call thisObject%assertAttributeType(H5T_NATIVE_INTEGERS,0)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeInteger)
       ! Check that pre-existing object is a scalar integer.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,0)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,H5T_NATIVE_INTEGER,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Integer_Scalar

  subroutine IO_HDF5_Write_Attribute_Integer_1D(thisObject,attributeValue,attributeName)
    !% Open and write an integer 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    integer                  , dimension(:), intent(in   )           :: attributeValue
    integer  (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions
    integer                                                          :: errorCode
    logical                                                          :: preExisted
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D integer.
          call thisObject%assertAttributeType(H5T_NATIVE_INTEGERS,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeDimensions=shape(attributeValue)
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeInteger,attributeDimensions)
       ! Check that pre-existing object is a 1D integer.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,1)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,H5T_NATIVE_INTEGER,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Integer_1D

  subroutine IO_HDF5_Write_Attribute_Integer8_Scalar(thisObject,attributeValue,attributeName)
    !% Open and write a long integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Kind_Numbers
    implicit none
    class    (hdf5Object    ), intent(inout)           :: thisObject
    character(len=*         ), intent(in   ), optional :: attributeName
    integer  (kind=kind_int8), intent(in   ), target   :: attributeValue
    integer                                            :: errorCode
    logical                                            :: preExisted
    type     (hdf5Object    )                          :: attributeObject
    type     (varying_string)                          :: attributeNameActual, message
    type     (c_ptr         )                          :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a scalar integer.
          call thisObject%assertAttributeType(H5T_NATIVE_INTEGER_8S,0)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeInteger8)
       ! Check that pre-existing object is a scalar integer.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8S,0)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    dataBuffer=c_loc(attributeValue)
    errorCode=H5Awrite(attributeObject%objectID,H5T_NATIVE_INTEGER_8,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Integer8_Scalar

  subroutine IO_HDF5_Write_Attribute_Integer8_1D(thisObject,attributeValue,attributeName)
    !% Open and write an integer 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Kind_Numbers
    use Galacticus_Error
    use Memory_Management
    implicit none
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=kind_int8)             , dimension(:), intent(in   )           :: attributeValue
    integer  (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions
    integer  (kind=kind_int8), allocatable, dimension(:)               , target   :: attributeValueContiguous
    integer                                                                       :: errorCode
    logical                                                                       :: preExisted
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual     , message
    type     (c_ptr         )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D long integer.
          call thisObject%assertAttributeType(H5T_NATIVE_INTEGER_8S,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeDimensions=shape(attributeValue)
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeInteger8,attributeDimensions)
       ! Check that pre-existing object is a 1D long integer.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8S,1)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    ! We're forced to make a copy of attributeValue here because we can't pass attributeValue itself to c_loc()
    ! since it is of assumed shape.
    call allocateArray(attributeValueContiguous,shape(attributeValue))
    attributeValueContiguous=attributeValue
    dataBuffer=c_loc(attributeValueContiguous)
    errorCode=H5Awrite(attributeObject%objectID,H5T_NATIVE_INTEGER_8,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call deallocateArray(attributeValueContiguous)

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Integer8_1D

  subroutine IO_HDF5_Write_Attribute_Double_Scalar(thisObject,attributeValue,attributeName)
    !% Open and write an double scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    ), intent(inout)           :: thisObject
    character       (len=*         ), intent(in   ), optional :: attributeName
    double precision                , intent(in   )           :: attributeValue
    integer         (kind=HSIZE_T  ), dimension(1)            :: attributeDimensions
    integer                                                   :: errorCode
    logical                                                   :: preExisted
    type            (hdf5Object    )                          :: attributeObject
    type            (varying_string)                          :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a scalar double.
          call thisObject%assertAttributeType(H5T_NATIVE_DOUBLES,0)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeDouble)
       ! Check that pre-existing object is a scalar double.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,0)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Double_Scalar

  subroutine IO_HDF5_Write_Attribute_Double_1D(thisObject,attributeValue,attributeName)
    !% Open and write an double 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )              , intent(inout)           :: thisObject
    character       (len=*         )              , intent(in   ), optional :: attributeName
    double precision                , dimension(:), intent(in   )           :: attributeValue
    integer         (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions
    integer                                                                 :: errorCode
    logical                                                                 :: preExisted
    type            (hdf5Object    )                                        :: attributeObject
    type            (varying_string)                                        :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D double.
          call thisObject%assertAttributeType(H5T_NATIVE_DOUBLES,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeDimensions=shape(attributeValue)
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeDouble,attributeDimensions)
       ! Check that pre-existing object is a 1D double.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,1)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Double_1D

  subroutine IO_HDF5_Write_Attribute_Double_2D(thisObject,attributeValue,attributeName)
    !% Open and write an double 2-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                , intent(inout)           :: thisObject
    character       (len=*         )                , intent(in   ), optional :: attributeName
    double precision                , dimension(:,:), intent(in   )           :: attributeValue
    integer         (kind=HSIZE_T  ), dimension(2)                            :: attributeDimensions
    integer                                                                   :: errorCode
    logical                                                                   :: preExisted
    type            (hdf5Object    )                                          :: attributeObject
    type            (varying_string)                                          :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 2D double.
          call thisObject%assertAttributeType(H5T_NATIVE_DOUBLES,2)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeDimensions=shape(attributeValue)
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeDouble,attributeDimensions)
       ! Check that pre-existing object is a 2D double.
       if (preExisted) call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,2)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Double_2D
  
  subroutine IO_HDF5_Write_Attribute_Character_Scalar(thisObject,attributeValue,attributeName)
    !% Open and write an character scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(inout)           :: thisObject
    character(len=*         ), intent(in   ), optional :: attributeName
    character(len=*         ), intent(in   )           :: attributeValue
    integer  (kind=HSIZE_T  ), dimension(1)            :: attributeDimensions
    integer  (kind=HID_T    )                          :: dataTypeID
    integer                                            :: errorCode
    logical                                            :: preExisted
    type     (hdf5Object    )                          :: attributeObject
    type     (varying_string)                          :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a custom datatype.
    call h5tcopy_f(H5T_NATIVE_CHARACTER,dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to make custom datatype for attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tset_size_f(dataTypeID,int(len(attributeValue),size_t),errorCode)
    if (errorCode < 0) then
       message="unable to set datatype size for attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a scalar character.
          call thisObject%assertAttributeType([dataTypeID],0)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeCharacter,useDataType=dataTypeID)
       ! Check that pre-existing object is a scalar character.
       if (preExisted) call attributeObject%assertAttributeType([dataTypeID],0)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,dataTypeID,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Character_Scalar

  subroutine IO_HDF5_Write_Attribute_Character_1D(thisObject,attributeValue,attributeName)
    !% Open and write an character 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    character(len=*         ), dimension(:), intent(in   )           :: attributeValue
    integer  (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions
    integer  (kind=HID_T    )                                        :: dataTypeID
    integer                                                          :: errorCode
    logical                                                          :: preExisted
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a custom datatype.
    call h5tcopy_f(H5T_NATIVE_CHARACTER,dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to make custom datatype for attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tset_size_f(dataTypeID,int(len(attributeValue),size_t),errorCode)
    if (errorCode < 0) then
       message="unable to set datatype size for attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! If this attribute if not overwritable, report an error.
       if (.not.thisObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D character.
          call thisObject%assertAttributeType([dataTypeID],1)
       end if
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       attributeNameActual=thisObject%objectName
    else
       ! Check that an attribute name was supplied.
       if (present(attributeName)) then
          attributeNameActual=trim(attributeName)
       else
          message="no name was supplied for attribute in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if attribute already exists.
       preExisted=thisObject%hasAttribute(attributeName)
       ! Open the attribute.
       attributeDimensions=shape(attributeValue)
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName,hdf5DataTypeCharacter,attributeDimensions,useDataType=dataTypeID)
       ! Check that pre-existing object is a 1D character.
       if (preExisted) call attributeObject%assertAttributeType([dataTypeID],1)
       ! If this attribute if not overwritable, report an error.
       if (preExisted.and..not.attributeObject%isOverwritable) then
          message="attribute '"//trim(attributeNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Write the attribute.
    call h5awrite_f(attributeObject%objectID,dataTypeID,attributeValue,attributeDimensions,errorCode)
    if (errorCode /= 0) then
       message="unable to write attribute '"//attributeNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Write_Attribute_Character_1D

  subroutine IO_HDF5_Write_Attribute_VarString_Scalar(thisObject,attributeValue,attributeName)
    !% Open and write a varying string scalar attribute in {\normalfont \ttfamily thisObject}.
    implicit none
    class    (hdf5Object    ), intent(inout)           :: thisObject
    character(len=*         ), intent(in   ), optional :: attributeName
    type     (varying_string), intent(in   )           :: attributeValue

    ! Call the character version of this routine to perform the write.
    call IO_HDF5_Write_Attribute_Character_Scalar(thisObject,char(attributeValue),attributeName)

    return
  end subroutine IO_HDF5_Write_Attribute_VarString_Scalar

  subroutine IO_HDF5_Write_Attribute_VarString_1D(thisObject,attributeValue,attributeName)
    !% Open and write a varying string 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use String_Handling
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    type     (varying_string), dimension(:), intent(in   )           :: attributeValue

    ! Call the character version of this routine to perform the write.
    call IO_HDF5_Write_Attribute_Character_1D(thisObject,Convert_VarString_To_Char(attributeValue),attributeName)

    return
  end subroutine IO_HDF5_Write_Attribute_VarString_1D

  subroutine IO_HDF5_Read_Attribute_Integer_Scalar(thisObject,attributeName,attributeValue,allowPseudoScalar)
    !% Open and read an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    integer                                , intent(  out)           :: attributeValue
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    logical                                , intent(in   ), optional :: allowPseudoScalar
    integer                  , dimension(1)                          :: pseudoScalarValue
    integer  (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions    , attributeMaximumDimensions
    integer  (kind=HID_T    )                                        :: attributeDataspaceID
    integer                                                          :: errorCode
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual    , message
    logical                                                          :: allowPseudoScalarActual, matches

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check if pseudo-scalars are allowed.
    if (present(allowPseudoScalar)) then
       allowPseudoScalarActual=allowPseudoScalar
    else
       allowPseudoScalarActual=.false.
    end if

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a scalar integer.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,0,matches)
    if (matches) then
       ! Read the scalar attribute.
       call h5aread_f(attributeObject%objectID,H5T_NATIVE_INTEGER,attributeValue,attributeDimensions&
            &,errorCode)
       if (errorCode /= 0) then
          message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else if (allowPseudoScalarActual) then
       ! Attribute is not a scalar. Check if it is a pseudo-scalar.
       call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,1,matches)
       if (matches) then
          ! Get the dimensions of the array.
          call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
          if (errorCode < 0) then
             message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sclose_f(attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          if (attributeDimensions(1) == 1) then
             call attributeObject%readAttributeStatic(attributeValue=pseudoScalarValue)
             attributeValue=pseudoScalarValue(1)
          else
             call Galacticus_Error_Report("attribute must be an integer scalar or pseudo-scalar"//{introspection:location})
          end if
       end if
    else
       call Galacticus_Error_Report("attribute must be an integer scalar"//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer_Scalar

  subroutine IO_HDF5_Read_Attribute_Integer_1D_Array_Allocatable(thisObject,attributeName,attributeValue)
    !% Open and read an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer                  , allocatable, dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                                       :: errorCode
    integer  (kind=HID_T    )                                                     :: attributeDataspaceID
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D integer array.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(attributeValue)) call deallocateArray(attributeValue)
    call allocateArray(attributeValue,int(attributeDimensions))

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,H5T_NATIVE_INTEGER,attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Attribute_Integer_1D_Array_Static(thisObject,attributeName,attributeValue)
    !% Open and read an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    integer                  , dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                          :: errorCode
    integer  (kind=HID_T    )                                        :: attributeDataspaceID
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D integer array.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGERS,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the size of the array is large enough to hold the attributes.
    if (any(shape(attributeValue) < attributeDimensions)) then
       message="array is not large enough to hold attributes from '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,H5T_NATIVE_INTEGER,attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer_1D_Array_Static

  subroutine IO_HDF5_Read_Attribute_Integer8_Scalar(thisObject,attributeName,attributeValue,allowPseudoScalar)
    !% Open and read a long integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Kind_Numbers
    use Galacticus_Error
    implicit none
    integer  (kind=kind_int8)              , intent(  out)          , target :: attributeValue
    class    (hdf5Object    )              , intent(inout)                   :: thisObject
    character(len=*         )              , intent(in   ), optional         :: attributeName
    logical                                , intent(in   ), optional         :: allowPseudoScalar
    integer  (kind=kind_int8), dimension(1)                                  :: pseudoScalarValue
    integer  (kind=HSIZE_T  ), dimension(1)                                  :: attributeDimensions    , attributeMaximumDimensions
    integer  (kind=HID_T    )                                                :: attributeDataspaceID
    integer                                                                  :: errorCode
    type     (hdf5Object    )                                                :: attributeObject
    type     (varying_string)                                                :: attributeNameActual    , message
    logical                                                                  :: allowPseudoScalarActual, matches
    type     (c_ptr         )                                                :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check if pseudo-scalars are allowed.
    if (present(allowPseudoScalar)) then
       allowPseudoScalarActual=allowPseudoScalar
    else
       allowPseudoScalarActual=.false.
    end if

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a scalar integer.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8AS,0,matches)
    if (matches) then
       ! Read the attribute.
       dataBuffer=c_loc(attributeValue)
       errorCode=H5Aread(attributeObject%objectID,H5T_NATIVE_INTEGER_8,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else if (allowPseudoScalarActual) then
       ! Attribute is not a scalar. Check if it is a pseudo-scalar.
       call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8AS,1,matches)
       if (matches) then
          ! Get the dimensions of the array.
          call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
          if (errorCode < 0) then
             message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sclose_f(attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          if (attributeDimensions(1) == 1) then
             call attributeObject%readAttributeStatic(attributeValue=pseudoScalarValue)
             attributeValue=pseudoScalarValue(1)
          else
             call Galacticus_Error_Report("attribute must be a long integer scalar or pseudo-scalar"//{introspection:location})
          end if
       end if
    else
       call Galacticus_Error_Report("attribute must be a long integer scalar"//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer8_Scalar

  subroutine IO_HDF5_Read_Attribute_Integer8_1D_Array_Allocatable(thisObject,attributeName,attributeValue)
    !% Open and read an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    use Kind_Numbers
    implicit none
    integer  (kind=kind_int8), allocatable, dimension(:), intent(  out), target   :: attributeValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                                       :: errorCode
    integer  (kind=HID_T    )                                                     :: attributeDataspaceID
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual , message
    type     (c_ptr         )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D long integer array.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8AS,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(attributeValue)) call deallocateArray(attributeValue)
    call allocateArray(attributeValue,int(attributeDimensions))

    ! Read the attribute.
    dataBuffer=c_loc(attributeValue)
    errorCode=H5Aread(attributeObject%objectID,H5T_NATIVE_INTEGER_8,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer8_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Attribute_Integer8_1D_Array_Static(thisObject,attributeName,attributeValue)
    !% Open and read an integer scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    use Kind_Numbers
    implicit none
    integer  (kind=kind_int8)             , dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions     , attributeMaximumDimensions
    integer  (kind=kind_int8), allocatable, dimension(:)               , target   :: attributeValueContiguous
    integer                                                                       :: errorCode
    integer  (kind=HID_T    )                                                     :: attributeDataspaceID
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual     , message
    type     (c_ptr         )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D long integer array.
    call attributeObject%assertAttributeType(H5T_NATIVE_INTEGER_8AS,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the size of the array is large enough to hold the attributes.
    if (any(shape(attributeValue) < attributeDimensions)) then
       message="array is not large enough to hold attributes from '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the attribute.
    ! We're forced to make a copy of attributeValue here because we can't pass attributeValue itself to c_loc()
    ! since it is of assumed shape.
    call allocateArray(attributeValueContiguous,shape(attributeValue))
    dataBuffer=c_loc(attributeValueContiguous)
    errorCode=H5Aread(attributeObject%objectID,H5T_NATIVE_INTEGER_8,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    attributeValue=attributeValueContiguous

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Integer8_1D_Array_Static

  subroutine IO_HDF5_Read_Attribute_Double_Scalar(thisObject,attributeName,attributeValue,allowPseudoScalar)
    !% Open and read an double scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                              , intent(  out)           :: attributeValue
    class           (hdf5Object    )              , intent(inout)           :: thisObject
    character       (len=*         )              , intent(in   ), optional :: attributeName
    logical                                       , intent(in   ), optional :: allowPseudoScalar
    integer         (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions    , attributeMaximumDimensions
    double precision                , dimension(1)                          :: pseudoScalarValue
    integer         (kind=HID_T    )                                        :: attributeDataspaceID
    integer                                                                 :: errorCode
    type            (hdf5Object    )                                        :: attributeObject
    type            (varying_string)                                        :: attributeNameActual    , message
    logical                                                                 :: allowPseudoScalarActual, matches

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check if pseudo-scalars are allowed.
    if (present(allowPseudoScalar)) then
       allowPseudoScalarActual=allowPseudoScalar
    else
       allowPseudoScalarActual=.false.
    end if

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a scalar double.
    call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,0,matches)
    if (matches) then
       ! Read the attribute.
       call h5aread_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions&
            &,errorCode)
       if (errorCode /= 0) then
          message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else if (allowPseudoScalarActual) then
       ! Attribute is not a scalar. Check if it is a pseudo-scalar.
       call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,1,matches)
       if (matches) then
          ! Get the dimensions of the array.
          call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
          if (errorCode < 0) then
             message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sclose_f(attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          if (attributeDimensions(1) == 1) then
             call attributeObject%readAttributeStatic(attributeValue=pseudoScalarValue)
             attributeValue=pseudoScalarValue(1)
          else
             call Galacticus_Error_Report("attribute must be a double scalar or pseudo-scalar"//{introspection:location})
          end if
       else
          call Galacticus_Error_Report("attribute must be a double scalar or pseudo-scalar"//{introspection:location})
       end if
    else
       call Galacticus_Error_Report("attribute must be a double scalar"//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Double_Scalar

  subroutine IO_HDF5_Read_Attribute_Double_1D_Array_Allocatable(thisObject,attributeName,attributeValue)
    !% Open and read an double scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                , allocatable, dimension(:), intent(  out)           :: attributeValue
    class           (hdf5Object    )                           , intent(inout)           :: thisObject
    character       (len=*         )                           , intent(in   ), optional :: attributeName
    integer         (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                                              :: errorCode
    integer         (kind=HID_T    )                                                     :: attributeDataspaceID
    type            (hdf5Object    )                                                     :: attributeObject
    type            (varying_string)                                                     :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D double array.
    call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(attributeValue)) call deallocateArray(attributeValue)
    call allocateArray(attributeValue,int(attributeDimensions))

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Double_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Attribute_Double_1D_Array_Static(thisObject,attributeName,attributeValue)
    !% Open and read an double scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                , dimension(:), intent(  out)           :: attributeValue
    class           (hdf5Object    )              , intent(inout)           :: thisObject
    character       (len=*         )              , intent(in   ), optional :: attributeName
    integer         (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                                 :: errorCode
    integer         (kind=HID_T    )                                        :: attributeDataspaceID
    type            (hdf5Object    )                                        :: attributeObject
    type            (varying_string)                                        :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D double array.
    call attributeObject%assertAttributeType(H5T_NATIVE_DOUBLES,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the size of the array is large enough to hold the attributes.
    if (any(shape(attributeValue) < attributeDimensions)) then
       message="array is not large enough to hold attributes from '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,H5T_NATIVE_DOUBLE,attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Double_1D_Array_Static

  subroutine IO_HDF5_Read_Attribute_Character_Scalar(thisObject,attributeName,attributeValue,allowPseudoScalar)
    !% Open and read an character scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    character(len=*                  )              , intent(  out)           :: attributeValue
    class    (hdf5Object             )              , intent(inout)           :: thisObject
    character(len=*                  )              , intent(in   ), optional :: attributeName
    logical                                         , intent(in   ), optional :: allowPseudoScalar
    integer  (kind=HSIZE_T           ), dimension(1)                          :: attributeDimensions       , attributeMaximumDimensions
    character(len=len(attributeValue)), dimension(1)                          :: pseudoScalarValue
    integer  (kind=HID_T             )                                        :: attributeDataspaceID
    integer  (kind=HID_T             )                                        :: dataTypeID             (2)
    integer                                                                   :: errorCode
    type     (hdf5Object             )                                        :: attributeObject
    type     (varying_string         )                                        :: attributeNameActual       , message
    logical                                                                   :: allowPseudoScalarActual   , matches


    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check if pseudo-scalars are allowed.
    if (present(allowPseudoScalar)) then
       allowPseudoScalarActual=allowPseudoScalar
    else
       allowPseudoScalarActual=.false.
    end if

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a custom datatype. We actually make two types - one is a Fortran native type, the other is a C native type.
    dataTypeID=IO_HDF5_Character_Types(len(attributeValue))

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a scalar character.
    call attributeObject%assertAttributeType(dataTypeID,0,matches)
    if (matches) then
       ! Read the attribute.
       call h5aread_f(attributeObject%objectID,dataTypeID(1),attributeValue,attributeDimensions&
            &,errorCode)
       if (errorCode /= 0) then
          message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else if (allowPseudoScalarActual) then
       ! Attribute is not a scalar. Check if it is a pseudo-scalar.
       call attributeObject%assertAttributeType(dataTypeID,1,matches)
       if (matches) then
          ! Get the dimensions of the array.
          call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
          if (errorCode < 0) then
             message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          call h5sclose_f(attributeDataspaceID,errorCode)
          if (errorCode /= 0) then
             message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          if (attributeDimensions(1) == 1) then
             call attributeObject%readAttributeStatic(attributeValue=pseudoScalarValue)
             attributeValue=pseudoScalarValue(1)
          else
             call Galacticus_Error_Report("attribute must be a character scalar or pseudo-scalar"//{introspection:location})
          end if
       end if
    else
       call Galacticus_Error_Report("attribute must be an character scalar"//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID(1),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tclose_f(dataTypeID(2),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Character_Scalar

  subroutine IO_HDF5_Read_Attribute_Character_1D_Array_Allocatable(thisObject,attributeName,attributeValue)
    !% Open and read an character scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    character(len=*         ), allocatable, dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  )             , dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                                       :: errorCode
    integer  (kind=HID_T    )                                                     :: attributeDataspaceID, dataTypeID                (2)
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a custom datatype.
    dataTypeID=IO_HDF5_Character_Types(len(attributeValue))

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D character array.
    call attributeObject%assertAttributeType(dataTypeID,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(attributeValue)) call deallocateArray(attributeValue)
    call allocateArray(attributeValue,int(attributeDimensions))

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,dataTypeID(1),attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID(1),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tclose_f(dataTypeID(2),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Character_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Attribute_Character_1D_Array_Static(thisObject,attributeName,attributeValue)
    !% Open and read an character scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    character(len=*         ), dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    integer  (kind=HSIZE_T  ), dimension(1)                          :: attributeDimensions , attributeMaximumDimensions
    integer                                                          :: errorCode
    integer  (kind=HID_T    )                                        :: attributeDataspaceID, dataTypeID                (2)
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a custom datatype.
    dataTypeID=IO_HDF5_Character_Types(len(attributeValue))

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Check that the object is a 1D character array.
    call attributeObject%assertAttributeType(dataTypeID,1)

    ! Get the dimensions of the array.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_dims_f(attributeDataspaceID,attributeDimensions,attributeMaximumDimensions,errorCode)
    if (errorCode < 0) then
       message="unable to get dimensions of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the size of the array is large enough to hold the attributes.
    if (any(shape(attributeValue) < attributeDimensions)) then
       message="array is not large enough to hold attributes from '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the attribute.
    call h5aread_f(attributeObject%objectID,dataTypeID(1),attributeValue,attributeDimensions&
         &,errorCode)
    if (errorCode /= 0) then
       message="unable to read attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID(1),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tclose_f(dataTypeID(2),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(attributeNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_Character_1D_Array_Static

  subroutine IO_HDF5_Read_Attribute_VarString_Scalar(thisObject,attributeName,attributeValue,allowPseudoScalar)
    !% Open and read an varying string scalar attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    type     (varying_string), intent(  out)           :: attributeValue
    class    (hdf5Object    ), intent(inout)           :: thisObject
    character(len=*         ), intent(in   ), optional :: attributeName
    logical                  , intent(in   ), optional :: allowPseudoScalar
    integer  (kind=HID_T    )                          :: dataTypeID
    integer  (kind=SIZE_T   )                          :: dataTypeSize
    integer                                            :: errorCode
    type     (hdf5Object    )                          :: attributeObject
    type     (varying_string)                          :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
   if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Get the datatype of this attribute.
    call h5aget_type_f(attributeObject%objectID,dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not get datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the size of the datatype.
    call h5tget_size_f(dataTypeID,dataTypeSize,errorCode)
    if (errorCode /= 0) then
       message="can not get size of datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not close datatype of '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Call wrapper routine that will do the remainder of the read.
    call IO_HDF5_Read_Attribute_VarString_Scalar_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize,allowPseudoScalar)

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_Scalar

  subroutine IO_HDF5_Read_Attribute_VarString_Scalar_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize,allowPseudoScalar)
    !% Open and read an varying string scalar attribute in {\normalfont \ttfamily thisObject} by creating a suitably-sized character variable into
    !% which it can be read.
    implicit none
    type     (varying_string  ), intent(  out)           :: attributeValue
    class    (hdf5Object      ), intent(inout)           :: thisObject
    character(len=*           ), intent(in   ), optional :: attributeName
    logical                    , intent(in   ), optional :: allowPseudoScalar
    integer  (kind=SIZE_T     ), intent(in   )           :: dataTypeSize
    character(len=dataTypeSize)                          :: temporaryBuffer

    ! Call the character version of this routine to perform the red.
    call IO_HDF5_Read_Attribute_Character_Scalar(thisObject,attributeName,temporaryBuffer,allowPseudoScalar)

    ! Transfer the results to the varying string variable.
    attributeValue=temporaryBuffer

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_Scalar_Do_Read

  subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable(thisObject,attributeName,attributeValue)
    !% Open and read an varying string 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    type     (varying_string), allocatable, dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: attributeName
    integer  (kind=HID_T    )                                                     :: dataTypeID
    integer  (kind=SIZE_T   )                                                     :: dataTypeSize
    integer                                                                       :: errorCode
    type     (hdf5Object    )                                                     :: attributeObject
    type     (varying_string)                                                     :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Get the datatype of this attribute.
    call h5aget_type_f(attributeObject%objectID,dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not get datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the size of the datatype.
    call h5tget_size_f(dataTypeID,dataTypeSize,errorCode)
    if (errorCode /= 0) then
       message="can not get size of datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not close datatype of '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Call wrapper routine that will do the remainder of the read.
    call IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize)

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize)
    !% Open and read an varying string 1-D array attribute in {\normalfont \ttfamily thisObject} by creating a suitably-sized character variable into
    !% which it can be read.
    use Memory_Management
    implicit none
    type     (varying_string  ), allocatable, dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object      )                           , intent(inout)           :: thisObject
    character(len=*           )                           , intent(in   ), optional :: attributeName
    integer  (kind=SIZE_T     )                           , intent(in   )           :: dataTypeSize
    character(len=dataTypeSize), allocatable, dimension(:)                          :: temporaryBuffer

    ! Call the character version of this routine to perform the red.
    call IO_HDF5_Read_Attribute_Character_1D_Array_Allocatable(thisObject,attributeName,temporaryBuffer)

    ! Transfer the results to the varying string variable.
    allocate(attributeValue(size(temporaryBuffer)))
    call Memory_Usage_Record(sizeof(attributeValue))
    attributeValue=temporaryBuffer
    call deallocateArray(temporaryBuffer)

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Allocatable_Do_Read

  subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Static(thisObject,attributeName,attributeValue)
    !% Open and read an varying string 1-D array attribute in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    type     (varying_string), dimension(:), intent(  out)           :: attributeValue
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: attributeName
    integer  (kind=HID_T    )                                        :: dataTypeID
    integer  (kind=SIZE_T   )                                        :: dataTypeSize
    integer                                                          :: errorCode
    type     (hdf5Object    )                                        :: attributeObject
    type     (varying_string)                                        :: attributeNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the attribute.
    if (present(attributeName)) then
       attributeNameActual=attributeName
    else
       attributeNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read attribute '"//trim(attributeNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an attribute, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeAttribute) then
       ! Object is the attribute.
       select type (thisObject)
       type is (hdf5Object)
       attributeObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(attributeName)) then
          message="attribute name was supplied for attribute object '"//trim(attributeName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an attribute name was supplied.
       if (.not.present(attributeName)) then
          message="attribute name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the attribute exists.
       if (.not.thisObject%hasAttribute(attributeName)) then
          message="attribute '"//trim(attributeName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the attribute.
       attributeObject=IO_HDF5_Open_Attribute(thisObject,attributeName)
    end if

    ! Get the datatype of this attribute.
    call h5aget_type_f(attributeObject%objectID,dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not get datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the size of the datatype.
    call h5tget_size_f(dataTypeID,dataTypeSize,errorCode)
    if (errorCode /= 0) then
       message="can not get size of datatype for '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not close datatype of '"//trim(attributeNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Call wrapper routine that will do the remainder of the read.
    call IO_HDF5_Read_Attribute_VarString_1D_Array_Static_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize)

    ! Close the attribute unless this was an attribute object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeAttribute) call attributeObject%close()

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Static

  subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Static_Do_Read(thisObject,attributeName,attributeValue,dataTypeSize)
    !% Open and read an varying string 1-D array attribute in {\normalfont \ttfamily thisObject} by creating a suitably-sized character variable into
    !% which it can be read.
    implicit none
    type     (varying_string  ), dimension(:)                   , intent(  out)           :: attributeValue
    class    (hdf5Object      )                                 , intent(inout)           :: thisObject
    character(len=*           )                                 , intent(in   ), optional :: attributeName
    integer  (kind=SIZE_T     )                                 , intent(in   )           :: dataTypeSize
    character(len=dataTypeSize), dimension(size(attributeValue))                          :: temporaryBuffer

    ! Call the character version of this routine to perform the red.
    call IO_HDF5_Read_Attribute_Character_1D_Array_Static(thisObject,attributeName,temporaryBuffer)

    ! Transfer the results to the varying string variable.
    attributeValue=temporaryBuffer

    return
  end subroutine IO_HDF5_Read_Attribute_VarString_1D_Array_Static_Do_Read

  logical function IO_HDF5_Has_Attribute(thisObject,attributeName)
    !% Check if {\normalfont \ttfamily thisObject} has an attribute with the given {\normalfont \ttfamily attributeName}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(in   ) :: thisObject
    character(len=*         ), intent(in   ) :: attributeName
    integer                                  :: errorCode
    type     (varying_string)                :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="object '"//thisObject%objectName//"' in not open"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object exists.
    call h5aexists_f(thisObject%objectID,trim(attributeName),IO_HDF5_Has_Attribute,errorCode)
    if (errorCode /= 0) then
       message="unable to check for attribute '"//trim(attributeName)//"' in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end function IO_HDF5_Has_Attribute

  subroutine IO_HDF5_Assert_Attribute_Type(attributeObject,attributeAssertedType,attributeAssertedRank,matches)
    !% Asserts that an attribute is of a certain type and rank.
    use Galacticus_Error
    implicit none
    class  (hdf5Object    )              , intent(in   )           :: attributeObject
    integer                              , intent(in   )           :: attributeAssertedRank
    integer(kind=HID_T    ), dimension(:), intent(in   )           :: attributeAssertedType
    logical                              , intent(  out), optional :: matches
    integer                                                        :: attributeRank        , errorCode
    integer(kind=HID_T    )                                        :: attributeDataspaceID , attributeTypeID
    logical                                                        :: isCorrectType
    integer                                                        :: iType
    type   (varying_string)                                        :: message

    ! Set the return value if present.
    if (present(matches)) matches=.true.

    ! Check the attribute type
    call h5aget_type_f(attributeObject%objectID,attributeTypeID,errorCode)
    if (errorCode /= 0) then
       message="unable to get datatype of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    isCorrectType=.false. ! Assume that it is of the incorrect type by default.
    do iType=1,size(attributeAssertedType)
       call h5tequal_f(attributeTypeID,attributeAssertedType(iType),isCorrectType,errorCode)
       if (errorCode /= 0) then
          message="unable to test datatype of attribute '"//attributeObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If a suitable type match has been found, exit the loop.
       if (isCorrectType) exit
    end do
    call h5tclose_f(attributeTypeID,errorCode)
    if (errorCode /= 0) then
       message="unable to close datatype of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (.not.isCorrectType) then
       if (present(matches)) then
          matches=.false.
          return
       else
          message="attribute '"//attributeObject%objectName//"' is of incorrect type"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the attribute has the correct rank.
    call h5aget_space_f(attributeObject%objectID,attributeDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_ndims_f(attributeDataspaceID,attributeRank,errorCode)
    if (errorCode /= 0) then
       message="unable to get rank of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(attributeDataspaceID,errorCode)
     if (errorCode /= 0) then
       message="unable to close dataspace of attribute '"//attributeObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (attributeRank /= attributeAssertedRank) then
       if (present(matches)) then
          matches=.false.
          return
       else
          message="attribute '"//attributeObject%objectName//"' has incorrect rank"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    return
  end subroutine IO_HDF5_Assert_Attribute_Type

  !! Dataset routines.

  function IO_HDF5_Dataset_Size(datasetObject,dim)
    !% Return the size of the {\normalfont \ttfamily dim}$^\mathrm{th}$ dimension of dataset {\normalfont \ttfamily datasetObject}.
    use Galacticus_Error
    implicit none
    integer(kind=HSIZE_T  )                              :: IO_HDF5_Dataset_Size
    class  (hdf5Object    ), intent(in   )               :: datasetObject
    integer                , intent(in   )               :: dim
    integer(kind=HSIZE_T  ), allocatable  , dimension(:) :: dimensions          , maximumDimensions
    integer                                              :: datasetRank         , errorCode
    integer(kind=HID_T    )                              :: datasetDataspaceID
    type   (varying_string)                              :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Ensure that the object is a dataset.
    if (datasetObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="object is not a dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the dataset is open.
    if (.not.datasetObject%isOpenValue) then
       message="attempt to get size of unopen dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the rank of the dataset
    call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_ndims_f(datasetDataspaceID,datasetRank,errorCode)
    if (errorCode /= 0) then
       message="unable to get rank of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (datasetRank < dim) then
       message="dataset '"//datasetObject%objectName//"' has rank smaller than the dimension requested"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dimensions of the dataspace.
    allocate  (       dimensions(datasetRank))
    allocate  (maximumDimensions(datasetRank))
    call h5sget_simple_extent_dims_f(datasetDataspaceID,dimensions,maximumDimensions,errorCode)
    if (errorCode == -1) then
       message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    IO_HDF5_Dataset_Size=dimensions(dim)
    deallocate(       dimensions             )
    deallocate(maximumDimensions             )

    ! Close the dataspace
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end function IO_HDF5_Dataset_Size

  integer function IO_HDF5_Dataset_Rank(datasetObject)
    !% Return the rank of dataset {\normalfont \ttfamily datasetObject}.
    use Galacticus_Error
    implicit none
    class  (hdf5Object    ), intent(in   )               :: datasetObject
    integer                                              :: datasetRank         , errorCode
    integer(kind=HID_T    )                              :: datasetDataspaceID
    type   (varying_string)                              :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Ensure that the object is a dataset.
    if (datasetObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="object is not a dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Ensure that the dataset is open.
    if (.not.datasetObject%isOpenValue) then
       message="attempt to get size of unopen dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the rank of the dataset
    call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_ndims_f(datasetDataspaceID,datasetRank,errorCode)
    if (errorCode /= 0) then
       message="unable to get rank of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
  
    ! Return the rank.
    IO_HDF5_Dataset_Rank=datasetRank
    return
  end function IO_HDF5_Dataset_Rank

  function IO_HDF5_Open_Dataset(inObject,datasetName,commentText,datasetDataType,datasetDimensions,isOverwritable,appendTo&
       &,useDataType,chunkSize,compressionLevel) result(datasetObject)
    !% Open an dataset in {\normalfont \ttfamily inObject}.
    use Galacticus_Error
    implicit none
    type     (hdf5Object    )                                        :: datasetObject
    character(len=*         )              , intent(in   )           :: datasetName
    character(len=*         )              , intent(in   ), optional :: commentText
    integer                                , intent(in   ), optional :: chunkSize               , compressionLevel       , &
         &                                                              datasetDataType
    integer  (kind=HSIZE_T  ), dimension(:), intent(in   ), optional :: datasetDimensions
    logical                                , intent(in   ), optional :: appendTo                , isOverwritable
    integer  (kind=HID_T    )              , intent(in   ), optional :: useDataType
    class    (hdf5Object    )              , intent(in   ), target   :: inObject
    integer  (kind=HSIZE_T  ), dimension(7)                          :: chunkDimensions         , datasetDimensionsActual, &
         &                                                              datasetDimensionsMaximum
    integer  (kind=HSIZE_T  )                                        :: chunkSizeActual
    integer                                                          :: compressionLevelActual  , datasetRank            , &
         &                                                              errorCode
    integer  (kind=HID_T    )                                        :: dataSpaceID             , dataTypeID             , &
         &                                                              locationID              , propertyList
    logical                                                          :: appendToActual
    type     (varying_string)                                        :: locationPath            , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Ensure that the object is already open.
    if (inObject%isOpenValue) then
       locationID  =inObject%objectID
       locationPath=inObject%objectLocation//"/"//inObject%objectName
       select type (inObject)
       type is (hdf5Object)
       datasetObject%parentObject => inObject
    end select
    else
       message="attempt to open dataset '"//trim(datasetName)//"' in unopen object '"//inObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine the rank and dimensions.
    if (present(datasetDimensions)) then
       ! Open data space with the desired dimensions.
       datasetRank=size(datasetDimensions)
       if (datasetRank > 7) then
          message="datasets of rank greater than 7 are not supported - dataset in question is '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       datasetDimensionsActual(1:datasetRank)=datasetDimensions
    else
       ! No dimensions specified, assume a scalar.
       datasetRank=0
    end if

    ! Check whether appending was requested.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if

    ! Check if the dataset exists.
    if (inObject%hasDataset(datasetName)) then
       ! Open the dataset.
       call h5dopen_f(locationID,trim(datasetName),datasetObject%objectID,errorCode)
       if (errorCode /= 0) then
          message="failed to open dataset '"//trim(datasetName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5dget_create_plist_f(datasetObject%objectID,propertyList,errorCode)
       if (errorCode /= 0) then
          message="failed to get creation property list for dataset '"//trim(datasetName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5eset_auto_f(0,errorCode)
       if (errorCode /= 0) then
          message="failed to switch HDF5 error report off"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5pget_chunk_f(propertyList,1,chunkDimensions,errorCode)
       if (errorCode < 0) then
          ! Assume that a failed attempt to get chunk size indicates that the dataset is not chunked.
          datasetObject%chunkSize=-1
       else
          datasetObject%chunkSize=int(chunkDimensions(1))
       end if
       call h5eset_auto_f(1,errorCode)
       if (errorCode /= 0) then
          message="failed to switch HDF5 error report on"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5pclose_f(propertyList,errorCode)
       if (errorCode /= 0) then
          message="failed to close property list for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Determine maximum dimensions of this dataset.
       select case (appendToActual)
       case (.true. )
          datasetDimensionsMaximum=H5S_UNLIMITED_F
       case (.false.)
          datasetDimensionsMaximum=datasetDimensionsActual
       end select
       ! Create a suitable dataspace.
       call h5screate_simple_f(datasetRank,datasetDimensionsActual,dataspaceID,errorCode,datasetDimensionsMaximum)
       if (errorCode < 0) then
          message="unable to open dataspace for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the chunking level.
       if (present(chunkSize)) then
          ! Check that chunk size is valid.
          if (chunkSize == 0 .or. chunkSize < -1) then
             message="invalid chunk size for dataset '"//trim(datasetName)//"' at "//locationPath
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          chunkSizeActual=chunkSize
       else
          ! No chunk size explicitly provided. Inherit that of parent object if possible, otherwise use default.
          if (inObject%chunkSizeSet) then
             chunkSizeActual=inObject%chunkSize
          else
             chunkSizeActual=hdf5ChunkSize
          end if
       end if
       datasetObject%chunkSize=int(chunkSizeActual)
       ! Determine the compression level.
       if (present(compressionLevel)) then
          ! Check that compression level is valid.
          if (compressionLevel == 0 .or. compressionLevel < -1) then
             message="invalid compression level for dataset '"//trim(datasetName)//"' at "//locationPath
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          compressionLevelActual=compressionLevel
       else
          ! No compression level explicitly provided. Inherit that of parent object if possible, otherwise use default.
          if (inObject%compressionLevelSet) then
             compressionLevelActual=inObject%compressionLevel
          else
             compressionLevelActual=hdf5CompressionLevel
          end if
       end if
       datasetObject%compressionLevel=compressionLevelActual
       ! Create a property list for the dataset.
       call h5pcreate_f(H5P_DATASET_CREATE_F,propertyList,errorCode)
       if (errorCode < 0) then
          message="unable to create property list for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check if chunk size needs to be set.
       if (chunkSizeActual /= -1) then
          ! It does - determine a suitable chunk size.
          if (appendToActual) then
             ! Extensible dataset, use selected chunk size.
             chunkDimensions   =1
             chunkDimensions(1)=chunkSizeActual
          else
             ! Fixed dimension array, use smaller of chunk size and actual size.
             chunkDimensions(1:datasetRank)=min(datasetDimensionsActual(1:datasetRank),chunkSizeActual)
          end if
          call h5pset_chunk_f(propertyList,datasetRank,chunkDimensions,errorCode)
          if (errorCode < 0) then
             message="unable to set chunk size for dataset '"//trim(datasetName)//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! No chunk size was specified. This is problematic if the dataset is appendable.
          if (appendToActual) then
             message="appendable dataset '"//trim(datasetName)//"' requires a chunk size"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if

       ! Check if compression level should be set.
       if (compressionLevelActual >= 0) then
          call h5pset_deflate_f(propertyList,compressionLevelActual,errorCode)
          if (errorCode < 0) then
             message="could not set compression level for dataset '"//trim(datasetName)//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
       ! Ensure that a data type was specified.
       if (.not.present(datasetDataType)) then
          message="no datatype was specified for dataset '"//trim(datasetName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the data type.
       if (present(useDataType)) then
          dataTypeID=useDataType
       else
          select case (datasetDataType)
          case (hdf5DataTypeInteger  )
             dataTypeID=H5T_NATIVE_INTEGER
          case (hdf5DataTypeInteger8 )
             dataTypeID=H5T_NATIVE_INTEGER_8
          case (hdf5DataTypeDouble   )
             dataTypeID=H5T_NATIVE_DOUBLE
          case (hdf5DataTypeCharacter)
             dataTypeID=H5T_NATIVE_CHARACTER
          end select
       end if
       ! Create the dataset.
       call h5dcreate_f(locationID,trim(datasetName),dataTypeID,dataSpaceID,datasetObject%objectID,errorCode,propertyList)
       if (errorCode /= 0) then
          message="failed to create dataset '"//trim(datasetName)//"' at "//locationPath
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Close the dataspace.
       call h5sclose_f(dataSpaceID,errorCode)
       if (errorCode /= 0) then
          message="failed to close dataspace for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Close the property list.
       call h5pclose_f(propertyList,errorCode)
       if (errorCode /= 0) then
          message="failed to close property list for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Set the comment for this dataset.
    if (present(commentText)) then
       call h5gset_comment_f(datasetObject%objectID,'.',trim(commentText),errorCode)
       if (errorCode < 0) then
          message="failed to set comment for dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Mark this object as open.
    datasetObject%isOpenValue=.true.

    ! Mark this object as a file object.
    datasetObject%hdf5ObjectType=hdf5ObjectTypeDataset

    ! Store the name and location of the object.
    datasetObject%objectName=trim(datasetName)
    datasetObject%objectLocation=datasetObject%parentObject%pathTo()

    ! Mark whether dataset is overwritable.
    if (present(isOverwritable)) then
       ! Check overwriting is not requested if parent is not overwritable.
       if (isOverwritable.and..not.datasetObject%parentObject%isOverwritable) then
          message="cannot make dataset '"//trim(datasetName)//"' overwritable as objects in parent '"&
               &//datasetObject%parentObject%objectName//"' are not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       datasetObject%isOverwritable=isOverwritable
    else
       datasetObject%isOverwritable=datasetObject%parentObject%isOverwritable
    end if
    return
  end function IO_HDF5_Open_Dataset

  logical function IO_HDF5_Has_Dataset(thisObject,datasetName)
    !% Check if {\normalfont \ttfamily thisObject} has a dataset with the given {\normalfont \ttfamily datasetName}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(in   ) :: thisObject
    character(len=*         ), intent(in   ) :: datasetName
    integer                                  :: errorCode
    integer  (kind=HID_T    )                :: datasetID
    type     (varying_string)                :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="object '"//thisObject%objectName//"' in not open"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object exists.
    call h5eset_auto_f(0,errorCode)
    if (errorCode /= 0) then
       message="failed to switch HDF5 error report off"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5dopen_f(thisObject%objectID,trim(datasetName),datasetID,errorCode)
    IO_HDF5_Has_Dataset=(errorCode == 0)
    call h5eset_auto_f(1,errorCode)
    if (errorCode /= 0) then
       message="failed to switch HDF5 error report on"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (IO_HDF5_Has_Dataset) then
       call h5dclose_f(datasetID,errorCode)
       if (errorCode /= 0) then
          message="failed to close dataset '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    return
  end function IO_HDF5_Has_Dataset

  subroutine IO_HDF5_Assert_Dataset_Type(datasetObject,datasetAssertedType,datasetAssertedRank)
    !% Asserts that an dataset is of a certain type and rank.
    use Galacticus_Error
    implicit none
    class  (hdf5Object    )              , intent(in   ) :: datasetObject
    integer                              , intent(in   ) :: datasetAssertedRank
    integer(kind=HID_T    ), dimension(:), intent(in   ) :: datasetAssertedType
    integer                                              :: datasetRank        , errorCode
    integer(kind=HID_T    )                              :: datasetDataspaceID , datasetTypeID
    logical                                              :: isCorrectType
    integer                                              :: iType
    type   (varying_string)                              :: message

    ! Check the dataset type
    call h5dget_type_f(datasetObject%objectID,datasetTypeID,errorCode)
    if (errorCode /= 0) then
       message="unable to get datatype of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    isCorrectType=.false. ! Assume that it is of the incorrect type by default.
    do iType=1,size(datasetAssertedType)
       call h5tequal_f(datasetTypeID,datasetAssertedType(iType),isCorrectType,errorCode)
       if (errorCode /= 0) then
          message="unable to test datatype of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If a suitable type match has been found, exit the loop.
       if (isCorrectType) exit
    end do
    call h5tclose_f(datasetTypeID,errorCode)
    if (errorCode /= 0) then
       message="unable to close datatype of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (.not.isCorrectType) then
       message="dataset '"//datasetObject%objectName//"' is of incorrect type"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset has the correct rank.
    call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sget_simple_extent_ndims_f(datasetDataspaceID,datasetRank,errorCode)
    if (errorCode /= 0) then
       message="unable to get rank of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    if (datasetRank /= datasetAssertedRank) then
       message="dataset '"//datasetObject%objectName//"' has incorrect rank"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Assert_Dataset_Type

  subroutine IO_HDF5_Write_Dataset_Integer_1D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write an integer 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: commentText                , datasetName
    integer                  , dimension(:), intent(in   )           :: datasetValue
    logical                                , intent(in   ), optional :: appendTo
    integer                                , intent(in   ), optional :: chunkSize                  , compressionLevel
    type     (hdf5Object    )              , intent(  out), optional :: datasetReturned
    integer  (kind=HSIZE_T  ), dimension(1)                          :: datasetDimensions          , hyperslabCount      , &
         &                                                              hyperslabStart             , newDatasetDimensions, &
         &                                                              newDatasetDimensionsMaximum
    integer                                                          :: datasetRank                , errorCode
    integer  (kind=HID_T    )                                        :: dataspaceID                , newDataspaceID
    logical                                                          :: appendToActual             , preExisted
    type     (hdf5Object    )                                        :: datasetObject
    type     (varying_string)                                        :: datasetNameActual          , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D integer.
          call thisObject%assertDatasetType(H5T_NATIVE_INTEGERS,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeInteger,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 1D integer.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,1)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=1
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Integer_1D
  
  subroutine IO_HDF5_Write_Dataset_Integer_2D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write an integer 2-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )                , intent(inout)           :: thisObject
    character(len=*         )               , intent(in   ), optional :: commentText                , datasetName
    integer                  , dimension(:,:), intent(in   )           :: datasetValue
    logical                                  , intent(in   ), optional :: appendTo
    integer                                  , intent(in   ), optional :: chunkSize                  , compressionLevel
    type     (hdf5Object    )                , intent(  out), optional :: datasetReturned
    integer  (kind=HSIZE_T  ), dimension(2  )                          :: datasetDimensions          , hyperslabCount      , &
         &                                                                hyperslabStart             , newDatasetDimensions, &
         &                                                                newDatasetDimensionsMaximum
    integer                                                            :: datasetRank                , errorCode
    integer  (kind=HID_T    )                                          :: dataspaceID                , newDataspaceID
    logical                                                            :: appendToActual             , preExisted
    type     (hdf5Object    )                                          :: datasetObject
    type     (varying_string)                                          :: datasetNameActual          , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 2D integer.
          call thisObject%assertDatasetType(H5T_NATIVE_INTEGERS,2)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeInteger,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 2D integer.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,2)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=2
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Integer_2D
  
  subroutine IO_HDF5_Read_Dataset_Integer_1D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read an integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    integer                     , dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object       )              , intent(inout)           :: thisObject
    character(len=*            )              , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     ), dimension(1), intent(in   ), optional :: readBegin         , readCount
    integer  (kind=HSIZE_T     ), dimension(1)                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                 referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save        , target                  :: referencedRegion
    integer                                                             :: errorCode
    integer  (kind=HID_T       )                                        :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                 memorySpaceID     , storedDatasetID
    logical                                                             :: isReference       , readSubsection
    type     (hdf5Object       )                                        :: datasetObject
    type     (varying_string   )                                        :: datasetNameActual , message
    type     (c_ptr            )                                        :: dataBuffer
    
    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D integer array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,1)

    ! Get the dimensions of the array to be read.
    storedDatasetID=0
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer_1D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Integer_1D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read an integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer                     , allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object       )                           , intent(inout)           :: thisObject
    character(len=*            )                           , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     )             , dimension(1), intent(in   ), optional :: readBegin         , readCount
    integer  (kind=HSIZE_T     )             , dimension(1)                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                              referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save       , target                                :: referencedRegion
    integer                                                                          :: errorCode
    integer  (kind=HID_T       )                                                     :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                              memorySpaceID     , storedDatasetID
    logical                                                                          :: isReference       , readSubsection
    type     (hdf5Object       )                                                     :: datasetObject
    type     (varying_string   )                                                     :: datasetNameActual , message
    type     (c_ptr            )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D integer array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))
    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if

    return
  end subroutine IO_HDF5_Read_Dataset_Integer_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Dataset_Integer_2D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read an integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    integer                     , dimension(:,:), intent(  out)           :: datasetValue
    class    (hdf5Object       )                , intent(inout)           :: thisObject
    character(len=*            )                , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     ), dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer  (kind=HSIZE_T     ), dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                   referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save          , target                  :: referencedRegion
    integer                                                               :: errorCode
    integer  (kind=HID_T       )                                          :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                   memorySpaceID     , storedDatasetID
    logical                                                               :: isReference       , readSubsection
    type     (hdf5Object       )                                          :: datasetObject
    type     (varying_string   )                                          :: datasetNameActual , message
    type     (c_ptr            )                                          :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D integer array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,2)

    ! Get the dimensions of the array to be read.
    storedDatasetID=0
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer_2D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Integer_2D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read an integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer                     , allocatable, dimension(:,:), intent(  out)           :: datasetValue
    class    (hdf5Object       )                             , intent(inout)           :: thisObject
    character(len=*            )                             , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     )             , dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer  (kind=HSIZE_T     )             , dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save         , target                                :: referencedRegion
    integer                                                                            :: errorCode
    integer  (kind=HID_T       )                                                       :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                memorySpaceID     , storedDatasetID
    logical                                                                            :: isReference       , readSubsection
    type     (hdf5Object       )                                                       :: datasetObject
    type     (varying_string   )                                                       :: datasetNameActual , message
    type     (c_ptr            )                                                       :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D integer array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGERS,2)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))
    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_INTEGER,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if

    return
  end subroutine IO_HDF5_Read_Dataset_Integer_2D_Array_Allocatable
  
  subroutine IO_HDF5_Write_Dataset_Integer8_1D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a long integer 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Kind_Numbers
    use Memory_Management
    implicit none
    class    (hdf5Object    )                           , intent(inout)                   :: thisObject
    character(len=*         )                           , intent(in   ), optional         :: commentText                , datasetName
    integer  (kind=kind_int8)             , dimension(:), intent(in   )                   :: datasetValue
    logical                                             , intent(in   ), optional         :: appendTo
    integer                                             , intent(in   ), optional         :: chunkSize                  , compressionLevel
    type     (hdf5Object    )                           , intent(  out), optional         :: datasetReturned
    integer  (kind=kind_int8), allocatable, dimension(:)                         , target :: datasetValueContiguous
    integer  (kind=HSIZE_T  )             , dimension(1)                                  :: datasetDimensions          , hyperslabCount      , &
         &                                                                                   hyperslabStart             , newDatasetDimensions, &
         &                                                                                   newDatasetDimensionsMaximum
    integer                                                                               :: datasetRank                , errorCode
    integer  (kind=HID_T    )                                                             :: dataspaceID                , newDataspaceID
    logical                                                                               :: appendToActual             , preExisted
    type     (hdf5Object    )                                                             :: datasetObject
    type     (varying_string)                                                             :: datasetNameActual          , message
    type     (c_ptr         )                                                             :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D long integer.
          call thisObject%assertDatasetType(H5T_NATIVE_INTEGER_8S,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeInteger8,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 1D long integer.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8S,1)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=1
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call allocateArray(datasetValueContiguous,shape(datasetValue))
    datasetValueContiguous=datasetValue
    dataBuffer=c_loc(datasetValueContiguous)
    errorCode=h5dwrite(datasetObject%objectID,H5T_NATIVE_INTEGER_8,newDataspaceID,dataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call deallocateArray(datasetValueContiguous)

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Integer8_1D

  subroutine IO_HDF5_Write_Dataset_Integer8_2D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a long integer 2-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Kind_Numbers
    use Memory_Management
    implicit none
    class    (hdf5Object    )                             , intent(inout)                   :: thisObject
    character(len=*         )                             , intent(in   ), optional         :: commentText                , datasetName
    integer  (kind=kind_int8)             , dimension(:,:), intent(in   )                   :: datasetValue
    logical                                               , intent(in   ), optional         :: appendTo
    integer                                               , intent(in   ), optional         :: chunkSize                  , compressionLevel
    type     (hdf5Object    )                             , intent(  out), optional         :: datasetReturned
    integer  (kind=kind_int8), allocatable, dimension(:,:)                         , target :: datasetValueContiguous
    integer  (kind=HSIZE_T  )             , dimension(2  )                                  :: datasetDimensions          , hyperslabCount      , &
         &                                                                                     hyperslabStart             , newDatasetDimensions, &
         &                                                                                     newDatasetDimensionsMaximum
    integer                                                                                 :: datasetRank                , errorCode
    integer  (kind=HID_T    )                                                               :: dataspaceID                , newDataspaceID
    logical                                                                                 :: appendToActual             , preExisted
    type     (hdf5Object    )                                                               :: datasetObject
    type     (varying_string)                                                               :: datasetNameActual          , message
    type     (c_ptr         )                                                               :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 2D long integer.
          call thisObject%assertDatasetType(H5T_NATIVE_INTEGER_8S,2)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeInteger8,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 2D long integer.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8S,2)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=2
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call allocateArray(datasetValueContiguous,shape(datasetValue))
    datasetValueContiguous=datasetValue
    dataBuffer=c_loc(datasetValueContiguous)
    errorCode=h5dwrite(datasetObject%objectID,H5T_NATIVE_INTEGER_8,newDataspaceID,dataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call deallocateArray(datasetValueContiguous)

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Integer8_2D
  
  subroutine IO_HDF5_Read_Dataset_Integer8_1D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a long integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Kind_Numbers
    use Memory_Management
    implicit none
    integer  (kind=kind_int8   )             , dimension(:)          , intent(  out)           :: datasetValue
    class    (hdf5Object       )                                     , intent(inout)           :: thisObject
    character(len=*            )                                     , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     )             , dimension(1)          , intent(in   ), optional :: readBegin             , readCount
    integer  (kind=HSIZE_T     )             , dimension(:)          , intent(in   ), optional :: readSelection
    integer  (kind=HSIZE_T     )             , dimension(1)                                    :: datasetDimensions     , datasetMaximumDimensions, &
         &                                                                                        referenceEnd          , referenceStart
    integer  (kind=HSIZE_T     ), allocatable, dimension(:,:)                                  :: readSelectionMap
    integer  (kind=kind_int8   ), allocatable, dimension(:)  , target                          :: datasetValueContiguous
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save                       , target                          :: referencedRegion
    integer                                                                                    :: errorCode             , i
    integer  (kind=HID_T       )                                                               :: datasetDataspaceID    , dereferencedObjectID    , &
         &                                                                                        memorySpaceID         , storedDatasetID
    logical                                                                                    :: isReference           , readSubsection
    type     (hdf5Object       )                                                               :: datasetObject
    type     (varying_string   )                                                               :: datasetNameActual     , message
    type     (c_ptr            )                                                               :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D integer8 array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8AS,1)

    ! Get the dimensions of the array to be read.
    storedDatasetID=0
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(1))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(1,size(readSelection)))
          forall(i=1:size(readSelection))
             readSelectionMap(:,i)=[readSelection(i)]
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,1,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)          
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(1)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(1))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(1,size(readSelection)))
          forall(i=1:size(readSelection))
             readSelectionMap(:,i)=[readSelection(i)]
          end forall
          ! Create selection.          
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,1,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(1)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call allocateArray(datasetValueContiguous,shape(datasetValue))
    dataBuffer=c_loc(datasetValueContiguous)
    errorCode=h5dread(datasetObject%objectID,H5T_NATIVE_INTEGER_8,memorySpaceID,datasetDataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    datasetValue=datasetValueContiguous
    call deallocateArray(datasetValueContiguous)

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer8_1D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Integer8_1D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a long integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Kind_Numbers
    use Memory_Management
    implicit none
    integer  (kind=kind_int8   ), allocatable, dimension(:), intent(  out)          , target :: datasetValue
    class    (hdf5Object       )                           , intent(inout)                   :: thisObject
    character(len=*            )                           , intent(in   ), optional         :: datasetName
    integer  (kind=HSIZE_T     )             , dimension(1), intent(in   ), optional         :: readBegin         , readCount
    integer  (kind=HSIZE_T     )             , dimension(1)                                  :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                      referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save                                              , target :: referencedRegion
    integer                                                                                  :: errorCode
    integer  (kind=HID_T       )                                                             :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                      memorySpaceID     , storedDatasetID
    logical                                                                                  :: isReference       , readSubsection
    type     (hdf5Object       )                                                             :: datasetObject
    type     (varying_string   )                                                             :: datasetNameActual , message
    type     (c_ptr            )                                                             :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D long integer array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8AS,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    dataBuffer=c_loc(datasetValue)
    errorCode=h5dread(datasetObject%objectID,H5T_NATIVE_INTEGER_8,memorySpaceID,datasetDataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer8_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Dataset_Integer8_2D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Kind_Numbers
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer         (kind_int8        ), dimension(:,:), intent(  out), target   :: datasetValue
    class           (hdf5Object       )                , intent(inout)           :: thisObject
    character       (len=*            )                , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     ), dimension(:  ), intent(in   ), optional :: readSelection
    integer         (kind=HSIZE_T     ), dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                          referenceEnd      , referenceStart
    integer         (kind=HSIZE_T     ), dimension(:,:), allocatable             :: readSelectionMap
    integer         (kind=kind_int8   ), dimension(:,:), allocatable, target     :: datasetValueContiguous
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save          , target                  :: referencedRegion
    integer                                                                      :: errorCode
    integer         (kind=HID_T       )                                          :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                          memorySpaceID     , storedDatasetID
    integer         (kind=HSIZE_T     )                                          :: i                 , j
    logical                                                                      :: isReference       , readSubsection
    type            (hdf5Object       )                                          :: datasetObject
    type            (varying_string   )                                          :: datasetNameActual , message
    type            (c_ptr            )                                          :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8AS,2)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.          
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
           ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    
    ! Read the dataset.
    call allocateArray(datasetValueContiguous,shape(datasetValue))
    dataBuffer=c_loc(datasetValueContiguous)
    errorCode=h5dread(datasetObject%objectID,H5T_NATIVE_INTEGER_8,memorySpaceID,datasetDataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    datasetValue=datasetValueContiguous
    call deallocateArray(datasetValueContiguous)

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer8_2D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Integer8_2D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a double 2-D array dataset in {\normalfont \ttfamily thisObject}.
    use Kind_Numbers
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer         (kind_int8        ), allocatable, dimension(:,:), intent(  out), target   :: datasetValue
    class           (hdf5Object       )                             , intent(inout)           :: thisObject
    character       (len=*            )                             , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(:  ), intent(in   ), optional :: readSelection
    integer         (kind=HSIZE_T     )             , dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                       referenceEnd      , referenceStart
    integer         (kind=HSIZE_T     ), allocatable, dimension(:,:)                          :: readSelectionMap
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                  :: referencedRegion
    integer                                                                                   :: errorCode
    integer         (kind=HID_T       )                                                       :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                       memorySpaceID     , storedDatasetID
    integer         (kind=HSIZE_T     )                                                       :: i                 , j
    logical                                                                                   :: isReference       , readSubsection
    type            (hdf5Object       )                                                       :: datasetObject
    type            (varying_string   )                                                       :: datasetNameActual , message
    type            (c_ptr            )                                                       :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_INTEGER_8AS,2)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.          
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
           ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.         
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)         
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    dataBuffer=c_loc(datasetValue)
    errorCode=h5dread(datasetObject%objectID,H5T_NATIVE_INTEGER_8,memorySpaceID,datasetDataspaceID,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Integer8_2D_Array_Allocatable
  
  subroutine IO_HDF5_Write_Dataset_Double_1D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )              , intent(inout)           :: thisObject
    character       (len=*         )              , intent(in   ), optional :: commentText                , datasetName
    double precision                , dimension(:), intent(in   )           :: datasetValue
    logical                                       , intent(in   ), optional :: appendTo
    integer                                       , intent(in   ), optional :: chunkSize                  , compressionLevel
    type            (hdf5Object    )              , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(1)                          :: datasetDimensions          , hyperslabCount      , &
         &                                                                     hyperslabStart             , newDatasetDimensions, &
         &                                                                     newDatasetDimensionsMaximum
    integer                                                                 :: datasetRank                , errorCode
    integer         (kind=HID_T    )                                        :: dataspaceID                , newDataspaceID
    logical                                                                 :: appendToActual             , preExisted
    type            (hdf5Object    )                                        :: datasetObject
    type            (varying_string)                                        :: datasetNameActual          , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,1)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 1D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,1)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=1
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_1D

  subroutine IO_HDF5_Read_Dataset_Double_1D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:)  , intent(  out)           :: datasetValue
    class           (hdf5Object       )                , intent(inout)           :: thisObject
    character       (len=*            )                , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(1)  , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     ), dimension(:)  , intent(in   ), optional :: readSelection
    integer         (kind=HSIZE_T     ), dimension(1)                            :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                          referenceEnd      , referenceStart
    integer         (kind=HSIZE_T     ), dimension(:,:), allocatable             :: readSelectionMap
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save          , target                  :: referencedRegion
    integer                                                                      :: errorCode         , i
    integer         (kind=HID_T       )                                          :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                          memorySpaceID     , storedDatasetID
    logical                                                                      :: isReference       , readSubsection
    type            (hdf5Object       )                                          :: datasetObject
    type            (varying_string   )                                          :: datasetNameActual , message
    type            (c_ptr            )                                          :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(1))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
                   ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(1,size(readSelection)))
          forall(i=1:size(readSelection))
             readSelectionMap(:,i)=[readSelection(i)]
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,1,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(1)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(1))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(1,size(readSelection)))
          forall(i=1:size(readSelection))
             readSelectionMap(:,i)=[readSelection(i)]
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,1,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(1)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_1D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_1D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                           , intent(inout)           :: thisObject
    character       (len=*            )                           , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(1), intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(1)                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                     referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                :: referencedRegion
    integer                                                                                 :: errorCode
    integer         (kind=HID_T       )                                                     :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                     memorySpaceID     , storedDatasetID
    logical                                                                                 :: isReference       , readSubsection
    type            (hdf5Object       )                                                     :: datasetObject
    type            (varying_string   )                                                     :: datasetNameActual , message
    type            (c_ptr            )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_1D_Array_Allocatable

  subroutine IO_HDF5_Write_Dataset_Double_2D(thisObject,datasetValue,datasetName,commentText,appendTo,appendDimension,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 2-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                , intent(inout)           :: thisObject
    character       (len=*         )                , intent(in   ), optional :: commentText                 , datasetName
    double precision                , dimension(:,:), intent(in   )           :: datasetValue
    logical                                         , intent(in   ), optional :: appendTo
    integer                                         , intent(in   ), optional :: appendDimension             , chunkSize                  , &
         &                                                                       compressionLevel
    type            (hdf5Object    )                , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(2)                            :: datasetDimensions           , hyperslabCount             , &
         &                                                                       hyperslabStart              , newDatasetDimensions       , &
         &                                                                       newDatasetDimensionsFiltered, newDatasetDimensionsMaximum
    integer                                                                   :: appendDimensionActual       , datasetRank                , &
         &                                                                       errorCode
    integer         (kind=HID_T    )                                          :: dataspaceID                 , newDataspaceID
    logical                                                                   :: appendToActual              , preExisted
    type            (hdf5Object    )                                          :: datasetObject
    type            (varying_string)                                          :: datasetNameActual           , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 2D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,2)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 2D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,2)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the dimension for appending.
       appendDimensionActual=1
       if (present(appendDimension)) appendDimensionActual=appendDimension
       ! Ensure that all dimensions other than the one being appended to are of the same size.
       newDatasetDimensionsFiltered                       =newDatasetDimensions
       newDatasetDimensionsFiltered(appendDimensionActual)=dataSetDimensions   (appendDimensionActual)
       if (any(dataSetDimensions /= newDatasetDimensionsFiltered)) then
          message="when appending to dataset '"//trim(datasetNameActual)//"' all dimensions other than that being appended to must be same as original dataset"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Set the hyperslab.
       hyperslabStart                             =0
       hyperslabStart      (appendDimensionActual)=newDatasetDimensions(appendDimensionActual)
       hyperslabCount                             =dataSetDimensions
       newDatasetDimensions(appendDimensionActual)=newDatasetDimensions(appendDimensionActual)+datasetDimensions(appendDimensionActual)
    else
       newDatasetDimensions                       =datasetDimensions
       hyperslabStart                             =0
       hyperslabCount                             =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=2
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_2D

  subroutine IO_HDF5_Read_Dataset_Double_2D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                , intent(inout)           :: thisObject
    character       (len=*            )                , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     ), dimension(:  ), intent(in   ), optional :: readSelection
    integer         (kind=HSIZE_T     ), dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                          referenceEnd      , referenceStart
    integer         (kind=HSIZE_T     ), dimension(:,:), allocatable             :: readSelectionMap
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save          , target                  :: referencedRegion
    integer                                                                      :: errorCode
    integer         (kind=HID_T       )                                          :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                          memorySpaceID     , storedDatasetID
    integer         (kind=HSIZE_T     )                                          :: i                 , j
    logical                                                                      :: isReference       , readSubsection
    type            (hdf5Object       )                                          :: datasetObject
    type            (varying_string   )                                          :: datasetNameActual , message
    type            (c_ptr            )                                          :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,2)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.          
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
           ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_2D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_2D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount,readSelection)
    !% Open and read a double 2-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                             , intent(inout)           :: thisObject
    character       (len=*            )                             , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(2  ), intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(:  ), intent(in   ), optional :: readSelection
    integer         (kind=HSIZE_T     )             , dimension(2  )                          :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                       referenceEnd      , referenceStart
    integer         (kind=HSIZE_T     ), allocatable, dimension(:,:)                          :: readSelectionMap
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                  :: referencedRegion
    integer                                                                                   :: errorCode
    integer         (kind=HID_T       )                                                       :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                       memorySpaceID     , storedDatasetID
    integer         (kind=HSIZE_T     )                                                       :: i                 , j
    logical                                                                                   :: isReference       , readSubsection
    type            (hdf5Object       )                                                       :: datasetObject
    type            (varying_string   )                                                       :: datasetNameActual , message
    type            (c_ptr            )                                                       :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Only one of a subsection and a selection can be present.
    if (readSubsection.and.present(readSelection)) then
       message="can not specify both a subsection and selection of dataset '"//trim(datasetNameActual)//"' for reading"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 2D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,2)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.          
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else if (present(readSelection)) then
          ! A selection is to be read - create a suitable dataspace selection.
          ! Check that the selection is valid.
          if (any(readSelection < 1 .or. readSelection > datasetDimensions(2))) then
             message="requested selection extends outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
           ! Create a map for selecting elements if necessary.
          allocate(readSelectionMap(2,size(readSelection)*datasetDimensions(1)))
          forall(i=1:size(readSelection))
             forall(j=1:datasetDimensions(1))
                readSelectionMap(:,(i-1)*datasetDimensions(1)+j)=[j,readSelection(i)]
             end forall
          end forall
          ! Create selection.         
          call h5sselect_elements_f(datasetDataspaceID,H5S_SELECT_SET_F,2,size(readSelectionMap,dim=2,kind=size_t),readSelectionMap,errorCode)
          if (errorCode < 0) then
             message="could not select filespace selection for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          deallocate(readSelectionMap)         
          ! Set the size of the data to read in.
          datasetDimensions(2)=size(readSelection)
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(2,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_2D_Array_Allocatable

  subroutine IO_HDF5_Write_Dataset_Double_3D(thisObject,datasetValue,datasetName,commentText,appendTo,appendDimension,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 3-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                  , intent(inout)           :: thisObject
    character       (len=*         )                  , intent(in   ), optional :: commentText                 , datasetName
    double precision                , dimension(:,:,:), intent(in   )           :: datasetValue
    logical                                           , intent(in   ), optional :: appendTo
    integer                                           , intent(in   ), optional :: appendDimension             , chunkSize                  , &
         &                                                                         compressionLevel
    type            (hdf5Object    )                  , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(3)                              :: datasetDimensions           , hyperslabCount             , &
         &                                                                         hyperslabStart              , newDatasetDimensions       , &
         &                                                                         newDatasetDimensionsFiltered, newDatasetDimensionsMaximum
    integer                                                                     :: appendDimensionActual       , datasetRank                , &
         &                                                                         errorCode
    integer         (kind=HID_T    )                                            :: dataspaceID                 , newDataspaceID
    logical                                                                     :: appendToActual              , preExisted
    type            (hdf5Object    )                                            :: datasetObject
    type            (varying_string)                                            :: datasetNameActual           , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 3D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,3)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 3D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,3)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the dimension for appending.
       appendDimensionActual=1
       if (present(appendDimension)) appendDimensionActual=appendDimension
       ! Ensure that all dimensions other than the one being appended to are of the same size.
       newDatasetDimensionsFiltered                       =newDatasetDimensions
       newDatasetDimensionsFiltered(appendDimensionActual)=dataSetDimensions   (appendDimensionActual)
       if (any(dataSetDimensions /= newDatasetDimensionsFiltered)) then
          message="when appending to dataset '"//trim(datasetNameActual)//"' all dimensions other than that being appended to must be same as original dataset"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Set the hyperslab.
       hyperslabStart                             =0
       hyperslabStart      (appendDimensionActual)=newDatasetDimensions(appendDimensionActual)
       hyperslabCount                             =dataSetDimensions
       newDatasetDimensions(appendDimensionActual)=newDatasetDimensions(appendDimensionActual)+datasetDimensions(appendDimensionActual)
    else
       newDatasetDimensions   =datasetDimensions
       hyperslabStart         =0
       hyperslabCount         =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=3
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_3D

  subroutine IO_HDF5_Read_Dataset_Double_3D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                  , intent(inout)           :: thisObject
    character       (len=*            )                  , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(3)    , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     ), dimension(3)                              :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                            referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save            , target                  :: referencedRegion
    integer                                                                        :: errorCode
    integer         (kind=HID_T       )                                            :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                            memorySpaceID     , storedDatasetID
    logical                                                                        :: isReference       , readSubsection
    type            (hdf5Object       )                                            :: datasetObject
    type            (varying_string   )                                            :: datasetNameActual , message
    type            (c_ptr            )                                            :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 3D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,3)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_3D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_3D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double 3-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                               , intent(inout)           :: thisObject
    character       (len=*            )                               , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(3)    , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(3)                              :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                         referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                    :: referencedRegion
    integer                                                                                     :: errorCode
    integer         (kind=HID_T       )                                                         :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                         memorySpaceID     , storedDatasetID
    logical                                                                                     :: isReference       , readSubsection
    type            (hdf5Object       )                                                         :: datasetObject
    type            (varying_string   )                                                         :: datasetNameActual , message
    type            (c_ptr            )                                                         :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 3D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,3)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(3,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_3D_Array_Allocatable

  subroutine IO_HDF5_Write_Dataset_Double_4D(thisObject,datasetValue,datasetName,commentText,appendTo,appendDimension,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 4-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                    , intent(inout)           :: thisObject
    character       (len=*         )                    , intent(in   ), optional :: commentText                 , datasetName
    double precision                , dimension(:,:,:,:), intent(in   )           :: datasetValue
    logical                                             , intent(in   ), optional :: appendTo
    integer                                             , intent(in   ), optional :: appendDimension             , chunkSize                  , &
         &                                                                           compressionLevel
    type            (hdf5Object    )                    , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(4)                                :: datasetDimensions           , hyperslabCount             , &
         &                                                                           hyperslabStart              , newDatasetDimensions       , &
         &                                                                           newDatasetDimensionsFiltered, newDatasetDimensionsMaximum
    integer                                                                       :: appendDimensionActual       , datasetRank                , &
         &                                                                           errorCode
    integer         (kind=HID_T    )                                              :: dataspaceID                 , newDataspaceID
    logical                                                                       :: appendToActual              , preExisted
    type            (hdf5Object    )                                              :: datasetObject
    type            (varying_string)                                              :: datasetNameActual           , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 4D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,4)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 4D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,4)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the dimension for appending.
       appendDimensionActual=1
       if (present(appendDimension)) appendDimensionActual=appendDimension
       ! Ensure that all dimensions other than the one being appended to are of the same size.
       newDatasetDimensionsFiltered                       =newDatasetDimensions
       newDatasetDimensionsFiltered(appendDimensionActual)=dataSetDimensions   (appendDimensionActual)
       if (any(dataSetDimensions /= newDatasetDimensionsFiltered)) then
          message="when appending to dataset '"//trim(datasetNameActual)//"' all dimensions other than that being appended to must be same as original dataset"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Set the hyperslab.
       hyperslabStart                             =0
       hyperslabStart      (appendDimensionActual)=newDatasetDimensions(appendDimensionActual)
       hyperslabCount                             =dataSetDimensions
       newDatasetDimensions(appendDimensionActual)=newDatasetDimensions(appendDimensionActual)+datasetDimensions(appendDimensionActual)
    else
       newDatasetDimensions   =datasetDimensions
       hyperslabStart         =0
       hyperslabCount         =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=4
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_4D

  subroutine IO_HDF5_Read_Dataset_Double_4D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                    , intent(inout)           :: thisObject
    character       (len=*            )                    , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(4)      , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     ), dimension(4)                                :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                              referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save              , target                  :: referencedRegion
    integer                                                                          :: errorCode
    integer         (kind=HID_T       )                                              :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                              memorySpaceID     , storedDatasetID
    logical                                                                          :: isReference       , readSubsection
    type            (hdf5Object       )                                              :: datasetObject
    type            (varying_string   )                                              :: datasetNameActual , message
    type            (c_ptr            )                                              :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 4D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,4)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_4D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_4D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double 4-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                                 , intent(inout)           :: thisObject
    character       (len=*            )                                 , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(4)      , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(4)                                :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                           referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                      :: referencedRegion
    integer                                                                                       :: errorCode
    integer         (kind=HID_T       )                                                           :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                           memorySpaceID     , storedDatasetID
    logical                                                                                       :: isReference       , readSubsection
    type            (hdf5Object       )                                                           :: datasetObject
    type            (varying_string   )                                                           :: datasetNameActual , message
    type            (c_ptr            )                                                           :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 4D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,4)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(4,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_4D_Array_Allocatable

  subroutine IO_HDF5_Write_Dataset_Double_5D(thisObject,datasetValue,datasetName,commentText,appendTo,appendDimension,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 5-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                      , intent(inout)           :: thisObject
    character       (len=*         )                      , intent(in   ), optional :: commentText                 , datasetName
    double precision                , dimension(:,:,:,:,:), intent(in   )           :: datasetValue
    logical                                               , intent(in   ), optional :: appendTo
    integer                                               , intent(in   ), optional :: appendDimension             , chunkSize                  , &
         &                                                                             compressionLevel
    type            (hdf5Object    )                      , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(5)                                  :: datasetDimensions           , hyperslabCount             , &
         &                                                                             hyperslabStart              , newDatasetDimensions       , &
         &                                                                             newDatasetDimensionsFiltered, newDatasetDimensionsMaximum
    integer                                                                         :: appendDimensionActual       , datasetRank                , &
         &                                                                             errorCode
    integer         (kind=HID_T    )                                                :: dataspaceID                 , newDataspaceID
    logical                                                                         :: appendToActual              , preExisted
    type            (hdf5Object    )                                                :: datasetObject
    type            (varying_string)                                                :: datasetNameActual           , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 5D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,5)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 5D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,5)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the dimension for appending.
       appendDimensionActual=1
       if (present(appendDimension)) appendDimensionActual=appendDimension
       ! Ensure that all dimensions other than the one being appended to are of the same size.
       newDatasetDimensionsFiltered                       =newDatasetDimensions
       newDatasetDimensionsFiltered(appendDimensionActual)=dataSetDimensions   (appendDimensionActual)
       if (any(dataSetDimensions /= newDatasetDimensionsFiltered)) then
          message="when appending to dataset '"//trim(datasetNameActual)//"' all dimensions other than that being appended to must be same as original dataset"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Set the hyperslab.
       hyperslabStart                             =0
       hyperslabStart      (appendDimensionActual)=newDatasetDimensions(appendDimensionActual)
       hyperslabCount                             =dataSetDimensions
       newDatasetDimensions(appendDimensionActual)=newDatasetDimensions(appendDimensionActual)+datasetDimensions(appendDimensionActual)
    else
       newDatasetDimensions   =datasetDimensions
       hyperslabStart         =0
       hyperslabCount         =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=5
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_5D

  subroutine IO_HDF5_Read_Dataset_Double_5D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:,:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                      , intent(inout)           :: thisObject
    character       (len=*            )                      , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(5)        , intent(in   ), optional :: readBegin         , readCount                    !   &&
    integer         (kind=HSIZE_T     ), dimension(5)                                  :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save                , target                  :: referencedRegion
    integer                                                                            :: errorCode
    integer         (kind=HID_T       )                                                :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                memorySpaceID     , storedDatasetID
    logical                                                                            :: isReference       , readSubsection
    type            (hdf5Object       )                                                :: datasetObject
    type            (varying_string   )                                                :: datasetNameActual , message
    type            (c_ptr            )                                                :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 5D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,5)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_5D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_5D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double 5-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:,:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                                   , intent(inout)           :: thisObject
    character       (len=*            )                                   , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(5)        , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(5)                                  :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                             referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                        :: referencedRegion
    integer                                                                                         :: errorCode
    integer         (kind=HID_T       )                                                             :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                             memorySpaceID     , storedDatasetID
    logical                                                                                         :: isReference       , readSubsection
    type            (hdf5Object       )                                                             :: datasetObject
    type            (varying_string   )                                                             :: datasetNameActual , message
    type            (c_ptr            )                                                             :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 5D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,5)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(5,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_5D_Array_Allocatable

  subroutine IO_HDF5_Write_Dataset_Double_6D(thisObject,datasetValue,datasetName,commentText,appendTo,appendDimension,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a double 6-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class           (hdf5Object    )                        , intent(inout)           :: thisObject
    character       (len=*         )                        , intent(in   ), optional :: commentText                 , datasetName
    double precision                , dimension(:,:,:,:,:,:), intent(in   )           :: datasetValue
    logical                                                 , intent(in   ), optional :: appendTo
    integer                                                 , intent(in   ), optional :: appendDimension             , chunkSize                  , &
         &                                                                               compressionLevel
    type            (hdf5Object    )                        , intent(  out), optional :: datasetReturned
    integer         (kind=HSIZE_T  ), dimension(6)                                    :: datasetDimensions           , hyperslabCount             , &
         &                                                                               hyperslabStart              , newDatasetDimensions       , &
         &                                                                               newDatasetDimensionsFiltered, newDatasetDimensionsMaximum
    integer                                                                           :: appendDimensionActual       , datasetRank                , &
         &                                                                               errorCode
    integer         (kind=HID_T    )                                                  :: dataspaceID                 , newDataspaceID
    logical                                                                           :: appendToActual              , preExisted
    type            (hdf5Object    )                                                  :: datasetObject
    type            (varying_string)                                                  :: datasetNameActual           , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 6D double.
          call thisObject%assertDatasetType(H5T_NATIVE_DOUBLES,6)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeDouble,datasetDimensions,appendTo&
            &=appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 6D double.
       if (preExisted) call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,6)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Determine the dimension for appending.
       appendDimensionActual=1
       if (present(appendDimension)) appendDimensionActual=appendDimension
       ! Ensure that all dimensions other than the one being appended to are of the same size.
       newDatasetDimensionsFiltered                       =newDatasetDimensions
       newDatasetDimensionsFiltered(appendDimensionActual)=dataSetDimensions   (appendDimensionActual)
       if (any(dataSetDimensions /= newDatasetDimensionsFiltered)) then
          message="when appending to dataset '"//trim(datasetNameActual)//"' all dimensions other than that being appended to must be same as original dataset"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Set the hyperslab.
       hyperslabStart                             =0
       hyperslabStart      (appendDimensionActual)=newDatasetDimensions(appendDimensionActual)
       hyperslabCount                             =dataSetDimensions
       newDatasetDimensions(appendDimensionActual)=newDatasetDimensions(appendDimensionActual)+datasetDimensions(appendDimensionActual)
    else
       newDatasetDimensions   =datasetDimensions
       hyperslabStart         =0
       hyperslabCount         =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=6
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Double_6D

  subroutine IO_HDF5_Read_Dataset_Double_6D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    double precision                   , dimension(:,:,:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                        , intent(inout)           :: thisObject
    character       (len=*            )                        , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     ), dimension(6)          , intent(in   ), optional :: readBegin         , readCount                    !   &&
    integer         (kind=HSIZE_T     ), dimension(6)                                    :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                  referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save                  , target                  :: referencedRegion
    integer                                                                              :: errorCode
    integer         (kind=HID_T       )                                                  :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                  memorySpaceID     , storedDatasetID
    logical                                                                              :: isReference       , readSubsection
    type            (hdf5Object       )                                                  :: datasetObject
    type            (varying_string   )                                                  :: datasetNameActual , message
    type            (c_ptr            )                                                  :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select

       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 5D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,6)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_6D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Double_6D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a double 5-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    double precision                   , allocatable, dimension(:,:,:,:,:,:), intent(  out)           :: datasetValue
    class           (hdf5Object       )                                     , intent(inout)           :: thisObject
    character       (len=*            )                                     , intent(in   ), optional :: datasetName
    integer         (kind=HSIZE_T     )             , dimension(6)          , intent(in   ), optional :: readBegin         , readCount
    integer         (kind=HSIZE_T     )             , dimension(6)                                    :: datasetDimensions , datasetMaximumDimensions, &
         &                                                                                               referenceEnd      , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type            (hdset_reg_ref_t_f), save       , target                                          :: referencedRegion
    integer                                                                                           :: errorCode
    integer         (kind=HID_T       )                                                               :: datasetDataspaceID, dereferencedObjectID    , &
         &                                                                                               memorySpaceID     , storedDatasetID
    logical                                                                                           :: isReference       , readSubsection
    type            (hdf5Object       )                                                               :: datasetObject
    type            (varying_string   )                                                               :: datasetNameActual , message
    type            (c_ptr            )                                                               :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 6D double array.
    call datasetObject%assertDatasetType(H5T_NATIVE_DOUBLES,6)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,datasetDimensions,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(6,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,H5T_NATIVE_DOUBLE,datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
          ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Double_6D_Array_Allocatable
  
  subroutine IO_HDF5_Write_Dataset_Character_1D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a character 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: commentText                , datasetName
    character(len=*         ), dimension(:), intent(in   )           :: datasetValue
    logical                                , intent(in   ), optional :: appendTo
    integer                                , intent(in   ), optional :: chunkSize                  , compressionLevel
    type     (hdf5Object    )              , intent(  out), optional :: datasetReturned
    integer  (kind=HSIZE_T  ), dimension(1)                          :: datasetDimensions          , hyperslabCount      , &
         &                                                              hyperslabStart             , newDatasetDimensions, &
         &                                                              newDatasetDimensionsMaximum
    integer                                                          :: datasetRank                , errorCode
    integer  (kind=HID_T    )                                        :: dataTypeID                 , dataspaceID         , &
         &                                                              newDataspaceID
    logical                                                          :: appendToActual             , preExisted
    type     (hdf5Object    )                                        :: datasetObject
    type     (varying_string)                                        :: datasetNameActual          , message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to write dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine append status.
    if (present(appendTo)) then
       appendToActual=appendTo
    else
       appendToActual=.false.
    end if
    ! Determine dataset dimensions
    datasetDimensions=shape(datasetValue)
    ! Create a custom datatype.
    call h5tcopy_f(H5T_NATIVE_CHARACTER,dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to make custom datatype for attribute '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tset_size_f(dataTypeID,int(len(datasetValue),size_t),errorCode)
    if (errorCode < 0) then
       message="unable to set datatype size for attribute '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is a dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! If this dataset if not overwritable, report an error.
       if (.not.(thisObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetNameActual)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       else
          ! Check that the object is a 1D character.
          call thisObject%assertDatasetType([dataTypeID],1)
       end if
       select type (thisObject)
       type is (hdf5Object)
          datasetObject    =thisObject
       end select
       datasetNameActual=thisObject%objectName
       preExisted       =.true.
    else
       ! Check that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="no name was supplied for dataset in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Record if dataset already exists.
       preExisted=thisObject%hasDataset(datasetName)
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName,commentText,hdf5DataTypeCharacter,datasetDimensions,useDataType&
            &=dataTypeID,appendTo =appendTo,chunkSize=chunkSize,compressionLevel=compressionLevel)
       ! Check that pre-existing object is a 1D integer.
       if (preExisted) call datasetObject%assertDatasetType([dataTypeID],1)
       ! If this dataset if not overwritable, report an error.
       if (preExisted.and..not.(datasetObject%isOverwritable.or.appendToActual)) then
          message="dataset '"//trim(datasetName)//"' is not overwritable"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! If appending is requested, get the size of the existing dataset.
    if (appendToActual.and.preExisted) then
       ! Get size of existing dataset here.
       call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sget_simple_extent_dims_f(dataspaceID,newDatasetDimensions,newDatasetDimensionsMaximum,errorCode)
       if (errorCode < 0) then
          message="could not get dataspace extent for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       call h5sclose_f(dataspaceID,errorCode)
       if (errorCode < 0) then
          message="could not close dataspace for dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       hyperslabStart      =newDatasetDimensions
       hyperslabCount      =dataSetDimensions
       newDatasetDimensions=newDatasetDimensions+datasetDimensions
    else
       newDatasetDimensions=datasetDimensions
       hyperslabStart      =0
       hyperslabCount      =datasetDimensions
    end if

    ! Set extent of the dataset.
    if (datasetObject%chunkSize /= -1) then
       call h5dset_extent_f(datasetObject%objectID,newDatasetDimensions,errorCode)
       if (errorCode < 0) then
          message="could not set extent of dataset '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if
    ! Get the dataspace for the dataset.
    call h5dget_space_f(datasetObject%objectID,dataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not get dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Select hyperslab to write.
    call h5sselect_hyperslab_f(dataspaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode < 0) then
       message="could not select hyperslab for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Create a dataspace for the data to be written.
    datasetRank=1
    call h5screate_simple_f(datasetRank,datasetDimensions,newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="could not create dataspace for data to be written to dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the dataset.
    call h5dwrite_f(datasetObject%objectID,dataTypeID,datasetValue,datasetDimensions,errorCode,newDataspaceID,dataspaceID)
    if (errorCode /= 0) then
       message="unable to write dataset '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspaces.
    call h5sclose_f(dataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5sclose_f(newDataspaceID,errorCode)
    if (errorCode < 0) then
       message="unable to close new dataspace for dataset '"//trim(datasetNameActual)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//datasetNameActual//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Copy the dataset to return if necessary.
    if (present(datasetReturned)) then
       datasetReturned=datasetObject
    else
       ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()
    end if

    return
  end subroutine IO_HDF5_Write_Dataset_Character_1D

  subroutine IO_HDF5_Write_Dataset_VarString_1D(thisObject,datasetValue,datasetName,commentText,appendTo,chunkSize,compressionLevel,datasetReturned)
    !% Open and write a varying string 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use String_Handling
    implicit none
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: commentText    , datasetName
    type     (varying_string), dimension(:), intent(in   )           :: datasetValue
    logical                                , intent(in   ), optional :: appendTo
    integer                                , intent(in   ), optional :: chunkSize      , compressionLevel
    type     (hdf5Object    )              , intent(  out), optional :: datasetReturned

    ! Call the character version of this routine to perform the write.
    call IO_HDF5_Write_Dataset_Character_1D(thisObject,Convert_VarString_To_Char(datasetValue),datasetName,commentText,appendTo&
         &,chunkSize,compressionLevel,datasetReturned)

    return
  end subroutine IO_HDF5_Write_Dataset_VarString_1D

  subroutine IO_HDF5_Read_Dataset_Character_1D_Array_Static(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read a character scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    character(len=*            ), dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object       )              , intent(inout)           :: thisObject
    character(len=*            )              , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     ), dimension(1), intent(in   ), optional :: readBegin              , readCount
    integer  (kind=HSIZE_T     ), dimension(1)                          :: datasetDimensions      , datasetMaximumDimensions, &
         &                                                                 referenceEnd           , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save        , target                  :: referencedRegion
    integer                                                             :: errorCode
    integer  (kind=HID_T       )                                        :: dataTypeID          (2), datasetDataspaceID      , &
         &                                                                 dereferencedObjectID   , memorySpaceID           , &
         &                                                                 storedDatasetID
    logical                                                             :: isReference            , readSubsection
    type     (hdf5Object       )                                        :: datasetObject
    type     (varying_string   )                                        :: datasetNameActual      , message
    type     (c_ptr            )                                        :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Create a custom datatype.
    dataTypeID=IO_HDF5_Character_Types(len(datasetValue))

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
   else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D integer array.
    call datasetObject%assertDatasetType(dataTypeID,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Ensure that the size of the array is large enough to hold the datasets.
    if (any(shape(datasetValue) < datasetDimensions)) then
       message="array is not large enough to hold datasets from '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,dataTypeID(1),datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID(1),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tclose_f(dataTypeID(2),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
         ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if
    return
  end subroutine IO_HDF5_Read_Dataset_Character_1D_Array_Static

  subroutine IO_HDF5_Read_Dataset_Character_1D_Array_Allocatable(thisObject,datasetName,datasetValue,readBegin,readCount)
    !% Open and read an integer scalar dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    character(len=*            ), allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object       )                           , intent(inout)           :: thisObject
    character(len=*            )                           , intent(in   ), optional :: datasetName
    integer  (kind=HSIZE_T     )             , dimension(1), intent(in   ), optional :: readBegin              , readCount
    integer  (kind=HSIZE_T     )             , dimension(1)                          :: datasetDimensions      , datasetMaximumDimensions, &
         &                                                                              referenceEnd           , referenceStart
    ! <HDF5> Why is "referencedRegion" saved? Because if it isn't then it gets dynamically allocated on the stack, which results
    ! in an invalid pointer error. According to valgrind, this happens because the wrong deallocation function is used (delete
    ! instead of delete[] or vice-verse). Presumably this is an HDF5 library error. Saving the variable prevents it from being
    ! deallocated. This isn't an elegant solution, but it works.
    type     (hdset_reg_ref_t_f), save       , target                                :: referencedRegion
    integer                                                                          :: errorCode
    integer  (kind=HID_T       )                                                     :: dataTypeID          (2), datasetDataspaceID      , &
         &                                                                              dereferencedObjectID   , memorySpaceID           , &
         &                                                                              storedDatasetID
    logical                                                                          :: isReference            , readSubsection
    type     (hdf5Object       )                                                     :: datasetObject
    type     (varying_string   )                                                     :: datasetNameActual      , message
    type     (c_ptr            )                                                     :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(datasetNameActual)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Create a custom datatype.
    dataTypeID=IO_HDF5_Character_Types(len(datasetValue))

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetNameActual)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Check if the dataset is a reference.
    storedDatasetID=0
    if (datasetObject%isReference()) then
       ! Mark as a reference.
       isReference=.true.
       ! It is, so read the reference.
       dataBuffer=c_loc(referencedRegion)
       errorCode=h5dread(datasetObject%objectID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
       if (errorCode /= 0) then
          message="unable to read reference in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Now dereference the pointer.
       call h5rdereference_f(datasetObject%objectID,referencedRegion,dereferencedObjectID,errorCode)
       if (errorCode < 0) then
          message="unable to dereference pointer in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If the dataset object was opened internally, then close it.
       if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close pointer dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Store the ID of this dataset so that we can replace it later.
          storedDatasetID=datasetObject%objectID
       end if
       ! The dataset object ID is now replaced with the referenced region ID.
       datasetObject%objectID=dereferencedObjectID
       ! Get the dataspace for this referenced region.
       call h5rget_region_f(dereferencedObjectID,referencedRegion,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of referenced region in dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
   else
       ! Mark as not reference.
       isReference=.false.
       ! Not a reference, so simply get the dataspace.
       call h5dget_space_f(datasetObject%objectID,datasetDataspaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to get dataspace of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Check that the object is a 1D integer array.
    call datasetObject%assertDatasetType(dataTypeID,1)

    ! Get the dimensions of the array to be read.
    if (isReference) then
       ! This is a reference, so get the extent of the referenced region.
       call h5sget_select_bounds_f(datasetDataspaceID,referenceStart,referenceEnd,errorCode)
       if (errorCode < 0) then
          message="unable to get bounds of referenced region for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Compute the dimensions of the referenced region.
       datasetDimensions=referenceEnd-referenceStart+1
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,referenceStart-1+readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,int(shape(datasetValue),kind=HSIZE_T),memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,datasetDimensions,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       end if
    else
       ! Not a reference, so get the extent of the entire dataset.
       call h5sget_simple_extent_dims_f(datasetDataspaceID,datasetDimensions,datasetMaximumDimensions,errorCode)
       if (errorCode < 0) then
          message="unable to get dimensions of dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! If only a subsection is to be read, then select the appropriate hyperslab.
       if (readSubsection) then
          ! Check that subsection start values are legal.
          if (any(readBegin < 1 .or. readBegin > datasetDimensions)) then
             message="requested subsection begins outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Check that subsection extent is legal.
          if (any(readCount < 1 .or. readBegin+readCount-1 > datasetDimensions)) then
             message="requested subsection count is non-positive or outside of bounds of dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab.
          call h5sselect_hyperslab_f(datasetDataspaceID,H5S_SELECT_SET_F,readBegin-1,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select filespace hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Set the size of the data to read in.
          datasetDimensions=readCount
          ! Construct a suitable memory space ID to read this data into.
          call h5screate_simple_f(1,readCount,memorySpaceID,errorCode)
          if (errorCode < 0) then
             message="unable to get create memory dataspace for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Select hyperslab to read to.
          referenceStart=0
          call h5sselect_hyperslab_f(memorySpaceID,H5S_SELECT_SET_F,referenceStart,readCount,errorCode)
          if (errorCode < 0) then
             message="could not select memory space hyperslab for dataset '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
       else
          ! Set the default memory space ID.
          memorySpaceID=H5S_ALL_F
       end if
    end if

    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,int(datasetDimensions))
    ! Read the dataset.
    call h5dread_f(datasetObject%objectID,dataTypeID(1),datasetValue,int(shape(datasetValue),kind=hsize_t),errorCode&
         &,memorySpaceID,datasetDataspaceID)
    if (errorCode /= 0) then
       message="unable to read dataset '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataspace.
    call h5sclose_f(datasetDataspaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataspace of dataset '"//datasetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the memory dataspace if necessary.
    if (memorySpaceID /= H5S_ALL_F) then
       call h5sclose_f(memorySpaceID,errorCode)
       if (errorCode /= 0) then
          message="unable to close memory dataspace for dataset '"//datasetObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID(1),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tclose_f(dataTypeID(2),errorCode)
    if (errorCode < 0) then
       message="unable to close custom datatype for attribute '"//trim(datasetNameActual)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Determine how to close the object.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       ! Input was not a dataset object, so just close it.
       call datasetObject%close()
    else
       ! Input was a dataset object. Test if it was a reference.
       if (datasetObject%isReference()) then
         ! It was, so close the referenced dataset.
          call h5dclose_f(datasetObject%objectID,errorCode)
          if (errorCode < 0) then
             message="unable to close referenced dataset for '"//datasetObject%objectName//"'"
             call Galacticus_Error_Report(message//{introspection:location})
          end if
          ! Restore the object ID of the original dataset.
          thisObject%objectID=storedDatasetID
       end if
    end if

    return
  end subroutine IO_HDF5_Read_Dataset_Character_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable(thisObject,datasetName,datasetValue)
    !% Open and read an varying string 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    type     (varying_string), allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   ), optional :: datasetName
    integer  (kind=HID_T    )                                                     :: dataTypeID
    integer  (kind=SIZE_T   )                                                     :: dataTypeSize
    integer                                                                       :: errorCode
    type     (hdf5Object    )                                                     :: datasetObject
    type     (varying_string)                                                     :: datasetNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Get the datatype of this dataset.
    call h5dget_type_f(datasetObject%objectID,dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not get datatype for '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the size of the datatype.
    call h5tget_size_f(dataTypeID,dataTypeSize,errorCode)
    if (errorCode /= 0) then
       message="can not get size of datatype for '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not close datatype of '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Call wrapper routine that will do the remainder of the read.
    call IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable_Do_Read(thisObject,datasetName,datasetValue,dataTypeSize)

    ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()

    return
  end subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable_Do_Read(thisObject,datasetName,datasetValue,dataTypeSize)
    !% Open and read an varying string 1-D array dataset in {\normalfont \ttfamily thisObject} by creating a suitably-sized character variable into
    !% which it can be read.
    use Memory_Management
    implicit none
    type     (varying_string  ), allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object      )                           , intent(inout)           :: thisObject
    character(len=*           )                           , intent(in   ), optional :: datasetName
    integer  (kind=SIZE_T     )                           , intent(in   )           :: dataTypeSize
    character(len=dataTypeSize), allocatable, dimension(:)                          :: temporaryBuffer

    ! Call the character version of this routine to perform the red.
    call IO_HDF5_Read_Dataset_Character_1D_Array_Allocatable(thisObject,datasetName,temporaryBuffer)

    ! Transfer the results to the varying string variable.
    allocate(datasetValue(size(temporaryBuffer)))
    call Memory_Usage_Record(sizeof(datasetValue))
    datasetValue=temporaryBuffer
    call deallocateArray(temporaryBuffer)

    return
  end subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Allocatable_Do_Read

  subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Static(thisObject,datasetName,datasetValue)
    !% Open and read an varying string 1-D array dataset in {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    implicit none
    type     (varying_string), dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object    )              , intent(inout)           :: thisObject
    character(len=*         )              , intent(in   ), optional :: datasetName
    integer  (kind=HID_T    )                                        :: dataTypeID
    integer  (kind=SIZE_T   )                                        :: dataTypeSize
    integer                                                          :: errorCode
    type     (hdf5Object    )                                        :: datasetObject
    type     (varying_string)                                        :: datasetNameActual, message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Get the name of the dataset.
    if (present(datasetName)) then
       datasetNameActual=datasetName
    else
       datasetNameActual=thisObject%objectName
    end if

    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read dataset '"//trim(datasetNameActual)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the object is an dataset, or something else.
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeDataset) then
       ! Object is the dataset.
       select type (thisObject)
       type is (hdf5Object)
          datasetObject=thisObject
       end select
       ! No name should be supplied in this case.
       if (present(datasetName)) then
          message="dataset name was supplied for dataset object '"//trim(datasetName)//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       ! Require that an dataset name was supplied.
       if (.not.present(datasetName)) then
          message="dataset name was not supplied for object '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(datasetName)) then
          message="dataset '"//trim(datasetName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       ! Open the dataset.
       datasetObject=IO_HDF5_Open_Dataset(thisObject,datasetName)
    end if

    ! Get the datatype of this dataset.
    call h5dget_type_f(datasetObject%objectID,dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not get datatype for '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the size of the datatype.
    call h5tget_size_f(dataTypeID,dataTypeSize,errorCode)
    if (errorCode /= 0) then
       message="can not get size of datatype for '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the datatype.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="can not close datatype of '"//trim(datasetNameActual)//"' located in '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Call wrapper routine that will do the remainder of the read.
    call IO_HDF5_Read_Dataset_VarString_1D_Array_Static_Do_Read(thisObject,datasetName,datasetValue,dataTypeSize)

    ! Close the dataset unless this was an dataset object and it wasn't requested to be returned.
    if (thisObject%hdf5ObjectType /= hdf5ObjectTypeDataset) call datasetObject%close()

    return
  end subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Static

  subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Static_Do_Read(thisObject,datasetName,datasetValue,dataTypeSize)
    !% Open and read an varying string 1-D array dataset in {\normalfont \ttfamily thisObject} by creating a suitably-sized character variable into
    !% which it can be read.
    implicit none
    type     (varying_string  ), dimension(:)                 , intent(  out)           :: datasetValue
    class    (hdf5Object      )                               , intent(inout)           :: thisObject
    character(len=*           )                               , intent(in   ), optional :: datasetName
    integer  (kind=SIZE_T     )                               , intent(in   )           :: dataTypeSize
    character(len=dataTypeSize), dimension(size(datasetValue))                          :: temporaryBuffer

    ! Call the character version of this routine to perform the red.
    call IO_HDF5_Read_Dataset_Character_1D_Array_Static(thisObject,datasetName,temporaryBuffer)

    ! Transfer the results to the varying string variable.
    datasetValue=temporaryBuffer

    return
  end subroutine IO_HDF5_Read_Dataset_VarString_1D_Array_Static_Do_Read

  !! Table routines.

  subroutine IO_HDF5_Read_Table_Real_1D_Array_Allocatable(thisObject,tableName,columnName,datasetValue,readBegin,readCount)
    !% Open and read a real 1D array from a table {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    real                     , allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   )           :: tableName      , columnName
    integer  (kind=HSIZE_T  )                           , intent(in   ), optional :: readBegin      , readCount
    integer  (kind=HSIZE_T  )                                                     :: readBeginActual, readCountActual, &
         &                                                                           fieldCount     , recordCount
    integer  (kind=SIZE_T   )                                                     :: recordTypeSize
    integer                                                                       :: errorCode
    logical                                                                       :: readSubsection
    type     (varying_string)                                                     :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized
    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read table '"//trim(tableName)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if

    ! Check that the object is a group or a file
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeFile .or. thisObject%hdf5ObjectType == hdf5ObjectTypeGroup) then
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(tableName)) then
          message="table '"//trim(tableName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       message="attempt to read table from '"//thisObject%objectName//"' which is neither a file or a group"
       call Galacticus_Error_Report(message//{introspection:location}) 
    end if
    ! Get the table dimensions.
    call h5tbget_table_info_f(thisObject%objectID,tableName,fieldCount,recordCount,errorCode) 
    if (errorCode < 0) then
       message="unable to get dimensions of table '"//tableName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Determine records to read.
    if (readSubsection) then
       readBeginActual=readBegin
       readCountActual=readCount
    else
       readBeginActual=0
       readCountActual=recordCount
    end if
    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,[readCountActual])

    ! Read the column.
    call h5tget_size_f(H5T_NATIVE_REAL,recordTypeSize,errorCode)
    if (errorCode /= 0) then
       message="unable to get real datatype size"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tbread_field_name_f(thisObject%objectID,tableName,columnName,readBeginActual,readCountActual,recordTypeSize,datasetValue,errorCode) 
    if (errorCode /= 0) then
       message="unable to read table '"//trim(tableName)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end subroutine IO_HDF5_Read_Table_Real_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Table_Integer_1D_Array_Allocatable(thisObject,tableName,columnName,datasetValue,readBegin,readCount)
    !% Open and read an integer 1D array from a table {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    integer                  , allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object    )                           , intent(inout)           :: thisObject
    character(len=*         )                           , intent(in   )           :: tableName      , columnName
    integer  (kind=HSIZE_T  )                           , intent(in   ), optional :: readBegin      , readCount
    integer  (kind=HSIZE_T  )                                                     :: readBeginActual, readCountActual, &
         &                                                                           fieldCount     , recordCount
    integer  (kind=SIZE_T   )                                                     :: recordTypeSize
    integer                                                                       :: errorCode
    logical                                                                       :: readSubsection
    type     (varying_string)                                                     :: message

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized
    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read table '"//trim(tableName)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Check that the object is a group or a file
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeFile .or. thisObject%hdf5ObjectType == hdf5ObjectTypeGroup) then
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(tableName)) then
          message="table '"//trim(tableName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       message="attempt to read table from '"//thisObject%objectName//"' which is neither a file or a group"
       call Galacticus_Error_Report(message//{introspection:location}) 
    end if
    ! Get the table dimensions.
    call h5tbget_table_info_f(thisObject%objectID,tableName,fieldCount,recordCount,errorCode) 
    if (errorCode < 0) then
       message="unable to get dimensions of table '"//tableName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Determine records to read.
    if (readSubsection) then
       readBeginActual=readBegin
       readCountActual=readCount
    else
       readBeginActual=0
       readCountActual=recordCount
    end if
    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,[readCountActual])
    ! Read the column.
    call h5tget_size_f(H5T_NATIVE_REAL,recordTypeSize,errorCode)
    if (errorCode /= 0) then
       message="unable to get real datatype size"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    call h5tbread_field_name_f(thisObject%objectID,tableName,columnName,readBeginActual,readCountActual,recordTypeSize,datasetValue,errorCode) 
    if (errorCode /= 0) then
       message="unable to read table '"//trim(tableName)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end subroutine IO_HDF5_Read_Table_Integer_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Table_Integer8_1D_Array_Allocatable(thisObject,tableName,columnName,datasetValue,readBegin,readCount)
    !% Open and read a real scalar from a table {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    use Kind_Numbers
    implicit none
    integer  (kind=kind_int8     ), allocatable, dimension(:), intent(  out), target   :: datasetValue
    class    (hdf5Object         )                           , intent(inout)           :: thisObject
    character(len=*              )                           , intent(in   )           :: tableName      , columnName
    integer  (kind=HSIZE_T  )                                , intent(in   ), optional :: readBegin      , readCount
    integer  (kind=HSIZE_T       )                                                     :: fieldCount     , recordCount    , &
         &                                                                                readBeginActual, readCountActual
    integer  (kind=SIZE_T        )                                                     :: recordTypeSize
    integer                                                                            :: errorCode
    type     (varying_string     )                                                     :: message
    type     (c_ptr              )                                                     :: dataValueC
    logical                                                                            :: readSubsection

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized
    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read table '"//trim(tableName)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Check that the object is a group or a file
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeFile .or. thisObject%hdf5ObjectType == hdf5ObjectTypeGroup) then
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(tableName)) then
          message="table '"//trim(tableName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       message="attempt to read table from '"//thisObject%objectName//"' which is neither a file or a group"
       call Galacticus_Error_Report(message//{introspection:location}) 
    end if
    ! Get the table dimensions.
    call h5tbget_table_info_f(thisObject%objectID,tableName,fieldCount,recordCount,errorCode) 
    if (errorCode < 0) then
       message="unable to get dimensions of table '"//tableName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Determine records to read.
    if (readSubsection) then
       readBeginActual=readBegin
       readCountActual=readCount
    else
       readBeginActual=0
       readCountActual=recordCount
    end if
    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,[readCountActual])
    ! Read the column.
    call h5tget_size_f(H5T_NATIVE_INTEGER_8,recordTypeSize,errorCode)
    if (errorCode /= 0) then
       message="unable to get long integer datatype size"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    dataValueC=c_loc(datasetValue)
    errorCode=H5TBread_fields_name(thisObject%objectID,trim(tableName)//C_NULL_CHAR,trim(columnName)//C_NULL_CHAR,readBeginActual,readCountActual,recordTypeSize,[0_size_t],[8_size_t],dataValueC)
    if (errorCode /= 0) then
       message="unable to read table '"//trim(tableName)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end subroutine IO_HDF5_Read_Table_Integer8_1D_Array_Allocatable

  subroutine IO_HDF5_Read_Table_Character_1D_Array_Allocatable(thisObject,tableName,columnName,datasetValue,readBegin,readCount)
    !% Open and read a real 1D array from a table {\normalfont \ttfamily thisObject}.
    use Galacticus_Error
    use Memory_Management
    implicit none
    character(len=*                ), allocatable, dimension(:), intent(  out)           :: datasetValue
    class    (hdf5Object           )                           , intent(inout)           :: thisObject
    character(len=*                )                           , intent(in   )           :: tableName      , columnName
    integer  (kind=HSIZE_T         )                           , intent(in   ), optional :: readBegin      , readCount
    integer  (kind=HSIZE_T         )                                                     :: readBeginActual, readCountActual, &
         &                                                                                  fieldCount     , recordCount
    integer  (kind=SIZE_T          )                                                     :: recordTypeSize
    integer                                                                              :: errorCode     , i
    logical                                                                              :: readSubsection
    type     (varying_string       )                                                     :: message
    character(len=len(datasetValue))                                                     :: convertValue

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized
    ! Check that the object is already open.
    if (.not.thisObject%isOpenValue) then
       message="attempt to read table '"//trim(tableName)//"' in unopen object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! If a subsection is to be read, we need both start and count values.
    if (present(readBegin)) then
       if (.not.present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.true.
    else
       if (present(readCount)) then
          message="reading a subsection of dataset '"//trim(tableName)//"' requires both readBegin and readCount to be specified"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
       readSubsection=.false.
    end if
    ! Check that the object is a group or a file
    if (thisObject%hdf5ObjectType == hdf5ObjectTypeFile .or. thisObject%hdf5ObjectType == hdf5ObjectTypeGroup) then
       ! Check that the dataset exists.
       if (.not.thisObject%hasDataset(tableName)) then
          message="table '"//trim(tableName)//"' does not exist in '"//thisObject%objectName//"'"
          call Galacticus_Error_Report(message//{introspection:location})
       end if
    else
       message="attempt to read table from '"//thisObject%objectName//"' which is neither a file or a group"
       call Galacticus_Error_Report(message//{introspection:location}) 
    end if
    ! Get the table dimensions.
    call h5tbget_table_info_f(thisObject%objectID,tableName,fieldCount,recordCount,errorCode) 
    if (errorCode < 0) then
       message="unable to get dimensions of table '"//tableName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Determine records to read.
    if (readSubsection) then
       readBeginActual=readBegin
       readCountActual=readCount
    else
       readBeginActual=0
       readCountActual=recordCount
    end if
    ! Allocate the array to the appropriate size.
    if (allocated(datasetValue)) call deallocateArray(datasetValue)
    call allocateArray(datasetValue,[readCountActual])
    ! Read the column.
    recordTypeSize=len(datasetValue(1))
    call h5tbread_field_name_f(thisObject%objectID,tableName,columnName,readBeginActual,readCountActual,recordTypeSize,datasetValue,errorCode) 
    if (errorCode /= 0) then
       message="unable to read table '"//trim(tableName)//"' in object '"//thisObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    ! Convert to Fortran form.
    do i=1,size(datasetValue)
       convertValue=datasetValue(i)
       if (index(convertValue,char(0)) /= 0) then
          convertValue(index(convertValue,char(0)):len(convertValue))=repeat(" ",len(convertValue)-index(convertValue,char(0))+1)
          datasetValue(i)=convertValue
       end if
    end do
    return
  end subroutine IO_HDF5_Read_Table_Character_1D_Array_Allocatable
  
  !! Reference routines.

  subroutine IO_HDF5_Create_Reference_Scalar_To_1D(fromGroup,toDataset,referenceName,referenceStart,referenceCount)
    !% Create a scalar reference to the 1-D {\normalfont \ttfamily toDataset} in the HDF5 group {\normalfont \ttfamily fromGroup}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object       )              , intent(inout)         :: fromGroup
    type     (hdf5Object       )              , intent(inout)         :: toDataset
    character(len=*            )              , intent(in   )         :: referenceName
    integer  (kind=HSIZE_T     ), dimension(1), intent(in   )         :: referenceCount   , referenceStart
    integer  (kind=HSIZE_T     ), dimension(1)                        :: datasetDimensions, hyperslabCount, hyperslabStart
    type     (hdset_reg_ref_t_f)                             , target :: dataReference
    integer                                                           :: errorCode        , datasetRank
    integer  (kind=HID_T       )                                      :: dataSetID        , dataSpaceID   , dataSubsetSpaceID
    type     (varying_string   )                                      :: message
    type     (c_ptr            )                                      :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the group is already open.
    if (.not.fromGroup%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' in unopen group '"//fromGroup%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset is already open.
    if (.not.toDataset%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' to unopen dataset '"//toDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the group really is a group.
    if (fromGroup%hdf5ObjectType /= hdf5ObjectTypeGroup) then
       message="attempt to write reference '"//trim(referenceName)//"' into object '"//fromGroup%objectName//"' which is not a group"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the dataset really is a dataset.
    if (toDataset%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="attempt to write reference '"//trim(referenceName)//"' to object '"//toDataset%objectName//"' which is not a dataset"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dataspace of the dataset.
    call h5dget_space_f(toDataset%objectID,dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace for dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Select a hyperslab from this dataspace. Subtract one from the start position since HDF5 uses indexing beginning at 0.
    hyperslabStart=referenceStart-1
    hyperslabCount=referenceCount
    call h5sselect_hyperslab_f(dataSubsetSpaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode /= 0) then
       message="unable to get select hyperslab in dataspace of dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a dataspace for the reference dataset.
    datasetRank      =0
    datasetDimensions=1
    call h5screate_simple_f(datasetRank,datasetDimensions,dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference dataset.
    call h5dcreate_f(fromGroup%objectID,trim(referenceName),H5T_STD_REF_DSETREG,dataSpaceID,dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference.
    call h5rcreate_f(toDataset%parentObject%objectID,char(toDataset%objectName),dataSubsetSpaceID,dataReference,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the reference dataset.
    dataBuffer=c_loc(dataReference)
    errorCode=h5dwrite(dataSetID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset dataspace.
    call h5sclose_f(dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataset dataspace for '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the reference dataset dataspace.
    call h5sclose_f(dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset.
    call h5dclose_f(dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Create_Reference_Scalar_To_1D

  subroutine IO_HDF5_Create_Reference_Scalar_To_2D(fromGroup,toDataset,referenceName,referenceStart,referenceCount)
    !% Create a scalar reference to the 2-D {\normalfont \ttfamily toDataset} in the HDF5 group {\normalfont \ttfamily fromGroup}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object       )              , intent(inout)         :: fromGroup
    type     (hdf5Object       )              , intent(inout)         :: toDataset
    character(len=*            )              , intent(in   )         :: referenceName
    integer  (kind=HSIZE_T     ), dimension(2), intent(in   )         :: referenceCount   , referenceStart
    integer  (kind=HSIZE_T     ), dimension(2)                        :: datasetDimensions, hyperslabCount, hyperslabStart
    type     (hdset_reg_ref_t_f)                             , target :: dataReference
    integer                                                           :: errorCode        , datasetRank
    integer  (kind=HID_T       )                                      :: dataSetID        , dataSpaceID   , dataSubsetSpaceID
    type     (varying_string   )                                      :: message
    type     (c_ptr            )                                      :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the group is already open.
    if (.not.fromGroup%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' in unopen group '"//fromGroup%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset is already open.
    if (.not.toDataset%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' to unopen dataset '"//toDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the group really is a group.
    if (fromGroup%hdf5ObjectType /= hdf5ObjectTypeGroup) then
       message="attempt to write reference '"//trim(referenceName)//"' into object '"//fromGroup%objectName//"' which is not a group"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the dataset really is a dataset.
    if (toDataset%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="attempt to write reference '"//trim(referenceName)//"' to object '"//toDataset%objectName//"' which is not a dataset"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dataspace of the dataset.
    call h5dget_space_f(toDataset%objectID,dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace for dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Select a hyperslab from this dataspace. Subtract one from the start position since HDF5 uses indexing beginning at 0.
    hyperslabStart=referenceStart-1
    hyperslabCount=referenceCount
    call h5sselect_hyperslab_f(dataSubsetSpaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode /= 0) then
       message="unable to get select hyperslab in dataspace of dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a dataspace for the reference dataset.
    datasetRank      =0
    datasetDimensions=1
    call h5screate_simple_f(datasetRank,datasetDimensions,dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference dataset.
    call h5dcreate_f(fromGroup%objectID,trim(referenceName),H5T_STD_REF_DSETREG,dataSpaceID,dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference.
    call h5rcreate_f(toDataset%parentObject%objectID,char(toDataset%objectName),dataSubsetSpaceID,dataReference,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the reference dataset.
    dataBuffer=c_loc(dataReference)
    errorCode=h5dwrite(dataSetID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset dataspace.
    call h5sclose_f(dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataset dataspace for '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the reference dataset dataspace.
    call h5sclose_f(dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset.
    call h5dclose_f(dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Create_Reference_Scalar_To_2D

  subroutine IO_HDF5_Create_Reference_Scalar_To_3D(fromGroup,toDataset,referenceName,referenceStart,referenceCount)
    !% Create a scalar reference to the 3-D {\normalfont \ttfamily toDataset} in the HDF5 group {\normalfont \ttfamily fromGroup}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object       )              , intent(inout)         :: fromGroup
    type     (hdf5Object       )              , intent(inout)         :: toDataset
    character(len=*            )              , intent(in   )         :: referenceName
    integer  (kind=HSIZE_T     ), dimension(3), intent(in   )         :: referenceCount   , referenceStart
    integer  (kind=HSIZE_T     ), dimension(3)                        :: datasetDimensions, hyperslabCount, hyperslabStart
    type     (hdset_reg_ref_t_f)                             , target :: dataReference
    integer                                                           :: errorCode        , datasetRank
    integer  (kind=HID_T       )                                      :: dataSetID        , dataSpaceID   , dataSubsetSpaceID
    type     (varying_string   )                                      :: message
    type     (c_ptr            )                                      :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the group is already open.
    if (.not.fromGroup%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' in unopen group '"//fromGroup%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset is already open.
    if (.not.toDataset%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' to unopen dataset '"//toDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the group really is a group.
    if (fromGroup%hdf5ObjectType /= hdf5ObjectTypeGroup) then
       message="attempt to write reference '"//trim(referenceName)//"' into object '"//fromGroup%objectName//"' which is not a group"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the dataset really is a dataset.
    if (toDataset%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="attempt to write reference '"//trim(referenceName)//"' to object '"//toDataset%objectName//"' which is not a dataset"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dataspace of the dataset.
    call h5dget_space_f(toDataset%objectID,dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace for dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Select a hyperslab from this dataspace. Subtract one from the start position since HDF5 uses indexing beginning at 0.
    hyperslabStart=referenceStart-1
    hyperslabCount=referenceCount
    call h5sselect_hyperslab_f(dataSubsetSpaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode /= 0) then
       message="unable to get select hyperslab in dataspace of dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a dataspace for the reference dataset.
    datasetRank      =0
    datasetDimensions=1
    call h5screate_simple_f(datasetRank,datasetDimensions,dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference dataset.
    call h5dcreate_f(fromGroup%objectID,trim(referenceName),H5T_STD_REF_DSETREG,dataSpaceID,dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference.
    call h5rcreate_f(toDataset%parentObject%objectID,char(toDataset%objectName),dataSubsetSpaceID,dataReference,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the reference dataset.
    dataBuffer=c_loc(dataReference)
    errorCode=h5dwrite(dataSetID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset dataspace.
    call h5sclose_f(dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataset dataspace for '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the reference dataset dataspace.
    call h5sclose_f(dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset.
    call h5dclose_f(dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Create_Reference_Scalar_To_3D

  subroutine IO_HDF5_Create_Reference_Scalar_To_4D(fromGroup,toDataset,referenceName,referenceStart,referenceCount)
    !% Create a scalar reference to the 4-D {\normalfont \ttfamily toDataset} in the HDF5 group {\normalfont \ttfamily fromGroup}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object       )              , intent(inout)         :: fromGroup
    type     (hdf5Object       )              , intent(inout)         :: toDataset
    character(len=*            )              , intent(in   )         :: referenceName
    integer  (kind=HSIZE_T     ), dimension(4), intent(in   )         :: referenceCount   , referenceStart
    integer  (kind=HSIZE_T     ), dimension(4)                        :: datasetDimensions, hyperslabCount, hyperslabStart
    type     (hdset_reg_ref_t_f)                             , target :: dataReference
    integer                                                           :: errorCode        , datasetRank
    integer  (kind=HID_T       )                                      :: dataSetID        , dataSpaceID   , dataSubsetSpaceID
    type     (varying_string   )                                      :: message
    type     (c_ptr            )                                      :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the group is already open.
    if (.not.fromGroup%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' in unopen group '"//fromGroup%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset is already open.
    if (.not.toDataset%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' to unopen dataset '"//toDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the group really is a group.
    if (fromGroup%hdf5ObjectType /= hdf5ObjectTypeGroup) then
       message="attempt to write reference '"//trim(referenceName)//"' into object '"//fromGroup%objectName//"' which is not a group"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the dataset really is a dataset.
    if (toDataset%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="attempt to write reference '"//trim(referenceName)//"' to object '"//toDataset%objectName//"' which is not a dataset"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dataspace of the dataset.
    call h5dget_space_f(toDataset%objectID,dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace for dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Select a hyperslab from this dataspace. Subtract one from the start position since HDF5 uses indexing beginning at 0.
    hyperslabStart=referenceStart-1
    hyperslabCount=referenceCount
    call h5sselect_hyperslab_f(dataSubsetSpaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode /= 0) then
       message="unable to get select hyperslab in dataspace of dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a dataspace for the reference dataset.
    datasetRank      =0
    datasetDimensions=1
    call h5screate_simple_f(datasetRank,datasetDimensions,dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference dataset.
    call h5dcreate_f(fromGroup%objectID,trim(referenceName),H5T_STD_REF_DSETREG,dataSpaceID,dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference.
    call h5rcreate_f(toDataset%parentObject%objectID,char(toDataset%objectName),dataSubsetSpaceID,dataReference,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the reference dataset.
    dataBuffer=c_loc(dataReference)
    errorCode=h5dwrite(dataSetID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset dataspace.
    call h5sclose_f(dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataset dataspace for '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the reference dataset dataspace.
    call h5sclose_f(dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset.
    call h5dclose_f(dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Create_Reference_Scalar_To_4D

  subroutine IO_HDF5_Create_Reference_Scalar_To_5D(fromGroup,toDataset,referenceName,referenceStart,referenceCount)
    !% Create a scalar reference to the 5-D {\normalfont \ttfamily toDataset} in the HDF5 group {\normalfont \ttfamily fromGroup}.
    use Galacticus_Error
    implicit none
    class    (hdf5Object       )              , intent(inout)         :: fromGroup
    type     (hdf5Object       )              , intent(inout)         :: toDataset
    character(len=*            )              , intent(in   )         :: referenceName
    integer  (kind=HSIZE_T     ), dimension(5), intent(in   )         :: referenceCount   , referenceStart
    integer  (kind=HSIZE_T     ), dimension(5)                        :: datasetDimensions, hyperslabCount, hyperslabStart
    type     (hdset_reg_ref_t_f)                             , target :: dataReference
    integer                                                           :: errorCode        , datasetRank
    integer  (kind=HID_T       )                                      :: dataSetID        , dataSpaceID   , dataSubsetSpaceID
    type     (varying_string   )                                      :: message
    type     (c_ptr            )                                      :: dataBuffer

    ! Check that this module is initialized.
    call IO_HDF_Assert_Is_Initialized

    ! Check that the group is already open.
    if (.not.fromGroup%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' in unopen group '"//fromGroup%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check that the dataset is already open.
    if (.not.toDataset%isOpenValue) then
       message="attempt to write reference '"//trim(referenceName)//"' to unopen dataset '"//toDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the group really is a group.
    if (fromGroup%hdf5ObjectType /= hdf5ObjectTypeGroup) then
       message="attempt to write reference '"//trim(referenceName)//"' into object '"//fromGroup%objectName//"' which is not a group"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Check if the dataset really is a dataset.
    if (toDataset%hdf5ObjectType /= hdf5ObjectTypeDataset) then
       message="attempt to write reference '"//trim(referenceName)//"' to object '"//toDataset%objectName//"' which is not a dataset"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the dataspace of the dataset.
    call h5dget_space_f(toDataset%objectID,dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to get dataspace for dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Select a hyperslab from this dataspace. Subtract one from the start position since HDF5 uses indexing beginning at 0.
    hyperslabStart=referenceStart-1
    hyperslabCount=referenceCount
    call h5sselect_hyperslab_f(dataSubsetSpaceID,H5S_SELECT_SET_F,hyperslabStart,hyperslabCount,errorCode)
    if (errorCode /= 0) then
       message="unable to get select hyperslab in dataspace of dataset '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create a dataspace for the reference dataset.
    datasetRank      =0
    datasetDimensions=1
    call h5screate_simple_f(datasetRank,datasetDimensions,dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference dataset.
    call h5dcreate_f(fromGroup%objectID,trim(referenceName),H5T_STD_REF_DSETREG,dataSpaceID,dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Create the reference.
    call h5rcreate_f(toDataset%parentObject%objectID,char(toDataset%objectName),dataSubsetSpaceID,dataReference,errorCode)
    if (errorCode /= 0) then
       message="unable to create reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Write the reference dataset.
    dataBuffer=c_loc(dataReference)
    errorCode=h5dwrite(dataSetID,H5T_STD_REF_DSETREG,H5S_ALL_F,H5S_ALL_F,H5P_DEFAULT_F,dataBuffer)
    if (errorCode /= 0) then
       message="unable to write reference '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset dataspace.
    call h5sclose_f(dataSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to close dataset dataspace for '"//trim(toDataset%objectName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the reference dataset dataspace.
    call h5sclose_f(dataSubsetSpaceID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataspace for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the dataset.
    call h5dclose_f(dataSetID,errorCode)
    if (errorCode /= 0) then
       message="unable to reference dataset for '"//trim(referenceName)//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end subroutine IO_HDF5_Create_Reference_Scalar_To_5D

  logical function IO_HDF5_Is_Reference(thisDataset)
    !% Return true if the input dataset is a scalar reference.
    use Galacticus_Error
    implicit none
    class  (hdf5Object    ), intent(in   ) :: thisDataset
    integer                                :: errorCode
    integer(kind=HID_T    )                :: dataTypeID
    type   (varying_string)                :: message

    ! Ensure that the dataset is open.
    if (.not.thisDataset%isOpenValue) then
       message="attempt to check if reference on unopen dataset '"//thisDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Get the type of the object
    call h5dget_type_f(thisDataset%objectID,dataTypeID,errorCode)
    if (errorCode < 0) then
       message="unable to get data type for dataset '"//thisDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Test the type.
    call h5tequal_f(dataTypeID,H5T_STD_REF_DSETREG,IO_HDF5_Is_Reference,errorCode)
    if (errorCode < 0) then
       message="unable to test data type for dataset '"//thisDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    ! Close the data type.
    call h5tclose_f(dataTypeID,errorCode)
    if (errorCode /= 0) then
       message="unable to close datatype of dataset '"//thisDataset%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if

    return
  end function IO_HDF5_Is_Reference
  
  subroutine IO_HDF5_Copy(self,source,targetObject)
    !% Copy the named object to the target object.
    use Galacticus_Error
    implicit none
    class    (hdf5Object    ), intent(in   ) :: self
    character(len=*         ), intent(in   ) :: source
    type     (hdf5Object    ), intent(inout) :: targetObject
    integer                                  :: errorCode
    type     (varying_string)                :: message

    call h5ocopy_f(self%objectID,source,targetObject%objectID,source,errorCode)
    if (errorCode < 0) then
       message="unable to copy object '"//source//"' from '"//self%objectName//"' to '"//targetObject%objectName//"'"
       call Galacticus_Error_Report(message//{introspection:location})
    end if
    return
  end subroutine IO_HDF5_Copy
  
end module IO_HDF5
